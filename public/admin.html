<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Админ-панель - Chiwawa Server</title>
    <meta name="description" content="Панель администратора для управления сервером Chiwawa">
    <meta name="author" content="ebluffy">
    
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://cdn.quilljs.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdn.quilljs.com; img-src 'self' data: https:; font-src 'self' https://cdnjs.cloudflare.com; connect-src 'self';">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJhIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj48c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIjZmJiZjI0Ii8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjZjU5ZTBiIi8+PC9saW5lYXJHcmFkaWVudD48L2RlZnM+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiByeD0iMTIiIGZpbGw9InVybCgjYSkiLz48dGV4dCB4PSIzMiIgeT0iNDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIzMiIgZmlsbD0iIzFmMjkzNyIgdGV4dC1hbmNob3I9Im1pZGRsZSI+8J+QlTwvdGV4dD48L3N2Zz4=">
    
    <!-- Создатель: ebluffy -->
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Quill.js для визуального редактора -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    
    <!-- Кастомные стили для темной темы Quill -->
    <style>
        /* Темная тема для Quill редактора */
        .ql-toolbar.ql-snow {
            background: #2a2a2a !important;
            border: 1px solid #444 !important;
            border-radius: 6px 6px 0 0 !important;
            border-bottom: 1px solid #444 !important;
        }
        
        .ql-toolbar.ql-snow .ql-formats {
            margin-right: 15px;
        }
        
        .ql-toolbar.ql-snow button,
        .ql-toolbar.ql-snow .ql-picker-label {
            color: #e5e5e5 !important;
            background: transparent !important;
            border: none !important;
            padding: 6px !important;
            margin: 2px !important;
            border-radius: 4px !important;
        }
        
        .ql-toolbar.ql-snow button:hover,
        .ql-toolbar.ql-snow .ql-picker-label:hover {
            background: #444 !important;
        }
        
        .ql-toolbar.ql-snow button.ql-active,
        .ql-toolbar.ql-snow .ql-picker-label.ql-active {
            background: #FFAA00 !important;
            color: #000 !important;
        }
        
        .ql-toolbar.ql-snow .ql-picker {
            color: #e5e5e5 !important;
        }
        
        .ql-toolbar.ql-snow .ql-picker-options {
            background: #2a2a2a !important;
            border: 1px solid #444 !important;
        }
        
        .ql-toolbar.ql-snow .ql-picker-item {
            color: #e5e5e5 !important;
        }
        
        .ql-toolbar.ql-snow .ql-picker-item:hover {
            background: #444 !important;
        }
        
        .ql-container.ql-snow {
            background: #1a1a1a !important;
            border: 1px solid #444 !important;
            border-top: none !important;
            border-radius: 0 0 6px 6px !important;
        }
        
        .ql-editor {
            background: #1a1a1a !important;
            color: #e5e5e5 !important;
            border: none !important;
            min-height: 300px !important;
        }
        
        .ql-editor.ql-blank::before {
            color: #888 !important;
        }
        
        /* Исправляем отображение иконок */
        .ql-toolbar.ql-snow button svg {
            fill: #e5e5e5 !important;
        }
        
        .ql-toolbar.ql-snow button:hover svg {
            fill: #fff !important;
        }
        
        .ql-toolbar.ql-snow button.ql-active svg {
            fill: #000 !important;
        }
        
        /* Исправляем выпадающие списки */
        .ql-toolbar.ql-snow .ql-picker-options {
            z-index: 1000 !important;
        }
    </style>
    
    <!-- Font Awesome для иконок -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'minecraft-dark': '#0a0a0a',
                        'minecraft-darker': '#050505',
                        'minecraft-gold': '#FFAA00',
                        'minecraft-yellow': '#FFFF55',
                        'minecraft-gray': '#2a2a2a',
                        'minecraft-light-gray': '#404040',
                        'minecraft-lighter-gray': '#555555'
                    },
                    fontFamily: {
                        'minecraft': ['Courier New', 'monospace']
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate'
                    },
                    keyframes: {
                        glow: {
                            '0%': { boxShadow: '0 0 5px #FFAA00' },
                            '100%': { boxShadow: '0 0 20px #FFAA00, 0 0 30px #FFAA00' }
                        }
                    },
                    backdropBlur: {
                        'xs': '2px',
                    }
                }
            }
        }
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Кастомные стили для Quill редактора -->
    <style>
        /* Quill темная тема */
        .ql-snow {
            border: 1px solid #444 !important;
        }
        
        .ql-snow .ql-toolbar {
            background: #2a2a2a !important;
            border: 1px solid #444 !important;
            border-bottom: none !important;
        }
        
        .ql-snow .ql-container {
            background: #1a1a1a !important;
            color: #e5e5e5 !important;
            border: 1px solid #444 !important;
            border-top: none !important;
        }
        
        .ql-snow .ql-editor {
            background: #1a1a1a !important;
            color: #e5e5e5 !important;
            font-size: 14px;
            line-height: 1.6;
        }
        
        /* Белые символы пунктуации и форматирования */
        .ql-snow .ql-editor p,
        .ql-snow .ql-editor div,
        .ql-snow .ql-editor span,
        .ql-snow .ql-editor h1,
        .ql-snow .ql-editor h2,
        .ql-snow .ql-editor h3,
        .ql-snow .ql-editor h4,
        .ql-snow .ql-editor h5,
        .ql-snow .ql-editor h6,
        .ql-snow .ql-editor ul,
        .ql-snow .ql-editor ol,
        .ql-snow .ql-editor li,
        .ql-snow .ql-editor blockquote {
            color: #e5e5e5 !important;
        }
        
        /* Специальные символы и пунктуация */
        .ql-snow .ql-editor::before,
        .ql-snow .ql-editor::after {
            color: #e5e5e5 !important;
        }
        
        /* Кнопки тулбара */
        .ql-snow .ql-toolbar button {
            color: #e5e5e5 !important;
            border: 1px solid transparent;
            border-radius: 3px;
            transition: all 0.2s ease;
        }
        
        .ql-snow .ql-toolbar button:hover {
            background: #444 !important;
            border-color: #f8b500 !important;
        }
        
        .ql-snow .ql-toolbar button.ql-active {
            background: #f8b500 !important;
            color: #000 !important;
        }
        
        /* Dropdown меню */
        .ql-snow .ql-picker {
            color: #e5e5e5 !important;
        }
        
        .ql-snow .ql-picker-options {
            background: #2a2a2a !important;
            border: 1px solid #444 !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5) !important;
        }
        
        .ql-snow .ql-picker-item {
            color: #e5e5e5 !important;
            transition: all 0.2s ease;
        }
        
        .ql-snow .ql-picker-item:hover {
            background: #444 !important;
        }
        
        .ql-snow .ql-picker-item.ql-selected {
            background: #f8b500 !important;
            color: #000 !important;
        }
        
        /* Tooltip */
        .ql-snow .ql-tooltip {
            background: #2a2a2a !important;
            border: 1px solid #444 !important;
            color: #e5e5e5 !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5) !important;
        }
        
        .ql-snow .ql-tooltip input {
            background: #1a1a1a !important;
            color: #e5e5e5 !important;
            border: 1px solid #444 !important;
        }
        
        .ql-snow .ql-tooltip a {
            color: #f8b500 !important;
        }
        
        /* Фокус */
        .ql-snow .ql-editor.ql-blank::before {
            color: #888 !important;
            font-style: italic;
        }
        
        .ql-snow .ql-editor:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(248, 181, 0, 0.3) !important;
        }
    </style>
    
    <style>
        * {
            scrollbar-width: thin;
            scrollbar-color: #FFAA00 #1a1a1a;
        }
        
        *::-webkit-scrollbar {
            width: 8px;
        }
        
        *::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        *::-webkit-scrollbar-thumb {
            background: #FFAA00;
            border-radius: 4px;
        }
        
        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .minecraft-bg {
            background-image: 
                radial-gradient(circle at 25% 25%, #2a2a2a 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, #404040 0%, transparent 50%),
                linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
        }
        
        .glass-effect {
            background: rgba(42, 42, 42, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 170, 0, 0.1);
        }
        
        .text-shadow {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }
        
        .btn-minecraft {
            background: linear-gradient(135deg, #FFAA00 0%, #FF8800 100%);
            border: 2px solid #FFAA00;
            color: #000;
            font-weight: bold;
            text-shadow: none;
            transition: all 0.3s ease;
        }
        
        .btn-minecraft:hover {
            background: linear-gradient(135deg, #FFFF55 0%, #FFAA00 100%);
            border-color: #FFFF55;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 170, 0, 0.4);
        }
        
        .nav-item:hover {
            color: #FFAA00 !important;
            transition: all 0.3s ease;
        }
        
        .admin-badge {
            background: linear-gradient(45deg, #ff0000, #ff6600);
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        .admin-tab.active {
            border-bottom-color: #FFAA00 !important;
            color: #FFAA00 !important;
        }
        
        .admin-tab:hover {
            color: #FFAA00 !important;
        }
        
        .stat-card {
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 170, 0, 0.2);
        }

        /* === СТИЛИ ДЛЯ НОВОЙ СИСТЕМЫ НАСТРОЕК === */
        .settings-category-tab.active {
            color: #FFD700 !important;
            border-bottom-color: #FFD700 !important;
        }

        .settings-category-content {
            min-height: 400px;
        }

        .setting-input {
            transition: all 0.3s ease;
        }

        .setting-input:focus {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.2);
        }

        .tooltip-icon:hover {
            color: #FFD700 !important;
            transform: scale(1.1);
            transition: all 0.2s ease;
        }

        .template-selector.border-minecraft-gold {
            background-color: rgba(255, 215, 0, 0.1);
        }

        .template-selector:hover {
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        .setting-item {
            position: relative;
        }

        .setting-item:hover .tooltip-icon {
            opacity: 1;
        }

        /* Кастомные чекбоксы для системных настроек */
        .peer:checked + div {
            background-color: var(--checkbox-color, #FFD700);
        }

        /* Стили для кода в шаблонах */
        #template-html {
            font-family: 'Courier New', monospace;
            tab-size: 2;
        }

        /* Анимации */
        .settings-category-content {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive дизайн */
        @media (max-width: 768px) {
            .settings-category-tab {
                padding: 8px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body class="minecraft-bg min-h-screen overflow-x-hidden relative">
    <!-- Навигация -->
    <nav class="glass-effect sticky top-0 z-50 border-b border-minecraft-gold/30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Левая часть - название админ панели -->
                <div class="flex items-center">
                    <span class="text-2xl font-bold text-minecraft-yellow text-shadow flex items-center">
                        <i class="fas fa-crown text-minecraft-gold mr-2"></i>
                        Admin Panel
                    </span>
                </div>
                
                <!-- Центральная часть - основные кнопки -->
                <div class="flex items-center space-x-6">
                    <a href="/" class="nav-item text-white hover:text-minecraft-gold transition-colors text-shadow">Главная</a>
                    <a href="/rules" class="nav-item text-white hover:text-minecraft-gold transition-colors text-shadow">Правила</a>
                    <a href="/forum" class="nav-item text-white hover:text-minecraft-gold transition-colors text-shadow">Форум</a>
                    <a href="/online" class="nav-item text-white hover:text-minecraft-gold transition-colors text-shadow">Онлайн</a>
                    <a href="/map" target="_blank" class="nav-item text-white hover:text-minecraft-gold transition-colors text-shadow">Карта</a>
                </div>
                
                <!-- Правая часть - социальные сети и профиль -->
                <div class="flex items-center space-x-4">
                    <!-- Социальные сети -->
                    <div class="flex items-center space-x-2">
                        <a href="https://discord.gg/chiwawa" target="_blank" id="discord-link" class="text-gray-400 hover:text-purple-400 transition-colors text-lg" title="Discord">
                            <i class="fab fa-discord"></i>
                        </a>
                        <a href="https://t.me/chiwawa" target="_blank" id="telegram-link" class="text-gray-400 hover:text-blue-400 transition-colors text-lg" title="Telegram">
                            <i class="fab fa-telegram"></i>
                        </a>
                    </div>
                    
                    <!-- Разделитель -->
                    <div class="h-6 w-px bg-minecraft-gold/30"></div>
                    
                    <!-- Профиль администратора -->
                    <div class="relative">
                        <button id="profile-dropdown-btn" class="nav-item bg-gradient-to-r from-minecraft-gold to-yellow-500 text-minecraft-dark px-4 py-2 rounded-lg font-bold hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-minecraft-gold/50 cursor-pointer flex items-center space-x-2">
                            <div class="w-8 h-8 bg-minecraft-dark rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-minecraft-gold text-sm"></i>
                            </div>
                            <span id="admin-nickname" class="font-medium">ebluffy</span>
                            <span class="ml-2 px-2 py-1 bg-red-500/80 text-white text-xs font-bold rounded-full border border-red-500/40">
                                <i class="fas fa-crown mr-1"></i>ADMIN
                            </span>
                            <i class="fas fa-chevron-down text-xs ml-1"></i>
                        </button>
                        
                        <!-- Dropdown меню -->
                        <div id="profileDropdown" class="absolute top-full right-0 mt-2 w-48 bg-minecraft-gray rounded-lg shadow-xl border border-minecraft-gold/30 hidden z-50">
                            <a href="/profile" class="block px-4 py-3 text-white hover:bg-minecraft-light-gray transition-colors border-b border-minecraft-gold/20">
                                <i class="fas fa-user-circle mr-2 text-minecraft-gold"></i>Личный кабинет
                            </a>
                            <a href="/admin" class="block px-4 py-3 text-minecraft-gold hover:bg-minecraft-light-gray transition-colors border-b border-minecraft-gold/20">
                                <i class="fas fa-crown mr-2 text-minecraft-gold"></i>Админ панель
                            </a>
                            <button id="logout-dropdown-btn" class="w-full text-left px-4 py-3 text-red-400 hover:bg-minecraft-light-gray transition-colors">
                                <i class="fas fa-sign-out-alt mr-2"></i>Выйти
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Проверка доступа -->
    <div id="access-denied" class="hidden">
        <div class="max-w-md mx-auto mt-20">
            <div class="glass-effect rounded-xl shadow-lg p-8 text-center">
                <i class="fas fa-lock text-red-400 text-4xl mb-4"></i>
                <h2 class="text-2xl font-bold text-white mb-4">Доступ запрещен</h2>
                <p class="text-gray-300 mb-6">У вас нет прав администратора</p>
                <a href="/profile" class="btn-minecraft px-6 py-3 rounded-lg inline-block">
                    Вернуться в профиль
                </a>
            </div>
        </div>
    </div>

    <!-- Основной контент админ-панели -->
    <div id="admin-content" class="hidden">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Заголовок -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-white">Панель администратора</h1>
                <p class="text-gray-300 mt-2">Управление сервером и пользователями</p>
            </div>

            <!-- Статистика -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="glass-effect rounded-xl shadow-lg p-6 stat-card">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-minecraft-gold/20 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-users text-minecraft-gold text-xl"></i>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-white" id="total-users">0</div>
                            <div class="text-sm text-gray-300">Всего пользователей</div>
                        </div>
                    </div>
                </div>
                <div class="glass-effect rounded-xl shadow-lg p-6 stat-card">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-file-alt text-green-400 text-xl"></i>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-white" id="pending-apps">0</div>
                            <div class="text-sm text-gray-300">Заявки на рассмотрении</div>
                        </div>
                    </div>
                </div>
                <div class="glass-effect rounded-xl shadow-lg p-6 stat-card">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-yellow-500/20 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-clock text-yellow-400 text-xl"></i>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-white" id="active-sessions">0</div>
                            <div class="text-sm text-gray-300">Активных сессий</div>
                        </div>
                    </div>
                </div>
                <div class="glass-effect rounded-xl shadow-lg p-6 stat-card">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-red-500/20 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-ban text-red-400 text-xl"></i>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-white" id="banned-users">0</div>
                            <div class="text-sm text-gray-300">Заблокированных</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Навигация по разделам -->
            <div class="glass-effect rounded-xl shadow-lg mb-8">
                <div class="border-b border-minecraft-gold/20">
                    <nav class="flex space-x-8 px-6">
                        <button class="admin-tab active py-4 px-2 border-b-2 border-minecraft-gold text-minecraft-gold font-medium" data-tab="applications">
                            <i class="fas fa-file-alt mr-2"></i>Заявки
                        </button>
                        <button class="admin-tab py-4 px-2 border-b-2 border-transparent text-gray-300 hover:text-minecraft-gold" data-tab="users">
                            <i class="fas fa-users mr-2"></i>Пользователи
                        </button>
                        <button class="admin-tab py-4 px-2 border-b-2 border-transparent text-gray-300 hover:text-minecraft-gold" data-tab="trust-levels">
                            <i class="fas fa-medal mr-2"></i>Trust Level
                        </button>
                        <button class="admin-tab py-4 px-2 border-b-2 border-transparent text-gray-300 hover:text-minecraft-gold" data-tab="settings">
                            <i class="fas fa-cog mr-2"></i>Настройки
                        </button>
                        <button class="admin-tab py-4 px-2 border-b-2 border-transparent text-gray-300 hover:text-minecraft-gold" data-tab="technical">
                            <i class="fas fa-server mr-2"></i>Техническое
                        </button>
                        <button class="admin-tab py-4 px-2 border-b-2 border-transparent text-gray-300 hover:text-minecraft-gold" data-tab="logs">
                            <i class="fas fa-list mr-2"></i>Логи
                        </button>
                    </nav>
                </div>

                <div class="p-6">
                    <!-- Заявки -->
                    <div id="tab-applications" class="admin-tab-content">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold text-white">Заявки на whitelist</h3>
                            <select id="app-status-filter" class="px-4 py-2 bg-minecraft-gray border border-minecraft-gold/20 rounded-lg text-white">
                                <option value="all">Все заявки</option>
                                <option value="pending">На рассмотрении</option>
                                <option value="approved">Одобренные</option>
                                <option value="rejected">Отклоненные</option>
                            </select>
                        </div>
                        <div id="applications-list" class="space-y-4">
                            <div class="text-center py-8">
                                <i class="fas fa-spinner fa-spin text-2xl text-minecraft-gold mb-2"></i>
                                <p class="text-gray-300">Загрузка заявок...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Пользователи -->
                    <div id="tab-users" class="admin-tab-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold text-white">Управление пользователями</h3>
                            <div class="flex space-x-3">
                                <input type="text" id="user-search" placeholder="Поиск пользователей..."
                                    autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
                                    data-lpignore="true" data-form-type="search" readonly onfocus="this.removeAttribute('readonly');"
                                    class="px-4 py-2 bg-minecraft-gray border border-minecraft-gold/20 rounded-lg text-white placeholder-gray-400 focus:border-minecraft-gold focus:outline-none">
                                <select id="user-status-filter" class="px-4 py-2 bg-minecraft-gray border border-minecraft-gold/20 rounded-lg text-white focus:border-minecraft-gold focus:outline-none">
                                    <option value="all">Все пользователи</option>
                                    <option value="active">Активные</option>
                                    <option value="banned">Заблокированные</option>
                                </select>
                            </div>
                        </div>
                        <div id="users-list" class="space-y-4">
                            <div class="text-center py-8">
                                <i class="fas fa-spinner fa-spin text-2xl text-minecraft-gold mb-2"></i>
                                <p class="text-gray-300">Загрузка пользователей...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Trust Level система -->
                    <div id="tab-trust-levels" class="admin-tab-content hidden">
                        <h3 class="text-lg font-semibold text-white mb-6">Управление системой Trust Level</h3>
                        
                        <div class="grid md:grid-cols-2 gap-8 mb-8">
                            <!-- Информация о системе -->
                            <div class="glass-effect rounded-lg p-6">
                                <h4 class="font-medium text-white mb-4">
                                    <i class="fas fa-info-circle mr-2 text-minecraft-gold"></i>Система уровней доверия
                                </h4>
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">🚶 Проходимец (Уровень 0):</span>
                                        <span class="text-white">Лимит 10 часов до подтверждения почты</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">👤 Новичок (Уровень 1):</span>
                                        <span class="text-white">Стандартный уровень после подтверждения почты</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">✅ Проверенный (Уровень 2):</span>
                                        <span class="text-white">25 часов + почта + 10+ репутации + заявка</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">🏆 Ветеран (Уровень 3):</span>
                                        <span class="text-white">50 часов + почта + 20+ репутации + заявка</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Статистика по уровням -->
                            <div class="glass-effect rounded-lg p-6">
                                <h4 class="font-medium text-white mb-4">
                                    <i class="fas fa-chart-bar mr-2 text-minecraft-gold"></i>Распределение по уровням
                                </h4>
                                <div id="trust-level-stats" class="space-y-3 text-sm">
                                    <div class="text-center py-4">
                                        <i class="fas fa-spinner fa-spin text-minecraft-gold"></i>
                                        <p class="text-gray-300 mt-2">Загрузка статистики...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Заявки на повышение траст левела -->
                        <div class="glass-effect rounded-lg p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h4 class="font-medium text-white">
                                    <i class="fas fa-arrow-up mr-2 text-minecraft-gold"></i>Заявки на повышение уровня
                                </h4>
                                <select id="trust-app-status-filter" class="px-4 py-2 bg-minecraft-gray border border-minecraft-gold/20 rounded-lg text-white">
                                    <option value="all">Все заявки</option>
                                    <option value="pending">На рассмотрении</option>
                                    <option value="approved">Одобренные</option>
                                    <option value="rejected">Отклоненные</option>
                                </select>
                            </div>
                            <div id="trust-applications-list" class="space-y-4">
                                <div class="text-center py-8">
                                    <i class="fas fa-spinner fa-spin text-2xl text-minecraft-gold mb-2"></i>
                                    <p class="text-gray-300">Загрузка заявок...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Настройки сайта -->
                    <div id="tab-settings" class="admin-tab-content hidden">
                        <div class="mb-8">
                            <h3 class="text-2xl font-bold text-white mb-2">Настройки сервера</h3>
                            <p class="text-gray-400">Управление всеми параметрами сервера, email-рассылками и шаблонами писем</p>
                        </div>
                        
                        <!-- Навигация по категориям настроек -->
                        <div class="flex flex-wrap gap-2 mb-8 border-b border-gray-700 pb-4">
                            <button class="settings-category-tab px-6 py-3 text-sm font-medium text-gray-300 hover:text-minecraft-gold border-b-2 border-transparent hover:border-minecraft-gold transition-all active" data-category="general">
                                <i class="fas fa-cog mr-2"></i>Основные
                            </button>
                            <button class="settings-category-tab px-6 py-3 text-sm font-medium text-gray-300 hover:text-minecraft-gold border-b-2 border-transparent hover:border-minecraft-gold transition-all" data-category="applications">
                                <i class="fas fa-file-alt mr-2"></i>Заявки
                            </button>
                            <button class="settings-category-tab px-6 py-3 text-sm font-medium text-gray-300 hover:text-minecraft-gold border-b-2 border-transparent hover:border-minecraft-gold transition-all" data-category="trust">
                                <i class="fas fa-star mr-2"></i>Trust Level
                            </button>
                            <button class="settings-category-tab px-6 py-3 text-sm font-medium text-gray-300 hover:text-minecraft-gold border-b-2 border-transparent hover:border-minecraft-gold transition-all" data-category="security">
                                <i class="fas fa-shield-alt mr-2"></i>Безопасность
                            </button>
                            <button class="settings-category-tab px-6 py-3 text-sm font-medium text-gray-300 hover:text-minecraft-gold border-b-2 border-transparent hover:border-minecraft-gold transition-all" data-category="email">
                                <i class="fas fa-envelope mr-2"></i>Email система
                            </button>
                            <button class="settings-category-tab px-6 py-3 text-sm font-medium text-gray-300 hover:text-minecraft-gold border-b-2 border-transparent hover:border-minecraft-gold transition-all" data-category="templates">
                                <i class="fas fa-code mr-2"></i>Шаблоны писем
                            </button>
                        </div>

                        <!-- Основные настройки -->
                        <div id="settings-category-general" class="settings-category-content">
                            <div class="grid lg:grid-cols-2 gap-8">
                                <div class="glass-effect rounded-lg p-6">
                                    <h4 class="font-semibold text-white mb-6 flex items-center">
                                        <i class="fas fa-server mr-3 text-minecraft-gold"></i>
                                        Информация о сервере
                                    </h4>
                                    <div class="space-y-6">
                                        <div class="setting-item">
                                            <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                Название сервера
                                                <span class="tooltip-icon ml-2" data-tooltip="Отображается на главной странице и в заголовках email-писем">
                                                    <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                </span>
                                            </label>
                                            <input type="text" id="server-name" value="Chiwawa" 
                                                class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                            <p class="text-xs text-gray-500 mt-2">Максимум 100 символов. Будет использоваться в заголовках email-писем.</p>
                                        </div>
                                        
                                        <div class="setting-item">
                                            <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                Описание сервера
                                                <span class="tooltip-icon ml-2" data-tooltip="Краткое описание для новых игроков и приветственных писем">
                                                    <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                </span>
                                            </label>
                                            <textarea id="server-description" rows="4" 
                                                class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none resize-none transition-colors">Приватный Minecraft сервер с дружелюбным сообществом</textarea>
                                            <p class="text-xs text-gray-500 mt-2">Отображается на главной странице и в приветственных письмах. Максимум 500 символов.</p>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-4">
                                            <div class="setting-item">
                                                <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                    IP адрес сервера
                                                    <span class="tooltip-icon ml-2" data-tooltip="Основной адрес для подключения к Minecraft серверу">
                                                        <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                    </span>
                                                </label>
                                                <input type="text" id="server-ip" value="play.chiwawa.site" 
                                                    class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                            </div>
                                            
                                            <div class="setting-item">
                                                <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                    Порт сервера
                                                    <span class="tooltip-icon ml-2" data-tooltip="Стандартный порт Minecraft: 25565">
                                                        <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                    </span>
                                                </label>
                                                <input type="number" id="server-port" value="25565" min="1" max="65535" 
                                                    class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                            </div>
                                        </div>

                                        <div class="setting-item">
                                            <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                Максимум игроков онлайн
                                                <span class="tooltip-icon ml-2" data-tooltip="Лимит одновременных подключений к серверу">
                                                    <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                </span>
                                            </label>
                                            <input type="number" id="max-players" value="100" min="1" max="1000" 
                                                class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                            <p class="text-xs text-gray-500 mt-2">Отображается в статусе сервера и на главной странице.</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="glass-effect rounded-lg p-6">
                                    <h4 class="font-semibold text-white mb-6 flex items-center">
                                        <i class="fas fa-users mr-3 text-minecraft-gold"></i>
                                        Социальные сети и сообщества
                                    </h4>
                                    <div class="space-y-6">
                                        <div class="setting-item">
                                            <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                <i class="fab fa-discord mr-2 text-indigo-400"></i>
                                                Discord приглашение
                                                <span class="tooltip-icon ml-2" data-tooltip="Постоянная ссылка-приглашение на Discord сервер">
                                                    <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                </span>
                                            </label>
                                            <input type="url" id="discord-invite" value="https://discord.gg/chiwawa" 
                                                class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                            <p class="text-xs text-gray-500 mt-2">Добавляется в письма-приглашения и на сайт. Убедитесь, что ссылка не имеет срока действия.</p>
                                        </div>
                                        
                                        <div class="setting-item">
                                            <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                <i class="fab fa-telegram mr-2 text-blue-400"></i>
                                                Telegram канал
                                                <span class="tooltip-icon ml-2" data-tooltip="Ссылка на официальный Telegram канал с новостями">
                                                    <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                </span>
                                            </label>
                                            <input type="url" id="telegram-invite" value="https://t.me/chiwawa" 
                                                class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                            <p class="text-xs text-gray-500 mt-2">Ссылка на официальные новости и обновления сервера.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-8 glass-effect rounded-lg p-6">
                                <h4 class="font-semibold text-white mb-6 flex items-center">
                                    <i class="fas fa-toggle-on mr-3 text-minecraft-gold"></i>
                                    Системные настройки
                                </h4>
                                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    <div class="setting-item">
                                        <div class="p-5 bg-minecraft-gray/30 rounded-lg border border-minecraft-gold/20 hover:border-minecraft-gold/40 transition-colors">
                                            <div class="flex items-start justify-between">
                                                <div class="flex-1">
                                                    <h5 class="text-sm font-medium text-gray-300 mb-1">Режим обслуживания</h5>
                                                    <p class="text-xs text-gray-500 leading-relaxed">Временно закрывает доступ к сайту для всех пользователей кроме администраторов</p>
                                                </div>
                                                <label class="relative inline-flex items-center cursor-pointer ml-4">
                                                    <input type="checkbox" id="maintenance-mode" class="sr-only peer">
                                                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="setting-item">
                                        <div class="p-5 bg-minecraft-gray/30 rounded-lg border border-minecraft-gold/20 hover:border-minecraft-gold/40 transition-colors">
                                            <div class="flex items-start justify-between">
                                                <div class="flex-1">
                                                    <h5 class="text-sm font-medium text-gray-300 mb-1">Регистрация разрешена</h5>
                                                    <p class="text-xs text-gray-500 leading-relaxed">Позволяет новым пользователям создавать аккаунты на сайте</p>
                                                </div>
                                                <label class="relative inline-flex items-center cursor-pointer ml-4">
                                                    <input type="checkbox" id="registration-enabled" checked class="sr-only peer">
                                                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-minecraft-gold"></div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="setting-item">
                                        <div class="p-5 bg-minecraft-gray/30 rounded-lg border border-minecraft-gold/20 hover:border-minecraft-gold/40 transition-colors">
                                            <div class="flex items-start justify-between">
                                                <div class="flex-1">
                                                    <h5 class="text-sm font-medium text-gray-300 mb-1">Автоматические бэкапы</h5>
                                                    <p class="text-xs text-gray-500 leading-relaxed">Автоматическое резервное копирование базы данных и файлов</p>
                                                </div>
                                                <label class="relative inline-flex items-center cursor-pointer ml-4">
                                                    <input type="checkbox" id="auto-backup-enabled" checked class="sr-only peer">
                                                    <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Настройки заявок -->
                        <div id="settings-category-applications" class="settings-category-content hidden">
                            <div class="glass-effect rounded-lg p-6">
                                <h4 class="font-semibold text-white mb-6 flex items-center">
                                    <i class="fas fa-file-alt mr-3 text-minecraft-gold"></i>
                                    Система заявок
                                </h4>
                                <div class="grid lg:grid-cols-2 gap-8">
                                    <div class="space-y-6">
                                        <div class="setting-item">
                                            <div class="p-5 bg-minecraft-gray/30 rounded-lg border border-minecraft-gold/20">
                                                <div class="flex items-start justify-between">
                                                    <div class="flex-1">
                                                        <h5 class="text-sm font-medium text-gray-300 mb-1">Прием заявок</h5>
                                                        <p class="text-xs text-gray-500 leading-relaxed">Позволяет игрокам подавать заявки на присоединение к серверу</p>
                                                    </div>
                                                    <label class="relative inline-flex items-center cursor-pointer ml-4">
                                                        <input type="checkbox" id="applications-enabled" checked class="sr-only peer">
                                                        <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-minecraft-gold"></div>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="setting-item">
                                            <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                Минимум символов в мотивации
                                                <span class="tooltip-icon ml-2" data-tooltip="Требуемая длина текста мотивации в заявке">
                                                    <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                </span>
                                            </label>
                                            <input type="number" id="min-motivation-length" value="50" min="10" max="500" 
                                                class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                            <p class="text-xs text-gray-500 mt-2">Помогает отфильтровать некачественные заявки. Рекомендуется: 50-100 символов.</p>
                                        </div>

                                        <div class="setting-item">
                                            <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                Минимум символов в планах
                                                <span class="tooltip-icon ml-2" data-tooltip="Требуемая длина описания планов игрока на сервере">
                                                    <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                </span>
                                            </label>
                                            <input type="number" id="min-plans-length" value="30" min="10" max="300" 
                                                class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                            <p class="text-xs text-gray-500 mt-2">Планы игрока на сервере помогают оценить серьезность намерений.</p>
                                        </div>
                                    </div>

                                    <div class="space-y-6">
                                        <div class="setting-item">
                                            <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                Лимит заявок с одного IP в день
                                                <span class="tooltip-icon ml-2" data-tooltip="Защита от спама заявок с одного IP-адреса">
                                                    <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                </span>
                                            </label>
                                            <input type="number" id="max-applications-per-day" value="3" min="1" max="20" 
                                                class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                            <p class="text-xs text-gray-500 mt-2">Предотвращает спам заявок. Рекомендуется: 1-3 заявки в день.</p>
                                        </div>

                                        <div class="setting-item">
                                            <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                Автоматическое одобрение заявок
                                                <span class="tooltip-icon ml-2" data-tooltip="Заявки от игроков с определённым Trust Level одобряются автоматически">
                                                    <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                </span>
                                            </label>
                                            <select id="auto-approve-trust-level" 
                                                class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                                <option value="0">Отключено - все заявки проверяются вручную</option>
                                                <option value="1">До 1 уровня - автоодобрение с 0 до 1 уровня</option>
                                                <option value="2">До 2 уровня - автоодобрение с 1 до 2 уровня</option>
                                            </select>
                                            <p class="text-xs text-gray-500 mt-2">Игроки с указанным уровнем могут быть автоматически повышены до следующего уровня.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Trust Level система -->
                        <div id="settings-category-trust" class="settings-category-content hidden">
                            <div class="glass-effect rounded-lg p-6">
                                <h4 class="font-semibold text-white mb-6 flex items-center">
                                    <i class="fas fa-star mr-3 text-minecraft-gold"></i>
                                    Trust Level система
                                </h4>
                                <div class="mb-6 p-4 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                                    <div class="flex items-start">
                                        <i class="fas fa-info-circle text-blue-400 mt-1 mr-3"></i>
                                        <div>
                                            <h5 class="text-sm font-medium text-blue-300 mb-1">Как работает Trust Level?</h5>
                                            <p class="text-xs text-blue-200/80 leading-relaxed">
                                                Система доверия автоматически присваивает очки игрокам за различные действия. 
                                                Чем больше очков, тем выше уровень доверия и больше привилегий на сервере.
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <div class="grid lg:grid-cols-2 gap-8">
                                    <div class="space-y-6">
                                        <h5 class="text-lg font-medium text-gray-300 mb-4">Начисление очков</h5>
                                        
                                        <div class="setting-item">
                                            <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                <i class="fas fa-envelope-check mr-2 text-green-400"></i>
                                                Очки за подтверждение email
                                                <span class="tooltip-icon ml-2" data-tooltip="Единоразовое начисление за верификацию почты">
                                                    <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                </span>
                                            </label>
                                            <input type="number" id="trust-points-email" value="10" min="0" max="100" 
                                                class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                            <p class="text-xs text-gray-500 mt-2">Поощряет игроков подтверждать email для получения уведомлений.</p>
                                        </div>

                                        <div class="setting-item">
                                            <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                <i class="fab fa-discord mr-2 text-indigo-400"></i>
                                                Очки за связку с Discord
                                                <span class="tooltip-icon ml-2" data-tooltip="Единоразовое начисление за связку аккаунта с Discord">
                                                    <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                </span>
                                            </label>
                                            <input type="number" id="trust-points-discord" value="15" min="0" max="100" 
                                                class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                            <p class="text-xs text-gray-500 mt-2">Поощряет участие в Discord сообществе сервера.</p>
                                        </div>

                                        <div class="setting-item">
                                            <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                <i class="fas fa-clock mr-2 text-blue-400"></i>
                                                Очки за час игры на сервере
                                                <span class="tooltip-icon ml-2" data-tooltip="Постоянное начисление за активность на сервере">
                                                    <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                </span>
                                            </label>
                                            <input type="number" id="trust-points-hour" value="1" min="0" max="10" 
                                                class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                            <p class="text-xs text-gray-500 mt-2">Основной способ набора очков. Не ставьте слишком высоко.</p>
                                        </div>

                                        <div class="setting-item">
                                            <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                <i class="fas fa-heart mr-2 text-red-400"></i>
                                                Очки за единицу репутации
                                                <span class="tooltip-icon ml-2" data-tooltip="Сколько очков доверия даёт 1 единица репутации">
                                                    <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                </span>
                                            </label>
                                            <input type="number" id="trust-points-reputation" value="2" min="0" max="20" 
                                                class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                            <p class="text-xs text-gray-500 mt-2">Поощряет активное участие в сообществе и помощь другим игрокам.</p>
                                        </div>
                                    </div>

                                    <div class="space-y-6">
                                        <h5 class="text-lg font-medium text-gray-300 mb-4">Требования для уровней</h5>
                                        
                                        <div class="setting-item">
                                            <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                <i class="fas fa-hourglass-half text-purple-400 mr-2"></i>
                                                Минимальное время игры (часов)
                                                <span class="tooltip-icon ml-2" data-tooltip="Минимум часов игры на сервере для повышения Trust Level">
                                                    <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                </span>
                                            </label>
                                            <input type="number" id="trust-minimum-hours" value="5" min="0" max="500" 
                                                class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                            <p class="text-xs text-gray-500 mt-2">Обязательное условие наравне с очками. Применяется ко всем уровням.</p>
                                        </div>

                                        <div class="setting-item">
                                            <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                <i class="fas fa-heart text-red-400 mr-2"></i>
                                                Минимальная репутация
                                                <span class="tooltip-icon ml-2" data-tooltip="Минимум репутации для повышения Trust Level">
                                                    <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                </span>
                                            </label>
                                            <input type="number" id="trust-minimum-reputation" value="0" min="0" max="100" 
                                                class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                            <p class="text-xs text-gray-500 mt-2">Обязательное условие наравне с очками. Применяется ко всем уровням.</p>
                                        </div>
                                        
                                        <div class="setting-item">
                                            <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                <i class="fas fa-star text-gray-400 mr-2"></i>
                                                Trust Level 1 (очков)
                                                <span class="tooltip-icon ml-2" data-tooltip="Базовый уровень доверия для новых игроков">
                                                    <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                </span>
                                            </label>
                                            <input type="number" id="trust-level-1-required" value="25" min="1" max="1000" 
                                                class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                            <p class="text-xs text-gray-500 mt-2">Легко достижимый уровень для активных новичков.</p>
                                        </div>

                                        <div class="setting-item">
                                            <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                <i class="fas fa-star text-yellow-400 mr-2"></i>
                                                Trust Level 2 (очков)
                                                <span class="tooltip-icon ml-2" data-tooltip="Средний уровень доверия для постоянных игроков">
                                                    <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                </span>
                                            </label>
                                            <input type="number" id="trust-level-2-required" value="100" min="1" max="1000" 
                                                class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                            <p class="text-xs text-gray-500 mt-2">Для игроков, проводящих много времени на сервере.</p>
                                        </div>

                                        <div class="setting-item">
                                            <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                <i class="fas fa-star text-minecraft-gold mr-2"></i>
                                                Trust Level 3 (очков)
                                                <span class="tooltip-icon ml-2" data-tooltip="Высокий уровень доверия для ветеранов сервера">
                                                    <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                </span>
                                            </label>
                                            <input type="number" id="trust-level-3-required" value="500" min="1" max="1000" 
                                                class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                            <p class="text-xs text-gray-500 mt-2">Элитный уровень для самых преданных игроков.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Настройки безопасности -->
                        <div id="settings-category-security" class="settings-category-content hidden">
                            <div class="glass-effect rounded-lg p-6">
                                <h4 class="font-semibold text-white mb-6 flex items-center">
                                    <i class="fas fa-shield-alt mr-3 text-minecraft-gold"></i>
                                    Безопасность и защита
                                </h4>
                                
                                <div class="grid lg:grid-cols-2 gap-8">
                                    <div class="space-y-6">
                                        <h5 class="text-lg font-medium text-gray-300 mb-4">Защита от брутфорса</h5>
                                        
                                        <div class="setting-item">
                                            <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                Максимум попыток входа
                                                <span class="tooltip-icon ml-2" data-tooltip="Количество неудачных попыток входа до блокировки IP">
                                                    <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                </span>
                                            </label>
                                            <input type="number" id="max-login-attempts" value="5" min="3" max="20" 
                                                class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                            <p class="text-xs text-gray-500 mt-2">Рекомендуется: 3-5 попыток. Слишком мало - неудобно для пользователей.</p>
                                        </div>

                                        <div class="setting-item">
                                            <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                Время блокировки (минуты)
                                                <span class="tooltip-icon ml-2" data-tooltip="На сколько минут блокируется IP после превышения лимита попыток">
                                                    <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                </span>
                                            </label>
                                            <input type="number" id="login-lockout-duration" value="15" min="5" max="1440" 
                                                class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                            <p class="text-xs text-gray-500 mt-2">15-30 минут достаточно для защиты, но не слишком жестко.</p>
                                        </div>

                                        <div class="setting-item">
                                            <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                Rate Limiting (запросов в минуту)
                                                <span class="tooltip-icon ml-2" data-tooltip="Максимальное количество API запросов с одного IP в минуту">
                                                    <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                </span>
                                            </label>
                                            <input type="number" id="rate-limit-requests" value="100" min="10" max="1000" 
                                                class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                            <p class="text-xs text-gray-500 mt-2">Защита от DDoS атак и злоупотреблений API.</p>
                                        </div>
                                    </div>

                                    <div class="space-y-6">
                                        <h5 class="text-lg font-medium text-gray-300 mb-4">Аутентификация</h5>
                                        
                                        <div class="setting-item">
                                            <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                Время жизни JWT токена (дни)
                                                <span class="tooltip-icon ml-2" data-tooltip="Через сколько дней пользователь должен войти заново">
                                                    <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                </span>
                                            </label>
                                            <input type="number" id="jwt-expires-days" value="7" min="1" max="365" 
                                                class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                            <p class="text-xs text-gray-500 mt-2">7-30 дней оптимально для баланса безопасности и удобства.</p>
                                        </div>

                                        <div class="setting-item">
                                            <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                Требовать подтверждение email
                                                <span class="tooltip-icon ml-2" data-tooltip="Обязательная верификация почты при регистрации">
                                                    <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                </span>
                                            </label>
                                            <select id="require-email-verification" 
                                                class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                                <option value="true">Да - обязательное подтверждение</option>
                                                <option value="false">Нет - можно без подтверждения</option>
                                            </select>
                                            <p class="text-xs text-gray-500 mt-2">Рекомендуется включить для защиты от фейковых аккаунтов.</p>
                                        </div>

                                        <div class="setting-item">
                                            <div class="p-5 bg-minecraft-gray/30 rounded-lg border border-minecraft-gold/20">
                                                <div class="flex items-start justify-between">
                                                    <div class="flex-1">
                                                        <h5 class="text-sm font-medium text-gray-300 mb-1">Двухфакторная аутентификация</h5>
                                                        <p class="text-xs text-gray-500 leading-relaxed">Дополнительная защита для администраторов и модераторов через приложения-аутентификаторы</p>
                                                    </div>
                                                    <label class="relative inline-flex items-center cursor-pointer ml-4">
                                                        <input type="checkbox" id="two-factor-enabled" class="sr-only peer">
                                                        <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Email система -->
                        <div id="settings-category-email" class="settings-category-content hidden">
                            <div class="space-y-8">
                                <!-- SMTP настройки -->
                                <div class="glass-effect rounded-lg p-6">
                                    <h4 class="font-semibold text-white mb-6 flex items-center">
                                        <i class="fas fa-server mr-3 text-minecraft-gold"></i>
                                        SMTP сервер
                                    </h4>
                                    <div class="mb-6 p-4 bg-blue-500/10 border border-blue-500/30 rounded-lg">
                                        <div class="flex items-start">
                                            <i class="fas fa-lightbulb text-blue-400 mt-1 mr-3"></i>
                                            <div>
                                                <h5 class="text-sm font-medium text-blue-300 mb-1">Рекомендуемые настройки для Yandex Mail</h5>
                                                <p class="text-xs text-blue-200/80 leading-relaxed">
                                                    SMTP: smtp.yandex.ru, Порт: 465, TLS: Включен<br>
                                                    Используйте пароль приложения вместо основного пароля для лучшей безопасности.
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="grid lg:grid-cols-2 gap-8">
                                        <div class="space-y-6">
                                            <div class="setting-item">
                                                <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                    SMTP сервер
                                                    <span class="tooltip-icon ml-2" data-tooltip="Адрес SMTP сервера для отправки email">
                                                        <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                    </span>
                                                </label>
                                                <input type="text" id="smtp-host" value="smtp.yandex.ru" 
                                                    class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                                <p class="text-xs text-gray-500 mt-2">Примеры: smtp.gmail.com, smtp.yandex.ru, smtp.mail.ru</p>
                                            </div>

                                            <div class="setting-item">
                                                <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                    SMTP порт
                                                    <span class="tooltip-icon ml-2" data-tooltip="Порт SMTP сервера (обычно 587 или 465)">
                                                        <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                    </span>
                                                </label>
                                                <input type="number" id="smtp-port" value="465" min="25" max="65535" 
                                                    class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                                <p class="text-xs text-gray-500 mt-2">587 (STARTTLS) или 465 (SSL/TLS)</p>
                                            </div>

                                            <div class="setting-item">
                                                <div class="p-5 bg-minecraft-gray/30 rounded-lg border border-minecraft-gold/20">
                                                    <div class="flex items-start justify-between">
                                                        <div class="flex-1">
                                                            <h5 class="text-sm font-medium text-gray-300 mb-1">Использовать TLS/SSL шифрование</h5>
                                                            <p class="text-xs text-gray-500 leading-relaxed">Обязательно для современных SMTP серверов. Обеспечивает безопасную передачу данных.</p>
                                                        </div>
                                                        <label class="relative inline-flex items-center cursor-pointer ml-4">
                                                            <input type="checkbox" id="smtp-tls" checked class="sr-only peer">
                                                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="space-y-6">
                                            <div class="setting-item">
                                                <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                    Email отправителя
                                                    <span class="tooltip-icon ml-2" data-tooltip="Адрес, который будет указан как отправитель писем">
                                                        <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                    </span>
                                                </label>
                                                <input type="email" id="smtp-from" value="chiwawa.helper@yandex.ru" 
                                                    class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                                <p class="text-xs text-gray-500 mt-2">Должен соответствовать домену SMTP сервера для лучшей доставляемости.</p>
                                            </div>

                                            <div class="setting-item">
                                                <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                    SMTP пользователь (логин)
                                                    <span class="tooltip-icon ml-2" data-tooltip="Имя пользователя для авторизации на SMTP сервере">
                                                        <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                    </span>
                                                </label>
                                                <input type="text" id="smtp-user" value="chiwawa.helper@yandex.ru" 
                                                    class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                                <p class="text-xs text-gray-500 mt-2">Обычно совпадает с email адресом отправителя.</p>
                                            </div>

                                            <div class="setting-item">
                                                <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                    SMTP пароль
                                                    <span class="tooltip-icon ml-2" data-tooltip="Пароль или токен приложения для SMTP авторизации">
                                                        <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                    </span>
                                                </label>
                                                <div class="relative">
                                                    <input type="password" id="smtp-password" placeholder="••••••••••••••••" autocomplete="new-password"
                                                        class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors pr-12">
                                                    <button type="button" class="password-toggle-btn absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-minecraft-gold" data-target="smtp-password">
                                                        <i class="fas fa-eye" id="smtp-password-eye"></i>
                                                    </button>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-2">Рекомендуется использовать пароль приложения вместо основного пароля.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Дополнительные email настройки -->
                                <div class="glass-effect rounded-lg p-6">
                                    <h4 class="font-semibold text-white mb-6 flex items-center">
                                        <i class="fas fa-cogs mr-3 text-minecraft-gold"></i>
                                        Дополнительные настройки email
                                    </h4>
                                    <div class="grid lg:grid-cols-2 gap-8">
                                        <div class="space-y-6">
                                            <div class="setting-item">
                                                <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                    Имя отправителя
                                                    <span class="tooltip-icon ml-2" data-tooltip="Отображаемое имя отправителя в email клиентах">
                                                        <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                    </span>
                                                </label>
                                                <input type="text" id="smtp-sender-name" value="Chiwawa Server" 
                                                    class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                            </div>

                                            <div class="setting-item">
                                                <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                    Email для ответов (Reply-To)
                                                    <span class="tooltip-icon ml-2" data-tooltip="Адрес для ответов пользователей на письма">
                                                        <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                    </span>
                                                </label>
                                                <input type="email" id="smtp-reply-to" value="support@chiwawa.site" 
                                                    class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                            </div>
                                        </div>

                                        <div class="space-y-6">
                                            <div class="setting-item">
                                                <div class="p-5 bg-minecraft-gray/30 rounded-lg border border-minecraft-gold/20">
                                                    <div class="flex items-start justify-between">
                                                        <div class="flex-1">
                                                            <h5 class="text-sm font-medium text-gray-300 mb-1">Отправка email уведомлений</h5>
                                                            <p class="text-xs text-gray-500 leading-relaxed">Включает отправку уведомлений о новых заявках, регистрациях и других событиях</p>
                                                        </div>
                                                        <label class="relative inline-flex items-center cursor-pointer ml-4">
                                                            <input type="checkbox" id="email-notifications-enabled" checked class="sr-only peer">
                                                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-minecraft-gold"></div>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="setting-item">
                                                <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                                                    Тайм-аут отправки (секунды)
                                                    <span class="tooltip-icon ml-2" data-tooltip="Максимальное время ожидания ответа от SMTP сервера">
                                                        <i class="fas fa-info-circle text-xs text-gray-500 hover:text-minecraft-gold cursor-help"></i>
                                                    </span>
                                                </label>
                                                <input type="number" id="smtp-timeout" value="30" min="10" max="120" 
                                                    class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Тестирование email -->
                                <div class="glass-effect rounded-lg p-6">
                                    <h4 class="font-semibold text-white mb-6 flex items-center">
                                        <i class="fas fa-envelope-check mr-3 text-minecraft-gold"></i>
                                        Тестирование email системы
                                    </h4>
                                    
                                    <div class="grid lg:grid-cols-2 gap-8">
                                        <div class="space-y-4">
                                            <div class="setting-item">
                                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                                    Получатель письма
                                                </label>
                                                
                                                <!-- Переключатель режима выбора -->
                                                <div class="flex mb-3 bg-minecraft-dark rounded-lg p-1">
                                                    <button type="button" id="user-mode-btn" 
                                                        class="flex-1 px-3 py-2 text-sm rounded-md transition-all bg-minecraft-gold text-black font-medium">
                                                        Выбрать пользователя
                                                    </button>
                                                    <button type="button" id="email-mode-btn" 
                                                        class="flex-1 px-3 py-2 text-sm rounded-md transition-all text-gray-300 hover:bg-minecraft-gold/10">
                                                        Ввести email
                                                    </button>
                                                </div>
                                                
                                                <!-- Выпадающий список пользователей -->
                                                <div id="user-selector-container" class="block">
                                                    <select id="test-email-user" 
                                                        class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                                        <option value="">🔄 Загрузка пользователей...</option>
                                                    </select>
                                                    <p class="text-xs text-gray-500 mt-2">Приоритет: выберите зарегистрированного пользователя</p>
                                                </div>
                                                
                                                <!-- Поле ввода email -->
                                                <div id="email-input-container" class="hidden">
                                                    <input type="email" id="test-email-recipient" placeholder="test@example.com" 
                                                        class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                                    <p class="text-xs text-gray-500 mt-2">Email для отправки тестового письма</p>
                                                </div>
                                            </div>
                                            
                                            <div class="setting-item">
                                                <label class="block text-sm font-medium text-gray-300 mb-2">
                                                    Выберите шаблон письма
                                                </label>
                                                <select id="test-email-template" 
                                                    class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                                    <option value="">Выберите шаблон...</option>
                                                    <option value="welcome">Приветственное письмо</option>
                                                    <option value="verification">Подтверждение email</option>
                                                    <option value="application-approved">Заявка одобрена</option>
                                                    <option value="application-rejected">Заявка отклонена</option>
                                                    <option value="password-reset">Сброс пароля</option>
                                                    <option value="newsletter">Новостная рассылка</option>
                                                </select>
                                                <p class="text-xs text-gray-500 mt-2">Тестовое письмо будет отправлено с выбранным шаблоном</p>
                                            </div>
                                        </div>
                                        
                                        <div class="space-y-4">
                                            <button id="test-email-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                                                <i class="fas fa-paper-plane mr-2"></i>
                                                Отправить тестовое письмо
                                            </button>
                                            
                                            <div id="email-test-result" class="hidden p-4 rounded-lg">
                                                <div class="flex items-center">
                                                    <i class="fas fa-check-circle text-green-400 mr-3"></i>
                                                    <span class="text-sm">Результат теста появится здесь</span>
                                                </div>
                                            </div>
                                            
                                            <div class="text-xs text-gray-500">
                                                <p><strong>Проверка SMTP:</strong></p>
                                                <ul class="list-disc list-inside mt-1 space-y-1">
                                                    <li>Подключение к серверу</li>
                                                    <li>Авторизация</li>
                                                    <li>Отправка письма</li>
                                                    <li>Время доставки</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Шаблоны писем -->
                        <div id="settings-category-templates" class="settings-category-content hidden">
                            <div class="space-y-8">
                                <div class="glass-effect rounded-lg p-6">
                                    <h4 class="font-semibold text-white mb-6 flex items-center">
                                        <i class="fas fa-code mr-3 text-minecraft-gold"></i>
                                        Email шаблоны с HTML редактором
                                    </h4>
                                    
                                    <!-- Список шаблонов -->
                                    <div class="grid lg:grid-cols-2 gap-6 mb-8">
                                        <div class="template-selector p-4 bg-minecraft-gray/30 border border-minecraft-gold/20 rounded-lg hover:border-minecraft-gold/40 cursor-pointer transition-colors active" data-template="welcome">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <h5 class="font-medium text-gray-300">Приветственное письмо</h5>
                                                    <p class="text-xs text-gray-500 mt-1">Отправляется новым пользователям после регистрации</p>
                                                </div>
                                                <i class="fas fa-user-plus text-green-400"></i>
                                            </div>
                                        </div>

                                        <div class="template-selector p-4 bg-minecraft-gray/30 border border-minecraft-gold/20 rounded-lg hover:border-minecraft-gold/40 cursor-pointer transition-colors" data-template="verification">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <h5 class="font-medium text-gray-300">Подтверждение email</h5>
                                                    <p class="text-xs text-gray-500 mt-1">Письмо с ссылкой для верификации почты</p>
                                                </div>
                                                <i class="fas fa-envelope-check text-blue-400"></i>
                                            </div>
                                        </div>

                                        <div class="template-selector p-4 bg-minecraft-gray/30 border border-minecraft-gold/20 rounded-lg hover:border-minecraft-gold/40 cursor-pointer transition-colors" data-template="application-approved">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <h5 class="font-medium text-gray-300">Заявка одобрена</h5>
                                                    <p class="text-xs text-gray-500 mt-1">Уведомление об одобрении заявки на сервер</p>
                                                </div>
                                                <i class="fas fa-check-circle text-green-400"></i>
                                            </div>
                                        </div>

                                        <div class="template-selector p-4 bg-minecraft-gray/30 border border-minecraft-gold/20 rounded-lg hover:border-minecraft-gold/40 cursor-pointer transition-colors" data-template="application-rejected">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <h5 class="font-medium text-gray-300">Заявка отклонена</h5>
                                                    <p class="text-xs text-gray-500 mt-1">Уведомление об отклонении заявки с причиной</p>
                                                </div>
                                                <i class="fas fa-times-circle text-red-400"></i>
                                            </div>
                                        </div>

                                        <div class="template-selector p-4 bg-minecraft-gray/30 border border-minecraft-gold/20 rounded-lg hover:border-minecraft-gold/40 cursor-pointer transition-colors" data-template="password-reset">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <h5 class="font-medium text-gray-300">Сброс пароля</h5>
                                                    <p class="text-xs text-gray-500 mt-1">Письмо с ссылкой для восстановления пароля</p>
                                                </div>
                                                <i class="fas fa-key text-yellow-400"></i>
                                            </div>
                                        </div>

                                        <div class="template-selector p-4 bg-minecraft-gray/30 border border-minecraft-gold/20 rounded-lg hover:border-minecraft-gold/40 cursor-pointer transition-colors" data-template="newsletter">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <h5 class="font-medium text-gray-300">Новостная рассылка</h5>
                                                    <p class="text-xs text-gray-500 mt-1">Шаблон для массовых рассылок новостей</p>
                                                </div>
                                                <i class="fas fa-newspaper text-purple-400"></i>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Визуальный HTML редактор шаблонов -->
                                    <div id="template-editor" class="space-y-6">
                                        <div class="flex items-center justify-between">
                                            <h5 class="text-lg font-medium text-gray-300">Редактор шаблона: <span id="current-template-name">Приветственное письмо</span></h5>
                                            <div class="flex gap-3">
                                                <button id="preview-template-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                                                    <i class="fas fa-eye mr-2"></i>Предпросмотр
                                                </button>
                                            </div>
                                        </div>

                                        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                                            <div class="lg:col-span-3">
                                                <div class="space-y-4">
                                                    <div>
                                                        <label class="block text-sm font-medium text-gray-300 mb-2">Тема письма</label>
                                                        <input type="text" id="template-subject" 
                                                            class="setting-input w-full px-4 py-3 bg-minecraft-gray border border-minecraft-gold/30 rounded-lg text-white focus:border-minecraft-gold focus:outline-none transition-colors">
                                                    </div>
                                                    
                                                    <div>
                                                        <label class="block text-sm font-medium text-gray-300 mb-2">Содержание письма</label>
                                                        
                                                        <!-- Визуальный редактор -->
                                                        <div id="visual-editor-container" class="border border-minecraft-gold/30 rounded-lg overflow-hidden">
                                                            <div id="quill-editor" style="height: 500px; background: #2a2a2a; color: white;"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="space-y-6">
                                                <div>
                                                    <h6 class="text-sm font-medium text-gray-300 mb-3">Доступные переменные</h6>
                                                    <div class="space-y-2 text-xs max-h-60 overflow-y-auto">
                                                        <div class="p-2 bg-minecraft-gray/50 rounded border border-minecraft-gold/10 cursor-pointer hover:border-minecraft-gold/30 transition-colors" data-variable="serverName">
                                                            <code class="text-minecraft-gold">{{serverName}}</code><br>
                                                            <span class="text-gray-400">Название сервера</span>
                                                        </div>
                                                        <div class="p-2 bg-minecraft-gray/50 rounded border border-minecraft-gold/10 cursor-pointer hover:border-minecraft-gold/30 transition-colors" data-variable="nickname">
                                                            <code class="text-minecraft-gold">{{nickname}}</code><br>
                                                            <span class="text-gray-400">Ник пользователя</span>
                                                        </div>
                                                        <div class="p-2 bg-minecraft-gray/50 rounded border border-minecraft-gold/10 cursor-pointer hover:border-minecraft-gold/30 transition-colors" data-variable="email">
                                                            <code class="text-minecraft-gold">{{email}}</code><br>
                                                            <span class="text-gray-400">Email пользователя</span>
                                                        </div>
                                                        <div class="p-2 bg-minecraft-gray/50 rounded border border-minecraft-gold/10 cursor-pointer hover:border-minecraft-gold/30 transition-colors" data-variable="serverIp">
                                                            <code class="text-minecraft-gold">{{serverIp}}</code><br>
                                                            <span class="text-gray-400">IP сервера</span>
                                                        </div>
                                                        <div class="p-2 bg-minecraft-gray/50 rounded border border-minecraft-gold/10 cursor-pointer hover:border-minecraft-gold/30 transition-colors" data-variable="serverPort">
                                                            <code class="text-minecraft-gold">{{serverPort}}</code><br>
                                                            <span class="text-gray-400">Порт сервера</span>
                                                        </div>
                                                        <div class="p-2 bg-minecraft-gray/50 rounded border border-minecraft-gold/10 cursor-pointer hover:border-minecraft-gold/30 transition-colors" data-variable="discordInvite">
                                                            <code class="text-minecraft-gold">{{discordInvite}}</code><br>
                                                            <span class="text-gray-400">Discord приглашение</span>
                                                        </div>
                                                        <div class="p-2 bg-minecraft-gray/50 rounded border border-minecraft-gold/10 cursor-pointer hover:border-minecraft-gold/30 transition-colors" data-variable="telegramInvite">
                                                            <code class="text-minecraft-gold">{{telegramInvite}}</code><br>
                                                            <span class="text-gray-400">Telegram канал</span>
                                                        </div>
                                                        <div class="p-2 bg-minecraft-gray/50 rounded border border-minecraft-gold/10 cursor-pointer hover:border-minecraft-gold/30 transition-colors" data-variable="verificationLink">
                                                            <code class="text-minecraft-gold">{{verificationLink}}</code><br>
                                                            <span class="text-gray-400">Ссылка верификации</span>
                                                        </div>
                                                        <div class="p-2 bg-minecraft-gray/50 rounded border border-minecraft-gold/10 cursor-pointer hover:border-minecraft-gold/30 transition-colors" data-variable="resetLink">
                                                            <code class="text-minecraft-gold">{{resetLink}}</code><br>
                                                            <span class="text-gray-400">Ссылка сброса пароля</span>
                                                        </div>
                                                        <div class="p-2 bg-minecraft-gray/50 rounded border border-minecraft-gold/10 cursor-pointer hover:border-minecraft-gold/30 transition-colors" data-variable="currentDate">
                                                            <code class="text-minecraft-gold">{{currentDate}}</code><br>
                                                            <span class="text-gray-400">Текущая дата</span>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div>
                                                    <h6 class="text-sm font-medium text-gray-300 mb-3">Быстрые блоки</h6>
                                                    <div class="space-y-2">
                                                        <button class="w-full text-left p-2 bg-minecraft-gray/50 rounded border border-minecraft-gold/10 hover:border-minecraft-gold/30 transition-colors text-xs" data-quick-block="header">
                                                            <i class="fas fa-heading mr-2"></i>Заголовок письма
                                                        </button>
                                                        <button class="w-full text-left p-2 bg-minecraft-gray/50 rounded border border-minecraft-gold/10 hover:border-minecraft-gold/30 transition-colors text-xs" data-quick-block="button">
                                                            <i class="fas fa-mouse-pointer mr-2"></i>Кнопка действия
                                                        </button>
                                                        <button class="w-full text-left p-2 bg-minecraft-gray/50 rounded border border-minecraft-gold/10 hover:border-minecraft-gold/30 transition-colors text-xs" data-quick-block="separator">
                                                            <i class="fas fa-minus mr-2"></i>Разделитель
                                                        </button>
                                                        <button class="w-full text-left p-2 bg-minecraft-gray/50 rounded border border-minecraft-gold/10 hover:border-minecraft-gold/30 transition-colors text-xs" data-quick-block="footer">
                                                            <i class="fas fa-copyright mr-2"></i>Подвал письма
                                                        </button>
                                                        <button class="w-full text-left p-2 bg-minecraft-gray/50 rounded border border-minecraft-gold/10 hover:border-minecraft-gold/30 transition-colors text-xs" data-quick-block="social">
                                                            <i class="fas fa-share-alt mr-2"></i>Соц. сети
                                                        </button>
                                                    </div>
                                                </div>

                                                <div>
                                                    <h6 class="text-sm font-medium text-gray-300 mb-3">Действия</h6>
                                                    <div class="space-y-2">
                                                        <button id="save-template-btn" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-3 rounded-lg text-sm transition-colors">
                                                            <i class="fas fa-save mr-2"></i>Сохранить шаблон
                                                        </button>
                                                        <button id="reset-template-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-2 px-3 rounded-lg text-sm transition-colors">
                                                            <i class="fas fa-undo mr-2"></i>Сбросить изменения
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Кнопки управления -->
                        <div class="mt-12 flex justify-center space-x-4 border-t border-gray-700 pt-8">
                            <button id="reset-settings-btn" class="bg-gray-600 hover:bg-gray-700 text-white px-8 py-3 rounded-lg font-medium transition-colors">
                                <i class="fas fa-undo mr-2"></i>
                                Сбросить к умолчанию
                            </button>
                            <button id="save-settings-btn" class="btn-minecraft px-12 py-3 rounded-lg font-medium">
                                <i class="fas fa-save mr-2"></i>
                                Сохранить все настройки
                            </button>
                        </div>
                    </div>

                    <!-- Техническое -->
                    <div id="tab-technical" class="admin-tab-content hidden">
                        <h3 class="text-lg font-semibold text-white mb-6">Техническая информация</h3>
                        
                        <div class="grid md:grid-cols-2 gap-8">
                            <!-- База данных -->
                            <div class="glass-effect rounded-lg p-6">
                                <h4 class="font-medium text-white mb-4">
                                    <i class="fas fa-database mr-2"></i>База данных
                                </h4>
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Хост:</span>
                                        <span class="font-mono text-white">localhost/212.15.49.139</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Пользователь:</span>
                                        <span class="font-mono text-white">chiwawa</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">База данных:</span>
                                        <span class="font-mono text-white">chiwawa</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Статус:</span>
                                        <span class="text-green-400 font-medium">Подключена</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Таблиц:</span>
                                        <span class="font-medium text-white">15</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Сервер -->
                            <div class="glass-effect rounded-lg p-6">
                                <h4 class="font-medium text-white mb-4">
                                    <i class="fas fa-server mr-2"></i>Сервер
                                </h4>
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Node.js версия:</span>
                                        <span class="font-mono text-white" id="node-version">Loading...</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Время работы:</span>
                                        <span class="font-mono text-white" id="uptime">Loading...</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Память (RSS):</span>
                                        <span class="font-mono text-white" id="memory-rss">Loading...</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Память (Heap):</span>
                                        <span class="font-mono text-white" id="memory-heap">Loading...</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Порт:</span>
                                        <span class="font-mono text-white">3000</span>
                                    </div>
                                </div>
                            </div>

                            <!-- API статистика -->
                            <div class="glass-effect rounded-lg p-6">
                                <h4 class="font-medium text-white mb-4">
                                    <i class="fas fa-chart-line mr-2"></i>API статистика
                                </h4>
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Всего запросов:</span>
                                        <span class="font-medium text-white" id="api-total-requests">Loading...</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Сегодня:</span>
                                        <span class="font-medium text-white" id="api-today-requests">Loading...</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Активных пользователей:</span>
                                        <span class="font-medium text-green-400" id="api-active-users">Loading...</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Последняя активность:</span>
                                        <span class="font-medium text-blue-400" id="api-last-activity">Loading...</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Конфигурация -->
                            <div class="glass-effect rounded-lg p-6">
                                <h4 class="font-medium text-white mb-4">
                                    <i class="fas fa-cogs mr-2"></i>Конфигурация
                                </h4>
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Режим:</span>
                                        <span class="font-mono text-white">development</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">CORS:</span>
                                        <span class="text-green-400">Включен</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Email система:</span>
                                        <span class="text-green-400">Yandex SMTP</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-300">Загрузка файлов:</span>
                                        <span class="text-green-400">Активна</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Системная информация -->
                        <div class="mt-8">
                            <h4 class="font-medium text-white mb-4">
                                <i class="fas fa-info-circle mr-2"></i>Системная информация
                            </h4>
                            <div class="glass-effect rounded-lg p-6">
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div>
                                        <h5 class="text-sm font-medium text-gray-300 mb-3">Статус сервиса</h5>
                                        <div class="space-y-2 text-sm">
                                            <div class="flex items-center">
                                                <div class="w-2 h-2 bg-green-400 rounded-full mr-2"></div>
                                                <span class="text-gray-300">Web-сервер запущен</span>
                                            </div>
                                            <div class="flex items-center">
                                                <div class="w-2 h-2 bg-green-400 rounded-full mr-2"></div>
                                                <span class="text-gray-300">База данных подключена</span>
                                            </div>
                                            <div class="flex items-center">
                                                <div class="w-2 h-2 bg-green-400 rounded-full mr-2"></div>
                                                <span class="text-gray-300">Email система настроена</span>
                                            </div>
                                            <div class="flex items-center">
                                                <div class="w-2 h-2 bg-green-400 rounded-full mr-2"></div>
                                                <span class="text-gray-300">API маршруты работают</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h5 class="text-sm font-medium text-gray-300 mb-3">Быстрые действия</h5>
                                        <div class="space-y-2 text-sm">
                                            <div class="text-gray-400">• Перезапуск: npm start</div>
                                            <div class="text-gray-400">• Логи: проверьте консоль</div>
                                            <div class="text-gray-400">• Backup БД: pg_dump</div>
                                            <div class="text-gray-400">• Мониторинг: htop/Task Manager</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Логи -->
                    <div id="tab-logs" class="admin-tab-content hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold text-white">Системные логи</h3>
                            <div class="flex space-x-3">
                                <select id="log-action-filter" class="px-4 py-2 bg-minecraft-gray border border-minecraft-gold/20 rounded-lg text-white focus:border-minecraft-gold focus:outline-none">
                                    <option value="all">Все действия</option>
                                    <option value="user_moderation">Модерация пользователей</option>
                                    <option value="role_changed">Изменения ролей</option>
                                    <option value="trust_level_changed">Изменения Trust Level</option>
                                    <option value="settings_updated">Обновления настроек</option>
                                </select>
                                <button id="refresh-logs" class="px-4 py-2 bg-chiwawa-primary text-white rounded-lg hover:bg-chiwawa-dark transition-colors">
                                    <i class="fas fa-refresh mr-2"></i>Обновить
                                </button>
                            </div>
                        </div>
                        <div id="logs-list" class="space-y-2">
                            <div class="text-center py-8">
                                <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-2"></i>
                                <p class="text-gray-500">Загрузка логов...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальные окна -->
    <!-- Модальное окно подробной информации о пользователе -->
    <div id="user-details-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="glass-effect rounded-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-white">
                        <i class="fas fa-user-circle mr-2 text-minecraft-gold"></i>
                        Подробная информация о пользователе
                    </h3>
                    <button data-action="close-modal" data-modal="user-details-modal" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <!-- Основная информация -->
                <div class="space-y-4 mb-6">
                    <div class="grid md:grid-cols-3 gap-6">
                        <!-- Аватар и базовая информация -->
                        <div class="space-y-4">
                            <div class="text-center">
                                <div id="modal-user-avatar" class="w-20 h-20 mx-auto rounded-full overflow-hidden border-2 border-minecraft-gold/30 mb-3">
                                    <div class="w-full h-full bg-minecraft-gray flex items-center justify-center">
                                        <i class="fas fa-user text-minecraft-gold text-2xl"></i>
                                    </div>
                                </div>
                                <div class="text-white font-medium text-lg" id="modal-user-nickname">-</div>
                            </div>
                            <div>
                                <label class="text-sm text-gray-400">Email:</label>
                                <div class="text-white" id="modal-user-email">-</div>
                            </div>
                            <div>
                                <label class="text-sm text-gray-400">Роль:</label>
                                <div class="text-white" id="modal-user-role">-</div>
                            </div>
                        </div>
                        
                        <!-- Дополнительная информация -->
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm text-gray-400">Trust Level:</label>
                                <div class="text-white" id="modal-user-trust-level">-</div>
                            </div>
                            <div>
                                <label class="text-sm text-gray-400">Статус:</label>
                                <div id="modal-user-status">-</div>
                            </div>
                            <div>
                                <label class="text-sm text-gray-400">Возраст:</label>
                                <div class="text-white" id="modal-user-age">-</div>
                            </div>
                            <div>
                                <label class="text-sm text-gray-400">Discord:</label>
                                <div class="text-white" id="modal-user-discord">-</div>
                            </div>
                        </div>
                        
                        <!-- Дата и био -->
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm text-gray-400">Дата регистрации:</label>
                                <div class="text-white" id="modal-user-created">-</div>
                            </div>
                            <div>
                                <label class="text-sm text-gray-400">Биография:</label>
                                <div class="text-white text-sm max-h-20 overflow-y-auto" id="modal-user-bio">-</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Объединенный блок активности и статистики -->
                <div class="mb-6">
                    <!-- Вкладки переключения -->
                    <div class="flex space-x-1 mb-4">
                        <button class="modal-tab active px-4 py-2 rounded-md text-white bg-minecraft-gold/20 font-medium transition-all text-sm" data-tab="activity">
                            <i class="fas fa-globe mr-2"></i>Активность на сайте
                        </button>
                        <button class="modal-tab px-4 py-2 rounded-md text-gray-300 hover:text-white hover:bg-minecraft-gold/10 font-medium transition-all text-sm" data-tab="server">
                            <i class="fas fa-server mr-2"></i>Статистика с сервера
                        </button>
                    </div>
                    
                    <!-- Контент вкладок -->
                    <div class="bg-minecraft-dark/30 rounded-lg border border-minecraft-gold/20">
                        <!-- Вкладка "Активность на сайте" -->
                        <div id="modal-tab-activity" class="modal-tab-content max-h-60 overflow-y-auto p-3">
                            <div class="text-center py-4 text-gray-400" id="modal-user-activity">
                                <i class="fas fa-spinner fa-spin"></i>
                                <div class="mt-2">Загрузка активности...</div>
                            </div>
                        </div>
                        
                        <!-- Вкладка "Сервер" -->
                        <div id="modal-tab-server" class="modal-tab-content hidden">
                            <div class="space-y-4">
                                <!-- Основная информация -->
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div class="space-y-3">
                                        <div>
                                            <label class="text-sm text-gray-400">Статус на сервере:</label>
                                            <div class="text-green-400" id="modal-server-status">� Загрузка...</div>
                                        </div>
                                        <div>
                                            <label class="text-sm text-gray-400">Время игры:</label>
                                            <div class="text-white" id="modal-server-playtime">Загрузка...</div>
                                        </div>
                                        <div>
                                            <label class="text-sm text-gray-400">Последний заход:</label>
                                            <div class="text-white" id="modal-server-last-seen">Загрузка...</div>
                                        </div>
                                        <div>
                                            <label class="text-sm text-gray-400">Последние координаты:</label>
                                            <div class="text-white font-mono text-sm" id="modal-server-location">Загрузка...</div>
                                        </div>
                                        <div>
                                            <label class="text-sm text-gray-400">Всего входов:</label>
                                            <div class="text-white" id="modal-server-total-logins">Загрузка...</div>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-3">
                                        <div>
                                            <label class="text-sm text-gray-400">Уровень:</label>
                                            <div class="text-minecraft-gold" id="modal-server-level">Загрузка...</div>
                                        </div>
                                        <div>
                                            <label class="text-sm text-gray-400">Смертей:</label>
                                            <div class="text-red-400" id="modal-server-deaths">Загрузка...</div>
                                        </div>
                                        <div>
                                            <label class="text-sm text-gray-400">Убийств мобов:</label>
                                            <div class="text-white" id="modal-server-kills">Загрузка...</div>
                                        </div>
                                        <div>
                                            <label class="text-sm text-gray-400">Количество сессий:</label>
                                            <div class="text-white" id="modal-server-sessions">Загрузка...</div>
                                        </div>
                                        <div>
                                            <label class="text-sm text-gray-400">Средняя сессия:</label>
                                            <div class="text-white" id="modal-server-avg-session">Загрузка...</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Детальная статистика -->
                                <div class="mt-6">
                                    <h4 class="text-sm font-medium text-minecraft-gold mb-3">📊 Игровая статистика</h4>
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                        <div class="bg-minecraft-dark/20 rounded-lg p-3 text-center">
                                            <div class="text-lg font-bold text-white" id="modal-server-blocks-broken">0</div>
                                            <div class="text-xs text-gray-400">Блоков сломано</div>
                                        </div>
                                        <div class="bg-minecraft-dark/20 rounded-lg p-3 text-center">
                                            <div class="text-lg font-bold text-white" id="modal-server-blocks-placed">0</div>
                                            <div class="text-xs text-gray-400">Блоков поставлено</div>
                                        </div>
                                        <div class="bg-minecraft-dark/20 rounded-lg p-3 text-center">
                                            <div class="text-lg font-bold text-white" id="modal-server-distance">0 км</div>
                                            <div class="text-xs text-gray-400">Пройдено</div>
                                        </div>
                                        <div class="bg-minecraft-dark/20 rounded-lg p-3 text-center">
                                            <div class="text-lg font-bold text-white" id="modal-server-items-crafted">0</div>
                                            <div class="text-xs text-gray-400">Предметов создано</div>
                                        </div>
                                        <div class="bg-minecraft-dark/20 rounded-lg p-3 text-center">
                                            <div class="text-lg font-bold text-white" id="modal-server-damage-dealt">0</div>
                                            <div class="text-xs text-gray-400">Урона нанесено</div>
                                        </div>
                                        <div class="bg-minecraft-dark/20 rounded-lg p-3 text-center">
                                            <div class="text-lg font-bold text-white" id="modal-server-food-eaten">0</div>
                                            <div class="text-xs text-gray-400">Еды съедено</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Информация о сессиях -->
                                <div class="mt-4">
                                    <h4 class="text-sm font-medium text-minecraft-gold mb-3">⏱️ Сессии</h4>
                                    <div class="bg-minecraft-dark/30 rounded-lg p-4">
                                        <div class="grid grid-cols-2 gap-4 text-sm">
                                            <div>
                                                <span class="text-gray-400">Самая длинная сессия:</span>
                                                <div class="text-white font-medium" id="modal-server-longest-session">Загрузка...</div>
                                            </div>
                                            <div>
                                                <span class="text-gray-400">Среднее время сессии:</span>
                                                <div class="text-white font-medium" id="modal-server-avg-session">Загрузка...</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-4 text-xs text-gray-500 text-center">
                                    <i class="fas fa-database mr-1"></i>
                                    Данные получены из базы данных сервера Minecraft
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Кнопка закрытия -->
                    <div class="flex justify-center">
                        <button data-action="close-modal" data-modal="user-details-modal" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                            Закрыть
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно блокировки пользователя -->
    <div id="ban-user-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="glass-effect rounded-lg max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-white">
                        <i class="fas fa-ban mr-2 text-red-400"></i>
                        Заблокировать пользователя
                    </h3>
                    <button data-action="close-modal" data-modal="ban-user-modal" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-sm text-gray-400">Пользователь:</label>
                        <div class="text-white font-medium" id="ban-modal-user-nickname">-</div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Тип блокировки:</label>
                        <select id="ban-type" autocomplete="off" class="w-full px-3 py-2 bg-minecraft-gray border border-minecraft-gold/20 rounded-lg text-white focus:border-minecraft-gold focus:outline-none">
                            <option value="temporary">Временная</option>
                            <option value="permanent">Постоянная</option>
                        </select>
                    </div>
                    
                    <div id="ban-duration-container">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Длительность (дни):</label>
                        <input type="number" id="ban-duration" min="1" max="365" value="7" autocomplete="off"
                            class="w-full px-3 py-2 bg-minecraft-gray border border-minecraft-gold/20 rounded-lg text-white focus:border-minecraft-gold focus:outline-none">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Причина блокировки:</label>
                        <textarea id="ban-reason" rows="3" placeholder="Опишите причину блокировки..." required
                            autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
                            class="w-full px-3 py-2 bg-minecraft-gray border border-minecraft-gold/20 rounded-lg text-white placeholder-gray-400 focus:border-minecraft-gold focus:outline-none resize-none"></textarea>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button data-action="close-modal" data-modal="ban-user-modal" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                        Отмена
                    </button>
                    <button id="confirm-ban-btn" data-action="confirm-ban-user" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors">
                        Заблокировать
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно удаления пользователя -->
    <div id="delete-user-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="glass-effect rounded-lg max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-white">
                        <i class="fas fa-exclamation-triangle mr-2 text-red-500"></i>
                        Удалить пользователя
                    </h3>
                    <button data-action="close-modal" data-modal="delete-user-modal" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div class="bg-red-900/30 border border-red-500/50 rounded-lg p-4">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-exclamation-triangle text-red-400 text-2xl"></i>
                            <div>
                                <h4 class="text-red-300 font-semibold">ВНИМАНИЕ!</h4>
                                <p class="text-red-200 text-sm">Это действие нельзя отменить!</p>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="text-sm text-gray-400">Пользователь для удаления:</label>
                        <div class="text-white font-medium" id="delete-modal-user-nickname">-</div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Причина удаления:</label>
                        <textarea id="delete-reason" rows="3" placeholder="Обязательно укажите причину удаления аккаунта..." required
                            autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
                            class="w-full px-3 py-2 bg-minecraft-gray border border-minecraft-gold/20 rounded-lg text-white placeholder-gray-400 focus:border-minecraft-gold focus:outline-none resize-none"></textarea>
                    </div>
                    
                    <div class="bg-yellow-900/30 border border-yellow-500/50 rounded-lg p-3">
                        <p class="text-yellow-300 text-sm">
                            <i class="fas fa-info-circle mr-2"></i>
                            При удалении будут удалены все данные пользователя: сессии, логи, заявки, статистика и все связанные записи.
                        </p>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button data-action="close-modal" data-modal="delete-user-modal" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                        Отмена
                    </button>
                    <button id="confirm-delete-btn" data-action="confirm-delete-user" class="px-4 py-2 bg-red-700 hover:bg-red-800 text-white rounded-lg font-medium transition-colors">
                        <i class="fas fa-trash-alt mr-2"></i>
                        Удалить навсегда
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно изменения роли -->
    <div id="change-role-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="glass-effect rounded-lg max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-white">
                        <i class="fas fa-user-tag mr-2 text-minecraft-gold"></i>
                        Изменить роль пользователя
                    </h3>
                    <button data-action="close-modal" data-modal="change-role-modal" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-sm text-gray-400">Пользователь:</label>
                        <div class="text-white font-medium" id="role-modal-user-nickname">-</div>
                    </div>
                    
                    <div>
                        <label class="text-sm text-gray-400">Текущая роль:</label>
                        <div class="text-white" id="role-modal-current-role">-</div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Новая роль:</label>
                        <select id="role-select" autocomplete="off" class="w-full px-3 py-2 bg-minecraft-gray border border-minecraft-gold/20 rounded-lg text-white focus:border-minecraft-gold focus:outline-none">
                            <option value="user">Пользователь</option>
                            <option value="moderator">Модератор</option>
                            <option value="admin">Администратор</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Причина изменения:</label>
                        <textarea id="role-change-reason" rows="3" placeholder="Опишите причину изменения роли..." 
                            autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
                            class="w-full px-3 py-2 bg-minecraft-gray border border-minecraft-gold/20 rounded-lg text-white placeholder-gray-400 focus:border-minecraft-gold focus:outline-none resize-none"></textarea>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button data-action="close-modal" data-modal="change-role-modal" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                        Отмена
                    </button>
                    <button data-action="update-user-role" class="px-4 py-2 bg-minecraft-gold hover:bg-yellow-600 text-minecraft-dark rounded-lg font-medium transition-colors">
                        Изменить роль
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Футер -->
    <footer class="glass-effect border-t border-minecraft-gold/30 py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <p class="text-gray-400">
                    Chiwawa © 2025, Создано с 
                    <span class="text-minecraft-gold">❤️</span> от 
                    <strong class="text-minecraft-yellow">ebluffy</strong>
                </p>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script>
        let currentUser = null;
        let quillEditor = null;
        let isVisualMode = true;
        
        // Функция для показа уведомлений
        function showNotification(type, message, duration = 5000) {
            // Создаем контейнер для уведомлений если его нет
            let container = document.getElementById('notification-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notification-container';
                container.className = 'fixed top-4 right-4 z-50 space-y-2';
                document.body.appendChild(container);
            }
            
            // Создаем уведомление
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';
            const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';
            
            notification.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 ease-in-out opacity-0 translate-x-full`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${icon} mr-3"></i>
                    <span class="text-sm font-medium">${message}</span>
                    <button data-action="remove-notification" class="ml-4 text-white/80 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Анимация появления
            setTimeout(() => {
                notification.classList.remove('opacity-0', 'translate-x-full');
            }, 100);
            
            // Автоматическое скрытие
            setTimeout(() => {
                notification.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, duration);
        }
        
        // Управление выпадающим меню профиля
        function toggleProfileDropdown() {
            const profileDropdown = document.getElementById('profileDropdown');
            profileDropdown.classList.toggle('hidden');
        }
        
        // Функция выхода
        function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('remember_me');
            localStorage.removeItem('token_expires');
            window.location.href = '/';
        }
        
        // Инициализация обработчиков событий при загрузке DOM
        function initializeEventHandlers() {
            // Обработчик кнопки профиля
            const profileButton = document.getElementById('profile-dropdown-btn');
            if (profileButton) {
                profileButton.addEventListener('click', toggleProfileDropdown);
            }
            
            // Обработчик кнопки выхода в dropdown
            const logoutButton = document.getElementById('logout-dropdown-btn');
            if (logoutButton) {
                logoutButton.addEventListener('click', logout);
            }
            
            // Закрытие меню при клике вне его
            document.addEventListener('click', function(event) {
                const profileDropdown = document.getElementById('profileDropdown');
                const profileButton = document.getElementById('profile-dropdown-btn');
                
                if (profileButton && !profileButton.contains(event.target) && !profileDropdown.contains(event.target)) {
                    profileDropdown.classList.add('hidden');
                }
                
                // Закрытие модальных окон при клике вне их
                if (event.target.classList.contains('fixed') && event.target.classList.contains('bg-black')) {
                    const modalId = event.target.id;
                    if (modalId) {
                        closeModal(modalId);
                    }
                }
            });
            
            // Делегирование событий для динамических кнопок
            document.addEventListener('click', function(event) {
                const target = event.target;
                
                // Кнопки одобрения/отклонения заявок
                if (target.matches('[data-action="approve-app"]')) {
                    const appId = target.getAttribute('data-app-id');
                    reviewApplication(appId, 'approved');
                } else if (target.matches('[data-action="reject-app"]')) {
                    const appId = target.getAttribute('data-app-id');
                    reviewApplication(appId, 'rejected');
                }
                
                // Кнопки для пользователей
                else if (target.matches('[data-action="show-user-details"]')) {
                    const userId = target.getAttribute('data-user-id');
                    showUserDetails(userId);
                } else if (target.matches('[data-action="ban-user"]')) {
                    const userId = target.getAttribute('data-user-id');
                    const nickname = target.getAttribute('data-user-nickname');
                    banUser(userId, nickname);
                } else if (target.matches('[data-action="unban-user"]')) {
                    const userId = target.getAttribute('data-user-id');
                    const nickname = target.getAttribute('data-user-nickname');
                    unbanUser(userId, nickname);
                } else if (target.matches('[data-action="delete-user"]')) {
                    const userId = target.getAttribute('data-user-id');
                    const nickname = target.getAttribute('data-user-nickname');
                    deleteUser(userId, nickname);
                }
                
                // Trust Level заявки
                else if (target.matches('[data-action="approve-trust-app"]')) {
                    const appId = target.getAttribute('data-app-id');
                    reviewTrustApplication(appId, 'approved');
                } else if (target.matches('[data-action="reject-trust-app"]')) {
                    const appId = target.getAttribute('data-app-id');
                    reviewTrustApplication(appId, 'rejected');
                }
                
                // Кнопки закрытия модалов
                else if (target.matches('[data-action="close-modal"]') || target.closest('[data-action="close-modal"]')) {
                    const closeButton = target.matches('[data-action="close-modal"]') ? target : target.closest('[data-action="close-modal"]');
                    const modalId = closeButton.getAttribute('data-modal');
                    closeModal(modalId);
                }
                
                // Кнопки в модалах
                else if (target.matches('[data-action="update-user-role"]')) {
                    updateUserRole();
                } else if (target.matches('[data-action="confirm-ban-user"]')) {
                    confirmBanUser();
                } else if (target.matches('[data-action="confirm-delete-user"]')) {
                    confirmDeleteUser();
                }
                
                // Вкладки в модальном окне пользователя
                else if (target.matches('.modal-tab')) {
                    const tabName = target.getAttribute('data-tab');
                    switchModalTab(tabName);
                }
            });
            
            // Делегирование для select элементов
            document.addEventListener('change', function(event) {
                const target = event.target;
                
                // Изменение типа блокировки
                if (target.id === 'ban-type') {
                    const durationContainer = document.getElementById('ban-duration-container');
                    const confirmBtn = document.getElementById('confirm-ban-btn');
                    
                    if (target.value === 'permanent' || target.value === 'delete') {
                        durationContainer.style.display = 'none';
                    } else {
                        durationContainer.style.display = 'block';
                    }
                    
                    // Изменяем текст кнопки для удаления аккаунта
                    if (target.value === 'delete') {
                        confirmBtn.textContent = 'УДАЛИТЬ АККАУНТ';
                        confirmBtn.className = 'px-4 py-2 bg-red-800 hover:bg-red-900 text-white rounded-lg font-medium transition-colors';
                    } else {
                        confirmBtn.textContent = 'Заблокировать';
                        confirmBtn.className = 'px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors';
                    }
                }
                
                // Изменение роли через выпадающий список
                if (target.matches('[data-action="change-user-role"]')) {
                    const userId = target.getAttribute('data-user-id');
                    const nickname = target.getAttribute('data-user-nickname');
                    const newRole = target.value;
                    changeUserRoleSelect(userId, nickname, newRole);
                }
                
                if (target.matches('[data-action="change-trust-level"]')) {
                    const userId = target.getAttribute('data-user-id');
                    const newLevel = target.value;
                    changeTrustLevel(userId, newLevel);
                }
            });
        }
        
        // Глобальная переменная для хранения настроек сервера
        let serverSettings = {
            name: 'Chiwawa',
            description: 'Приватный Minecraft сервер с дружелюбным сообществом',
            ip: 'play.chiwawa.site',
            port: '25164',
            discordInvite: 'https://discord.gg/chiwawa',
            telegramInvite: 'https://t.me/chiwawa'
        };

        // Функция загрузки настроек сервера
        async function loadServerSettings() {
            try {
                const response = await fetch('/api/settings/public');
                if (response.ok) {
                    const settings = await response.json();
                    
                    // Обновляем глобальные настройки
                    serverSettings.name = settings.serverName || serverSettings.name;
                    serverSettings.description = settings.serverDescription || serverSettings.description;
                    serverSettings.ip = settings.serverIp || serverSettings.ip;
                    serverSettings.port = settings.serverPort || serverSettings.port;
                    serverSettings.discordInvite = settings.discordInvite || serverSettings.discordInvite;
                    serverSettings.telegramInvite = settings.telegramInvite || serverSettings.telegramInvite;
                    
                    // Обновляем элементы на странице
                    updateServerElements();
                }
            } catch (error) {
                console.error('Ошибка загрузки настроек сервера:', error);
            }
        }

        // Функция обновления элементов на странице
        function updateServerElements() {
            // Обновляем название сервера в навигации
            const serverNameNav = document.getElementById('server-name');
            if (serverNameNav) {
                serverNameNav.textContent = serverSettings.name;
            }
            
            // Обновляем заголовок страницы
            document.title = `Админ-панель - ${serverSettings.name}`;
        }

        // Проверка доступа при загрузке
        document.addEventListener('DOMContentLoaded', async () => {
            // Инициализируем обработчики событий
            initializeEventHandlers();
            
            const token = localStorage.getItem('auth_token');
            if (!token) {
                window.location.href = '/profile';
                return;
            }

            try {
                const response = await fetch('/api/auth/verify', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    currentUser = userData.user;
                    console.log('Данные пользователя в админ панели:', userData.user);
                    
                    // Обновляем отображение никнейма админа
                    const adminNickname = document.getElementById('admin-nickname');
                    if (adminNickname && userData.user) {
                        adminNickname.textContent = userData.user.nickname || userData.user.email || 'Admin';
                    }
                    
                    // Проверяем права администратора
                    if (currentUser.role !== 'admin' && currentUser.role !== 'moderator') {
                        console.log('Доступ запрещен. Роль пользователя:', currentUser.role);
                        document.getElementById('access-denied').classList.remove('hidden');
                        return;
                    }
                    
                    document.getElementById('admin-content').classList.remove('hidden');
                    
                    // Загружаем настройки сервера и статистику
                    await loadServerSettings();
                    await loadDashboard();
                } else {
                    window.location.href = '/profile';
                }
            } catch (error) {
                console.error('Ошибка проверки доступа:', error);
                window.location.href = '/profile';
            }
        });

        // Выход
        document.addEventListener('DOMContentLoaded', () => {
            // Переключение вкладок
            document.querySelectorAll('.admin-tab').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.dataset.tab;
                    
                    // Убираем активность с всех кнопок и контента
                    document.querySelectorAll('.admin-tab').forEach(b => {
                        b.classList.remove('active', 'border-minecraft-gold', 'text-minecraft-gold');
                        b.classList.add('border-transparent', 'text-gray-300');
                    });
                    document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.add('hidden'));
                    
                    // Активируем текущую вкладку
                    btn.classList.remove('border-transparent', 'text-gray-300');
                    btn.classList.add('active', 'border-minecraft-gold', 'text-minecraft-gold');
                    document.getElementById(`tab-${tabId}`).classList.remove('hidden');
                    
                    // Загружаем данные для вкладки
                    switch(tabId) {
                        case 'applications':
                            loadApplications();
                            break;
                        case 'users':
                            loadUsers();
                            break;
                        case 'trust-levels':
                            loadTrustLevels();
                            break;
                        case 'settings':
                            loadSettings();
                            break;
                        case 'technical':
                            loadTechnicalInfo();
                            break;
                        case 'logs':
                            loadLogs();
                            break;
                    }
                });
            });

            // Фильтры
            document.getElementById('app-status-filter')?.addEventListener('change', loadApplications);
            document.getElementById('user-status-filter')?.addEventListener('change', loadUsers);
            document.getElementById('user-search')?.addEventListener('input', debounce(loadUsers, 500));
            document.getElementById('trust-app-status-filter')?.addEventListener('change', loadTrustApplications);
            document.getElementById('log-action-filter')?.addEventListener('change', loadLogs);
            document.getElementById('refresh-logs')?.addEventListener('click', loadLogs);

            // Кнопка сохранения настроек
            document.getElementById('save-settings-btn')?.addEventListener('click', saveSettings);
            
            // Кнопка сброса настроек
            document.getElementById('reset-settings-btn')?.addEventListener('click', resetSettings);
            
            // Инициализация визуального редактора
            initializeQuillEditor();
            
            // Переключатели режимов редактора
            document.getElementById('visual-mode-btn')?.addEventListener('click', switchToVisualMode);
            document.getElementById('html-mode-btn')?.addEventListener('click', switchToHtmlMode);
            
            // Обработчики для кнопок показа пароля
            document.querySelectorAll('.password-toggle-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    togglePasswordVisibility(targetId);
                });
            });
            
            // Отключаем автозаполнение для всех полей настроек
            disableAutocomplete();
            
            // Заменяем тестовые данные на настройки сервера
            replaceTestDataWithServerSettings();
        });
        
        // Функция отключения автозаполнения
        function disableAutocomplete() {
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.setAttribute('autocomplete', 'off');
                input.setAttribute('data-form-type', 'other');
                
                // Для паролей используем new-password
                if (input.type === 'password') {
                    input.setAttribute('autocomplete', 'new-password');
                }
            });
        }
        
        // Функция замены тестовых данных на настройки сервера
        function replaceTestDataWithServerSettings() {
            // Загружаем настройки сервера и заменяем placeholder'ы
            fetch('/api/settings/public')
                .then(response => response.json())
                .then(data => {
                    if (data.serverName && data.serverName !== 'ChiwawaTest') {
                        // Заменяем ChiwawaTest на реальное имя сервера во всех шаблонах
                        replaceTestDataInTemplates('ChiwawaTest', data.serverName);
                        replaceTestDataInTemplates('chiwawatest', data.serverName.toLowerCase());
                    }
                    
                    if (data.serverIp && data.serverIp !== 'test.chiwawa.site') {
                        replaceTestDataInTemplates('test.chiwawa.site', data.serverIp);
                    }
                })
                .catch(error => {
                    console.warn('Не удалось загрузить настройки сервера для замены тестовых данных:', error);
                });
        }
        
        // Функция замены тестовых данных в шаблонах
        function replaceTestDataInTemplates(searchText, replaceText) {
            // Заменяем в default шаблонах
            Object.keys(window.defaultTemplates || {}).forEach(templateKey => {
                const template = window.defaultTemplates[templateKey];
                if (template.html) {
                    template.html = template.html.replace(new RegExp(searchText, 'gi'), replaceText);
                }
                if (template.subject) {
                    template.subject = template.subject.replace(new RegExp(searchText, 'gi'), replaceText);
                }
            });
            
            // Обновляем текущий шаблон если он загружен
            const templateHtml = document.getElementById('template-html');
            const templateSubject = document.getElementById('template-subject');
            
            if (templateHtml && templateHtml.value.includes(searchText)) {
                templateHtml.value = templateHtml.value.replace(new RegExp(searchText, 'gi'), replaceText);
            }
            
            if (templateSubject && templateSubject.value.includes(searchText)) {
                templateSubject.value = templateSubject.value.replace(new RegExp(searchText, 'gi'), replaceText);
            }
        }

        // Вспомогательная функция debounce для поиска
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Функции для работы с модальными окнами
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }
        }

        // Функция переключения вкладок в модальном окне
        function switchModalTab(tabName) {
            // Убираем активность со всех вкладок
            document.querySelectorAll('.modal-tab').forEach(tab => {
                tab.classList.remove('active', 'bg-minecraft-gold/20', 'text-white');
                tab.classList.add('text-gray-300');
            });
            
            // Скрываем все содержимые вкладок
            document.querySelectorAll('.modal-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Активируем выбранную вкладку
            const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeTab) {
                activeTab.classList.add('active', 'bg-minecraft-gold/20', 'text-white');
                activeTab.classList.remove('text-gray-300');
            }
            
            // Показываем соответствующий контент
            const activeContent = document.getElementById(`modal-tab-${tabName}`);
            if (activeContent) {
                activeContent.classList.remove('hidden');
            }
            
            // Если переключились на вкладку "Сервер", загружаем данные
            if (tabName === 'server') {
                loadServerStats(currentUserId);
            }
        }

        // Функция загрузки статистики сервера для пользователя
        async function loadServerStats(userId) {
            if (!userId) {
                console.error('User ID не предоставлен для загрузки статистики сервера');
                return;
            }

            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch(`/api/admin/users/${userId}/stats`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Ошибка получения статистики');
                }

                const stats = await response.json();
                updateServerStatisticsDisplay(stats);

            } catch (error) {
                console.error('Ошибка загрузки статистики сервера:', error);
                showDefaultServerStats();
            }
        }

        // Функция обновления отображения статистики сервера
        function updateServerStatisticsDisplay(stats) {
            // Безопасно обновляем элементы, проверяя их существование
            const updateElement = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                } else {
                    console.warn(`Элемент с ID '${id}' не найден`);
                }
            };

            const updateElementHTML = (id, html) => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = html;
                } else {
                    console.warn(`Элемент с ID '${id}' не найден`);
                }
            };

            // Основная информация
            updateElement('modal-server-playtime', formatMinutesToTime(stats.time_played_minutes || 0));
            updateElement('modal-server-last-seen', formatTimeAgo(stats.last_login));
            updateElement('modal-server-location', `x: ${stats.last_x || 0}, y: ${stats.last_y || 64}, z: ${stats.last_z || 0}`);
            updateElement('modal-server-total-logins', (stats.total_logins || 0).toLocaleString());
            updateElement('modal-server-level', `Level ${stats.player_level || 1}`);
            updateElement('modal-server-deaths', (stats.deaths || 0).toLocaleString());
            updateElement('modal-server-kills', (stats.mob_kills || 0).toLocaleString());
            updateElement('modal-server-sessions', (stats.session_count || 0).toLocaleString());
            
            // Средняя сессия
            const avgSessionMinutes = stats.session_count > 0 ? (stats.time_played_minutes / stats.session_count) : 0;
            updateElement('modal-server-avg-session', formatMinutesToTime(avgSessionMinutes));
            updateElement('modal-server-avg-session-2', formatMinutesToTime(avgSessionMinutes));

            // Игровая статистика
            updateElement('modal-server-blocks-broken', (stats.blocks_broken || 0).toLocaleString());
            updateElement('modal-server-blocks-placed', (stats.blocks_placed || 0).toLocaleString());
            updateElement('modal-server-distance', `${((stats.distance_traveled || 0) / 1000).toFixed(1)} км`);
            updateElement('modal-server-items-crafted', (stats.items_crafted || 0).toLocaleString());
            updateElement('modal-server-damage-dealt', (stats.damage_dealt || 0).toLocaleString());
            updateElement('modal-server-food-eaten', (stats.food_eaten || 0).toLocaleString());
            
            // Самая длинная сессия (пока используем среднюю)
            updateElement('modal-server-longest-session', formatMinutesToTime(avgSessionMinutes * 1.5));
        }

        // Функция показа данных по умолчанию при ошибке
        function showDefaultServerStats() {
            const defaultMessage = 'Нет данных';
            
            const updateElement = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            };

            const updateElementHTML = (id, html) => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = html;
                }
            };

            updateElement('modal-server-playtime', '0м');
            updateElement('modal-server-last-seen', 'Никогда');
            updateElement('modal-server-location', 'x: 0, y: 64, z: 0');
            updateElement('modal-server-total-logins', '0');
            updateElement('modal-server-level', 'Level 1');
            updateElement('modal-server-deaths', '0');
            updateElement('modal-server-kills', '0');
            updateElement('modal-server-sessions', '0');
            updateElement('modal-server-avg-session', '0м');
            updateElement('modal-server-avg-session-2', '0м');
            updateElement('modal-server-blocks-broken', '0');
            updateElement('modal-server-blocks-placed', '0');
            updateElement('modal-server-distance', '0 км');
            updateElement('modal-server-items-crafted', '0');
            updateElement('modal-server-damage-dealt', '0');
            updateElement('modal-server-food-eaten', '0');
            updateElement('modal-server-longest-session', '0м');
        }

        // Вспомогательные функции
        function formatMinutesToTime(minutes) {
            if (!minutes || minutes === 0) return '0м';
            
            const hours = Math.floor(minutes / 60);
            const mins = Math.floor(minutes % 60);
            
            if (hours > 0) {
                return `${hours}ч ${mins}м`;
            }
            return `${mins}м`;
        }

        function formatTimeAgo(dateString) {
            if (!dateString) return 'Никогда';
            
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            
            if (diffMinutes < 1) return 'Только что';
            if (diffMinutes < 60) return `${diffMinutes}м назад`;
            
            const diffHours = Math.floor(diffMinutes / 60);
            if (diffHours < 24) return `${diffHours}ч назад`;
            
            const diffDays = Math.floor(diffHours / 24);
            if (diffDays < 7) return `${diffDays}д назад`;
            
            const diffWeeks = Math.floor(diffDays / 7);
            if (diffWeeks < 4) return `${diffWeeks}нед назад`;
            
            const diffMonths = Math.floor(diffDays / 30);
            return `${diffMonths}мес назад`;
        }

        function isRecentlyActive(lastLoginString) {
            if (!lastLoginString) return false;
            
            const lastLogin = new Date(lastLoginString);
            const now = new Date();
            const diffMinutes = (now - lastLogin) / (1000 * 60);
            
            return diffMinutes < 5; // Считаем онлайн если был активен в последние 5 минут
        }

        // Вспомогательная функция для форматирования времени (оставляем для совместимости)
        function getTimeAgoText(minutes) {
            if (minutes < 60) return `${minutes} мин назад`;
            if (minutes < 1440) return `${Math.floor(minutes / 60)}ч назад`;
            return `${Math.floor(minutes / 1440)}д назад`;
        }

        // Глобальные переменные для хранения данных модальных окон
        let currentUserId = null;

        // Функция показа подробной информации о пользователе
        async function showUserDetails(userId) {
            currentUserId = userId;
            
            // Сначала открываем модальное окно с загрузкой
            openModal('user-details-modal');
            
            // Сбрасываем содержимое на состояние загрузки
            document.getElementById('modal-user-nickname').textContent = 'Загрузка...';
            document.getElementById('modal-user-email').textContent = 'Загрузка...';
            document.getElementById('modal-user-role').textContent = 'Загрузка...';
            document.getElementById('modal-user-trust-level').textContent = 'Загрузка...';
            document.getElementById('modal-user-status').innerHTML = 'Загрузка...';
            document.getElementById('modal-user-created').textContent = 'Загрузка...';
            document.getElementById('modal-user-age').textContent = 'Загрузка...';
            document.getElementById('modal-user-discord').textContent = 'Загрузка...';
            document.getElementById('modal-user-bio').textContent = 'Загрузка...';
            document.getElementById('modal-user-avatar').innerHTML = '<div class="w-full h-full bg-minecraft-gray flex items-center justify-center"><i class="fas fa-spinner fa-spin text-minecraft-gold text-2xl"></i></div>';
            document.getElementById('modal-user-activity').innerHTML = '<div class="text-center py-4 text-gray-400"><i class="fas fa-spinner fa-spin"></i><div class="mt-2">Загрузка активности...</div></div>';
            
            // Инициализируем вкладку "Активность" как активную
            switchModalTab('activity');
            
            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch(`/api/admin/users/${userId}/details`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Ошибка получения данных пользователя');
                }

                const user = await response.json();
                
                // Заполняем модальное окно данными
                document.getElementById('modal-user-nickname').textContent = user.nickname || '-';
                document.getElementById('modal-user-email').textContent = user.email || '-';
                document.getElementById('modal-user-role').textContent = getRoleText(user.role);
                document.getElementById('modal-user-trust-level').textContent = `Уровень ${user.trust_level || 0}`;
                
                // Заполняем новые поля
                document.getElementById('modal-user-age').textContent = user.age ? `${user.age} лет` : 'Не указан';
                document.getElementById('modal-user-discord').textContent = user.discord_username || 'Не привязан';
                document.getElementById('modal-user-bio').textContent = user.bio || 'Не указана';
                
                // Аватар
                const avatarElement = document.getElementById('modal-user-avatar');
                if (user.avatar_url) {
                    avatarElement.innerHTML = `<img src="${user.avatar_url}" alt="Аватар ${user.nickname}" class="w-full h-full object-cover">`;
                } else {
                    avatarElement.innerHTML = '<div class="w-full h-full bg-minecraft-gray flex items-center justify-center"><i class="fas fa-user text-minecraft-gold text-2xl"></i></div>';
                }
                
                const statusElement = document.getElementById('modal-user-status');
                if (user.is_banned) {
                    let statusText = '<span class="text-red-400">Заблокирован</span>';
                    if (user.ban_reason) {
                        statusText += `<div class="text-sm text-red-300 mt-1">Причина: ${user.ban_reason}</div>`;
                    }
                    if (user.ban_until) {
                        const banDate = new Date(user.ban_until);
                        statusText += `<div class="text-sm text-red-300">До: ${banDate.toLocaleDateString('ru-RU')}</div>`;
                    }
                    statusElement.innerHTML = statusText;
                } else {
                    statusElement.innerHTML = '<span class="text-green-400">Активен</span>';
                }
                
                document.getElementById('modal-user-created').textContent = formatDate(user.registered_at);
                
                // Загружаем активность пользователя
                loadUserActivity(userId);
                
                // Загружаем статистику сервера
                loadServerStats(userId);
                
            } catch (error) {
                console.error('Ошибка загрузки данных пользователя:', error);
                
                // Показываем ошибку в модальном окне
                document.getElementById('modal-user-nickname').textContent = 'Ошибка загрузки';
                document.getElementById('modal-user-email').textContent = '-';
                document.getElementById('modal-user-role').textContent = '-';
                document.getElementById('modal-user-trust-level').textContent = '-';
                document.getElementById('modal-user-status').innerHTML = '<span class="text-red-400">Ошибка</span>';
                document.getElementById('modal-user-created').textContent = '-';
                document.getElementById('modal-user-activity').innerHTML = '<div class="text-red-400 text-sm">Ошибка загрузки данных пользователя</div>';
            }
        }

        // Функция загрузки активности пользователя
        async function loadUserActivity(userId) {
            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch(`/api/admin/users/${userId}/activity`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const activityContainer = document.getElementById('modal-user-activity');
                
                if (!response.ok) {
                    activityContainer.innerHTML = '<div class="text-red-400 text-sm">Ошибка загрузки активности</div>';
                    return;
                }

                const activityData = await response.json();
                
                // Объединяем сессии и логи входов в один массив активности
                const sessions = activityData.sessions || [];
                const loginLogs = activityData.loginLogs || [];
                
                const activities = [
                    ...sessions.map(session => ({
                        action: 'session',
                        created_at: session.created_at,
                        ip_address: session.ip_address,
                        details: `Сессия ${session.is_active ? 'активна' : 'завершена'}`
                    })),
                    ...loginLogs.map(log => ({
                        action: 'login',
                        created_at: log.login_time,
                        ip_address: log.ip_address,
                        details: log.success ? 'Успешный вход' : 'Неудачная попытка входа'
                    }))
                ].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                if (activities.length === 0) {
                    activityContainer.innerHTML = '<div class="text-gray-400 text-sm">Нет записей активности</div>';
                    return;
                }

                const activityHtml = activities.slice(0, 10).map(activity => `
                    <div class="flex justify-between items-center py-3 px-3 rounded-lg bg-minecraft-dark/20 border border-minecraft-gold/10 mb-2">
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0">
                                <i class="fas fa-circle text-xs ${getActivityColor(activity.action)}"></i>
                            </div>
                            <div>
                                <span class="text-sm text-white font-medium">${getActivityText(activity.action)}</span>
                                ${activity.details ? `<div class="text-xs text-gray-400 mt-1">${activity.details}</div>` : ''}
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-xs text-gray-400">${formatDate(activity.created_at)}</span>
                            ${activity.ip_address ? `<div class="text-xs text-gray-500 font-mono">${activity.ip_address}</div>` : ''}
                        </div>
                    </div>
                `).join('');
                
                activityContainer.innerHTML = activityHtml;
            } catch (error) {
                document.getElementById('modal-user-activity').innerHTML = 
                    '<div class="text-red-400 text-sm">Ошибка загрузки активности</div>';
            }
        }

        // Функция загрузки статистики сервера
        async function loadServerStats(userId) {
            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch(`/api/admin/users/${userId}/stats`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Ошибка получения статистики сервера');
                }

                const stats = await response.json();
                
                // Обновляем элементы статистики сервера
                const playtimeHours = Math.floor((stats.time_played_minutes || 0) / 60);
                const playtimeMinutes = (stats.time_played_minutes || 0) % 60;
                document.getElementById('modal-server-playtime').textContent = 
                    `${playtimeHours}ч ${playtimeMinutes}м`;
                
                document.getElementById('modal-server-last-seen').textContent = 
                    stats.last_seen ? formatTimeAgo(stats.last_seen) : 'Никогда';
                
                document.getElementById('modal-server-status').innerHTML = 
                    stats.last_seen && isRecentlyActive(stats.last_seen) 
                        ? '🟢 Недавно был онлайн' 
                        : '🔴 Офлайн';
                
                // Обновляем остальные поля
                document.getElementById('modal-server-level').textContent = 
                    `Level ${stats.current_level || 0}`;
                    
                document.getElementById('modal-server-deaths').textContent = 
                    stats.deaths_count || 0;
                    
                document.getElementById('modal-server-kills').textContent = 
                    stats.mobs_killed || 0;
                
                // Добавляем новые поля статистики
                updateServerStatisticsDisplay(stats);
                
            } catch (error) {
                console.error('Ошибка загрузки статистики сервера:', error);
                // Показываем демо-данные при ошибке
                showDefaultServerStats();
            }
        }
        
        // Функция обновления дисплея статистики сервера
        function updateServerStatisticsDisplay(stats) {
            // Обновляем все элементы статистики сервера реальными данными
            const elements = {
                'modal-server-blocks-broken': stats.blocks_broken || 0,
                'modal-server-blocks-placed': stats.blocks_placed || 0,
                'modal-server-distance': Math.floor((stats.distance_walked || 0) / 1000) + ' км',
                'modal-server-items-crafted': stats.items_crafted || 0,
                'modal-server-damage-dealt': stats.damage_dealt || 0,
                'modal-server-food-eaten': stats.food_eaten || 0,
                'modal-server-sessions': stats.session_count || 0,
                'modal-server-avg-session': formatMinutesToTime(stats.average_session_duration || 0),
                'modal-server-longest-session': formatMinutesToTime(stats.longest_session_duration || 0),
                'modal-server-total-logins': stats.total_logins || 0
            };
            
            // Обновляем элементы, если они существуют
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            });
            
            // Обновляем IP адрес если есть
            const ipElement = document.getElementById('modal-server-location');
            if (ipElement) {
                ipElement.textContent = stats.last_ip_address || 'Неизвестно';
            }
            
            // Обновляем дополнительную статистику из minecraft_stats
            if (stats.minecraft_stats) {
                const mcStats = typeof stats.minecraft_stats === 'string' 
                    ? JSON.parse(stats.minecraft_stats) 
                    : stats.minecraft_stats;
                    
                if (mcStats.favorite_block) {
                    const favBlockElement = document.getElementById('modal-server-favorite-block');
                    if (favBlockElement) {
                        favBlockElement.textContent = mcStats.favorite_block;
                    }
                }
            }
        }
        
        // Функция показа стандартных демо-данных при ошибке
        function showDefaultServerStats() {
            document.getElementById('modal-server-playtime').textContent = '0ч 0м';
            document.getElementById('modal-server-last-seen').textContent = 'Никогда';
            document.getElementById('modal-server-status').innerHTML = '🔴 Нет данных';
            document.getElementById('modal-server-level').textContent = 'Level 0';
            document.getElementById('modal-server-deaths').textContent = '0';
            document.getElementById('modal-server-kills').textContent = '0';
        }

        // Функция изменения роли пользователя
        async function changeUserRole(userId, nickname) {
            currentUserId = userId;
            
            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch(`/api/admin/users/${userId}/details`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Ошибка получения данных пользователя');
                }

                const user = await response.json();
                
                // Заполняем модальное окно
                document.getElementById('role-modal-user-nickname').textContent = nickname;
                document.getElementById('role-modal-current-role').textContent = getRoleText(user.role);
                document.getElementById('role-select').value = user.role;
                document.getElementById('role-change-reason').value = '';
                
                openModal('change-role-modal');
            } catch (error) {
                console.error('Ошибка:', error);
                alert('Ошибка загрузки данных пользователя');
            }
        }

        // Функция блокировки пользователя (ускоренная версия)
        async function banUser(userId, nickname) {
            // Сначала сразу открываем модальное окно
            openModal('ban-user-modal');
            
            const modal = document.getElementById('ban-user-modal');
            const nicknameElement = modal.querySelector('#ban-modal-user-nickname');
            const confirmBtn = modal.querySelector('#confirm-ban-btn');
            
            // Устанавливаем данные пользователя
            nicknameElement.textContent = nickname;
            confirmBtn.setAttribute('data-user-id', userId);
            
            // Сброс формы
            const banTypeSelect = modal.querySelector('#ban-type');
            const reasonTextarea = modal.querySelector('#ban-reason');
            const durationInput = modal.querySelector('#ban-duration');
            
            banTypeSelect.value = 'temporary';
            reasonTextarea.value = '';
            durationInput.value = '7';
            
            // Показываем секцию длительности
            modal.querySelector('#ban-duration-container').style.display = 'block';
            
            // Фокусируемся на поле причины для удобства
            setTimeout(() => {
                reasonTextarea.focus();
            }, 100);
        }

        // Функция подтверждения блокировки
        async function confirmBanUser() {
            const modal = document.getElementById('ban-user-modal');
            const banType = modal.querySelector('#ban-type').value;
            const reason = modal.querySelector('#ban-reason').value.trim();
            const confirmBtn = modal.querySelector('#confirm-ban-btn');
            const userId = confirmBtn.getAttribute('data-user-id');
            
            if (!reason) {
                showMessage('Пожалуйста, укажите причину блокировки', 'error');
                return;
            }
            
            if (!userId) {
                showMessage('Ошибка: не указан ID пользователя', 'error');
                return;
            }
            
            // Показываем индикатор загрузки
            const originalText = confirmBtn.innerHTML;
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Обработка...';
            confirmBtn.disabled = true;
            
            try {
                const token = localStorage.getItem('auth_token');
                let requestData = { reason, type: banType };
                
                // Для временной блокировки добавляем длительность
                if (banType === 'temporary') {
                    const duration = parseInt(modal.querySelector('#ban-duration').value);
                    requestData.duration = duration;
                    requestData.unit = 'days';
                }
                
                const response = await fetch(`/api/admin/users/${userId}/ban`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Ошибка выполнения операции');
                }

                const result = await response.json();
                showMessage(result.message || 'Операция выполнена успешно', 'success');
                closeModal('ban-user-modal');
                await loadUsers(); // Перезагружаем список пользователей
                await loadDashboard(); // Обновляем статистику
                
            } catch (error) {
                console.error('Ошибка операции:', error);
                showMessage('Ошибка: ' + error.message, 'error');
            } finally {
                // Восстанавливаем кнопку
                confirmBtn.innerHTML = originalText;
                confirmBtn.disabled = false;
            }
        }

        // Функция разблокировки пользователя
        async function unbanUser(userId, nickname) {
            if (!confirm(`Вы уверены, что хотите разблокировать пользователя ${nickname}?`)) {
                return;
            }
            
            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch(`/api/admin/users/${userId}/unban`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Ошибка разблокировки пользователя');
                }

                alert('Пользователь успешно разблокирован');
                await loadUsers(); // Перезагружаем список пользователей
            } catch (error) {
                console.error('Ошибка разблокировки:', error);
                alert('Ошибка разблокировки пользователя');
            }
        }

        // Функция удаления пользователя
        async function deleteUser(userId, nickname) {
            // Сразу открываем модальное окно подтверждения удаления
            openModal('delete-user-modal');
            
            const modal = document.getElementById('delete-user-modal');
            const nicknameElement = modal.querySelector('#delete-modal-user-nickname');
            const confirmBtn = modal.querySelector('#confirm-delete-btn');
            const reasonTextarea = modal.querySelector('#delete-reason');
            
            // Устанавливаем данные пользователя
            nicknameElement.textContent = nickname;
            confirmBtn.setAttribute('data-user-id', userId);
            
            // Сброс формы
            reasonTextarea.value = '';
            
            // Фокусируемся на поле причины для удобства
            setTimeout(() => {
                reasonTextarea.focus();
            }, 100);
        }

        // Функция подтверждения удаления пользователя
        async function confirmDeleteUser() {
            const modal = document.getElementById('delete-user-modal');
            const reason = modal.querySelector('#delete-reason').value.trim();
            const confirmBtn = modal.querySelector('#confirm-delete-btn');
            const userId = confirmBtn.getAttribute('data-user-id');
            
            if (!reason) {
                showMessage('Пожалуйста, укажите причину удаления', 'error');
                return;
            }
            
            if (reason.length < 5) {
                showMessage('Причина удаления должна содержать минимум 5 символов', 'error');
                return;
            }
            
            if (!userId) {
                showMessage('Ошибка: не указан ID пользователя', 'error');
                return;
            }
            
            // Показываем индикатор загрузки
            const originalText = confirmBtn.innerHTML;
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Удаление...';
            confirmBtn.disabled = true;
            
            try {
                const token = localStorage.getItem('auth_token');
                
                const response = await fetch(`/api/admin/users/${userId}/delete`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Ошибка удаления пользователя');
                }

                const result = await response.json();
                showMessage(result.message || 'Пользователь успешно удален', 'success');
                closeModal('delete-user-modal');
                await loadUsers(); // Перезагружаем список пользователей
                await loadDashboard(); // Обновляем статистику
                
            } catch (error) {
                console.error('Ошибка удаления:', error);
                showMessage('Ошибка: ' + error.message, 'error');
            } finally {
                // Восстанавливаем кнопку
                confirmBtn.innerHTML = originalText;
                confirmBtn.disabled = false;
            }
        }

        // Вспомогательные функции
        function getRoleText(role) {
            switch (role) {
                case 'admin': return 'Администратор';
                case 'moderator': return 'Модератор';
                case 'user': return 'Пользователь';
                default: return 'Неизвестно';
            }
        }

        function getActivityColor(action) {
            switch (action) {
                case 'login': return 'text-green-400';
                case 'logout': return 'text-gray-400';
                case 'application_submitted': return 'text-blue-400';
                case 'application_approved': return 'text-green-400';
                case 'application_rejected': return 'text-red-400';
                case 'user_banned': return 'text-red-400';
                case 'user_unbanned': return 'text-green-400';
                case 'role_changed': return 'text-yellow-400';
                case 'trust_level_changed': return 'text-minecraft-gold';
                case 'password_changed': return 'text-purple-400';
                case 'email_verified': return 'text-cyan-400';
                case 'profile_updated': return 'text-blue-300';
                default: return 'text-gray-400';
            }
        }

        function getActivityText(action) {
            switch (action) {
                case 'login': return 'Вход в систему';
                case 'logout': return 'Выход из системы';
                case 'application_submitted': return 'Подача заявки';
                case 'application_approved': return 'Заявка одобрена';
                case 'application_rejected': return 'Заявка отклонена';
                case 'user_banned': return 'Блокировка';
                case 'user_unbanned': return 'Разблокировка';
                case 'role_changed': return 'Изменение роли';
                case 'trust_level_changed': return 'Изменение Trust Level';
                case 'password_changed': return 'Смена пароля';
                case 'email_verified': return 'Подтверждение email';
                case 'profile_updated': return 'Обновление профиля';
                default: return action.replace(/_/g, ' ');
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('ru-RU');
        }

        // Функция для форматирования минут в читаемый формат
        function formatMinutesToTime(minutes) {
            if (!minutes || minutes === 0) return '0м';
            
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            
            if (hours === 0) return `${mins}м`;
            if (mins === 0) return `${hours}ч`;
            return `${hours}ч ${mins}м`;
        }

        // Функция для форматирования времени "назад"
        function formatTimeAgo(dateString) {
            if (!dateString) return 'Никогда';
            
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) return 'Только что';
            if (diffMins < 60) return `${diffMins} мин назад`;
            if (diffHours < 24) return `${diffHours} ч назад`;
            if (diffDays < 30) return `${diffDays} дн назад`;
            
            return formatDate(dateString);
        }

        // Функция проверки недавней активности
        function isRecentlyActive(dateString) {
            if (!dateString) return false;
            
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            
            return diffMins < 30; // Считаем активным если был в сети менее 30 минут назад
        }

        async function loadDashboard() {
            const token = localStorage.getItem('auth_token');
            
            try {
                const response = await fetch('/api/admin/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    document.getElementById('total-users').textContent = data.users.total_users || 0;
                    document.getElementById('pending-apps').textContent = data.applications.pending || 0;
                    document.getElementById('active-sessions').textContent = data.sessions.active_sessions || 0;
                    document.getElementById('banned-users').textContent = data.users.banned_users || 0;
                }
            } catch (error) {
                console.error('Ошибка загрузки статистики:', error);
            }
            
            // Загружаем заявки только если активна вкладка заявок
            const activeTab = document.querySelector('.admin-tab.active');
            if (activeTab && activeTab.dataset.tab === 'applications') {
                loadApplications();
            }
        }

        async function loadApplications() {
            const token = localStorage.getItem('auth_token');
            const status = document.getElementById('app-status-filter').value;
            const appsList = document.getElementById('applications-list');
            
            appsList.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-2"></i><p class="text-gray-500">Загрузка заявок...</p></div>';
            
            try {
                const url = `/api/applications?status=${status}&limit=20`;
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.applications && data.applications.length > 0) {
                        appsList.innerHTML = data.applications.map(app => `
                            <div class="glass-effect border border-gray-200 rounded-lg p-6">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h4 class="font-semibold text-white">${app.minecraft_nick}</h4>
                                        <p class="text-sm text-gray-300">${app.email} • ${app.discord}</p>
                                        <p class="text-xs text-gray-500">${new Date(app.submitted_at).toLocaleString('ru-RU')}</p>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="px-2 py-1 text-xs font-medium rounded ${getStatusBadge(app.status)}">${getStatusText(app.status)}</span>
                                        ${app.status === 'pending' ? `
                                            <button data-action="approve-app" data-app-id="${app.id}" class="px-3 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600">
                                                Одобрить
                                            </button>
                                            <button data-action="reject-app" data-app-id="${app.id}" class="px-3 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600">
                                                Отклонить
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                                <div class="grid md:grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <strong>Возраст:</strong> ${app.age}<br>
                                        <strong>Опыт:</strong> ${app.experience}
                                    </div>
                                    <div>
                                        ${app.reviewed_by_nickname ? `<strong>Рассмотрел:</strong> ${app.reviewed_by_nickname}<br>` : ''}
                                        ${app.reviewed_at ? `<strong>Дата:</strong> ${new Date(app.reviewed_at).toLocaleString('ru-RU')}` : ''}
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <details class="text-sm">
                                        <summary class="cursor-pointer text-chiwawa-primary font-medium">Подробности заявки</summary>
                                        <div class="mt-2 space-y-2 text-gray-300">
                                            <div><strong>Мотивация:</strong> ${app.motivation}</div>
                                            <div><strong>Планы:</strong> ${app.plans}</div>
                                            ${app.review_comment ? `<div><strong>Комментарий:</strong> ${app.review_comment}</div>` : ''}
                                        </div>
                                    </details>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        appsList.innerHTML = '<div class="text-center py-8 text-gray-500">Заявок не найдено</div>';
                    }
                } else {
                    appsList.innerHTML = '<div class="text-center py-8 text-red-500">Ошибка загрузки заявок</div>';
                }
            } catch (error) {
                console.error('Ошибка загрузки заявок:', error);
                appsList.innerHTML = '<div class="text-center py-8 text-red-500">Ошибка соединения</div>';
            }
        }

        async function loadUsers() {
            const token = localStorage.getItem('auth_token');
            const status = document.getElementById('user-status-filter').value;
            const search = document.getElementById('user-search').value;
            const usersList = document.getElementById('users-list');
            
            usersList.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-2"></i><p class="text-gray-500">Загрузка пользователей...</p></div>';
            
            try {
                const params = new URLSearchParams({ status, search, limit: 50 });
                const response = await fetch(`/api/admin/users?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.users && data.users.length > 0) {
                        usersList.innerHTML = data.users.map(user => `
                            <div class="glass-effect border border-gray-200 rounded-lg p-6">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center">
                                        <div class="w-12 h-12 rounded-full flex items-center justify-center mr-4 overflow-hidden border-2 border-minecraft-gold/30">
                                            ${user.avatar_url 
                                                ? `<img src="${user.avatar_url}" alt="Аватар ${user.nickname}" class="w-full h-full object-cover">`
                                                : `<div class="w-full h-full bg-minecraft-gray flex items-center justify-center"><i class="fas fa-user text-minecraft-gold"></i></div>`
                                            }
                                        </div>
                                        <div>
                                            <div class="flex items-center space-x-2">
                                                <h4 class="font-semibold text-white">${user.nickname}</h4>
                                                ${user.discord_username ? `<span class="text-xs bg-indigo-600 text-white px-2 py-1 rounded">Discord: ${user.discord_username}</span>` : ''}
                                            </div>
                                            <p class="text-sm text-gray-300">${user.email}</p>
                                            <div class="flex items-center space-x-3 text-xs text-gray-500 mt-1">
                                                <span>Trust Level ${user.trust_level}</span>
                                                <span>•</span>
                                                <span>${Math.floor((user.total_minutes || 0) / 60)} часов</span>
                                                ${user.age ? `<span>• ${user.age} лет</span>` : ''}
                                            </div>
                                            ${user.bio ? `<p class="text-xs text-gray-400 mt-1 italic">${user.bio.length > 60 ? user.bio.substring(0, 60) + '...' : user.bio}</p>` : ''}
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="px-2 py-1 text-xs font-medium rounded ${user.is_banned ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}">
                                            ${user.is_banned ? 'Заблокирован' : 'Активен'}
                                        </span>
                                        <span class="px-2 py-1 text-xs font-medium rounded bg-minecraft-gold/20 text-minecraft-gold">
                                            ${user.role === 'admin' ? 'Админ' : user.role === 'moderator' ? 'Модератор' : 'Пользователь'}
                                        </span>
                                        <div class="flex space-x-1">
                                            <button data-action="show-user-details" data-user-id="${user.id}" class="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600" title="Подробная информация">
                                                <i class="fas fa-info-circle"></i>
                                            </button>
                                            <select data-action="change-user-role" data-user-id="${user.id}" data-user-nickname="${user.nickname}" class="px-2 py-1 text-xs bg-minecraft-gray border border-minecraft-gold/20 rounded text-white" title="Изменить роль">
                                                <option value="user" ${user.role === 'user' ? 'selected' : ''}>👤 Пользователь</option>
                                                <option value="moderator" ${user.role === 'moderator' ? 'selected' : ''}>🛡️ Модератор</option>
                                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>👑 Админ</option>
                                            </select>
                                            ${!user.is_banned ? `
                                                <button data-action="ban-user" data-user-id="${user.id}" data-user-nickname="${user.nickname}" class="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600" title="Заблокировать">
                                                    <i class="fas fa-ban"></i>
                                                </button>
                                            ` : `
                                                <button data-action="unban-user" data-user-id="${user.id}" data-user-nickname="${user.nickname}" class="px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600" title="Разблокировать">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            `}
                                            <select data-action="change-trust-level" data-user-id="${user.id}" class="px-2 py-1 text-xs bg-minecraft-gray border border-minecraft-gold/20 rounded text-white" title="Изменить Trust Level">
                                                ${[0,1,2,3].map(level => {
                                                    const levelNames = ['🚶 Проходимец', '👤 Новичок', '✅ Проверенный', '🏆 Ветеран'];
                                                    return `<option value="${level}" ${user.trust_level == level ? 'selected' : ''}>${levelNames[level]} (${level})</option>`;
                                                }).join('')}
                                            </select>
                                            ${user.role !== 'admin' ? `
                                                <button data-action="delete-user" data-user-id="${user.id}" data-user-nickname="${user.nickname}" class="px-2 py-1 bg-red-700 text-white text-xs rounded hover:bg-red-800 transition-colors" title="Удалить пользователя">
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                                ${user.ban_reason ? `<div class="mt-2 text-sm text-red-600"><strong>Причина блокировки:</strong> ${user.ban_reason}</div>` : ''}
                            </div>
                        `).join('');
                    } else {
                        usersList.innerHTML = '<div class="text-center py-8 text-gray-500">Пользователей не найдено</div>';
                    }
                }
            } catch (error) {
                console.error('Ошибка загрузки пользователей:', error);
                usersList.innerHTML = '<div class="text-center py-8 text-red-500">Ошибка соединения</div>';
            }
        }

        // Загрузка технической информации о сервере
        async function loadTechnicalInfo() {
            const token = localStorage.getItem('auth_token');
            
            try {
                // Загружаем системную информацию
                const systemResponse = await fetch('/api/admin/system-info', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (systemResponse.ok) {
                    const systemInfo = await systemResponse.json();
                    
                    document.getElementById('node-version').textContent = systemInfo.nodeVersion || 'N/A';
                    document.getElementById('uptime').textContent = systemInfo.uptime || 'N/A';
                    document.getElementById('memory-rss').textContent = systemInfo.memory?.rss || 'N/A';
                    document.getElementById('memory-heap').textContent = systemInfo.memory?.heapUsed || 'N/A';
                }

                // Загружаем статистику (уже существующий endpoint)
                const statsResponse = await fetch('/api/admin/stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    
                    // Обновляем API статистику
                    document.getElementById('api-total-requests').textContent = stats.totalUsers || 'N/A';
                    document.getElementById('api-today-requests').textContent = stats.totalApplications || 'N/A';
                    document.getElementById('api-active-users').textContent = stats.activeUsers || 'N/A';
                    
                    // Форматируем время последней активности
                    const lastActivity = stats.lastActivity ? 
                        new Date(stats.lastActivity).toLocaleString('ru-RU') : 'Нет данных';
                    document.getElementById('api-last-activity').textContent = lastActivity;
                }
            } catch (error) {
                console.error('Ошибка загрузки технической информации:', error);
            }
        }

        async function loadLogs() {
            const token = localStorage.getItem('auth_token');
            const action = document.getElementById('log-action-filter').value;
            const logsList = document.getElementById('logs-list');
            
            logsList.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-2"></i><p class="text-gray-500">Загрузка логов...</p></div>';
            
            try {
                const params = new URLSearchParams({ action, limit: 100 });
                const response = await fetch(`/api/admin/logs?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.logs && data.logs.length > 0) {
                        logsList.innerHTML = data.logs.map(log => `
                            <div class="glass-effect border-l-4 ${getLogBorderColor(log.action)} p-4">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2">
                                            <span class="font-medium text-white">${log.action}</span>
                                            ${log.admin_nickname ? `<span class="text-sm text-gray-300">от ${log.admin_nickname}</span>` : ''}
                                        </div>
                                        <p class="text-sm text-gray-300 mt-1">${log.details}</p>
                                        ${log.target_user_nickname ? `<p class="text-xs text-gray-500">Цель: ${log.target_user_nickname}</p>` : ''}
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        ${new Date(log.created_at).toLocaleString('ru-RU')}
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        logsList.innerHTML = '<div class="text-center py-8 text-gray-500">Логов не найдено</div>';
                    }
                } else {
                    // Обработка ошибок API
                    const errorText = await response.text();
                    console.error('Ошибка API логов:', response.status, errorText);
                    
                    if (response.status === 500) {
                        logsList.innerHTML = `<div class="text-center py-8 text-red-500">
                            <div class="mb-2">Ошибка сервера (500)</div>
                            <div class="text-sm text-gray-400">Фильтр "${action}" может быть не поддерживается сервером</div>
                            <div class="text-xs text-gray-500 mt-2">Попробуйте фильтр "Все действия"</div>
                        </div>`;
                    } else {
                        logsList.innerHTML = `<div class="text-center py-8 text-red-500">Ошибка загрузки логов (${response.status})</div>`;
                    }
                }
            } catch (error) {
                console.error('Ошибка загрузки логов:', error);
                logsList.innerHTML = '<div class="text-center py-8 text-red-500">Ошибка соединения</div>';
            }
        }

        // Действия с заявками
        async function reviewApplication(id, status) {
            const reason = status === 'rejected' ? prompt('Причина отклонения (необязательно):') : '';
            const token = localStorage.getItem('auth_token');
            
            try {
                const response = await fetch(`/api/applications/${id}/review`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status, comment: reason })
                });
                
                if (response.ok) {
                    loadApplications();
                    loadDashboard();
                } else {
                    const error = await response.json();
                    alert('Ошибка: ' + error.error);
                }
            } catch (error) {
                console.error('Ошибка рассмотрения заявки:', error);
                alert('Ошибка соединения с сервером');
            }
        }

        // Действия с пользователями
        // Эта функция использует готовые модальные окна, определенные в HTML
        // Старая функция banUser удалена и заменена на правильную
        
        async function unbanUser(id, nickname) {
            if (!confirm(`Разблокировать пользователя ${nickname}?`)) return;
            
            const token = localStorage.getItem('auth_token');
            
            try {
                const response = await fetch(`/api/admin/users/${id}/unban`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    loadUsers();
                    loadDashboard();
                } else {
                    const error = await response.json();
                    alert('Ошибка: ' + error.error);
                }
            } catch (error) {
                console.error('Ошибка разблокировки пользователя:', error);
                alert('Ошибка соединения с сервером');
            }
        }

        async function changeTrustLevel(id, level) {
            const levelNames = {
                0: '🚶 Проходимец',
                1: '👤 Новичок', 
                2: '✅ Проверенный',
                3: '🏆 Ветеран'
            };
            
            const levelName = levelNames[level] || 'Неизвестный уровень';
            const reason = prompt(`Причина изменения Trust Level на "${levelName}" (${level}):`);
            
            if (!reason) return; // Отменено пользователем
            
            const token = localStorage.getItem('auth_token');
            
            try {
                const response = await fetch(`/api/admin/users/${id}/trust-level`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ level: parseInt(level), reason })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showMessage(result.message || 'Trust Level успешно изменен', 'success');
                    loadUsers();
                    loadDashboard(); // Обновляем статистику
                } else {
                    const error = await response.json();
                    showMessage('Ошибка: ' + error.error, 'error');
                }
            } catch (error) {
                console.error('Ошибка изменения Trust Level:', error);
                showMessage('Ошибка соединения с сервером', 'error');
            }
        }

        // Функция просмотра подробной информации о пользователе
        // Утилиты
        function getStatusBadge(status) {
            const badges = {
                'pending': 'bg-yellow-100 text-yellow-600',
                'approved': 'bg-green-100 text-green-600',
                'rejected': 'bg-red-100 text-red-600',
                'banned': 'bg-gray-100 text-gray-300'
            };
            return badges[status] || 'bg-gray-100 text-gray-300';
        }

        function getStatusText(status) {
            const texts = {
                'pending': 'На рассмотрении',
                'approved': 'Одобрена',
                'rejected': 'Отклонена',
                'banned': 'Заблокирована'
            };
            return texts[status] || 'Неизвестно';
        }

        function getLogBorderColor(action) {
            if (action.includes('login')) return 'border-blue-400';
            if (action.includes('banned') || action.includes('deleted')) return 'border-red-400';
            if (action.includes('unbanned')) return 'border-green-400';
            if (action.includes('application')) return 'border-green-400';
            if (action.includes('trust_level')) return 'border-yellow-400';
            if (action.includes('role_changed')) return 'border-purple-400';
            if (action.includes('settings')) return 'border-minecraft-gold';
            return 'border-gray-400';
        }

        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (days > 0) return `${days}д ${hours}ч`;
            if (hours > 0) return `${hours}ч ${minutes}м`;
            return `${minutes}м`;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Недостающие функции для Trust Level и других операций
        async function loadTrustLevels() {
            const token = localStorage.getItem('auth_token');
            const statsElement = document.getElementById('trust-level-stats');
            
            if (statsElement) {
                statsElement.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-minecraft-gold"></i><p class="text-gray-300 mt-2">Загрузка статистики...</p></div>';
                
                try {
                    const response = await fetch('/api/admin/trust-levels/stats', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        statsElement.innerHTML = `
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-300">🚶 Проходимец (0):</span>
                                    <span class="text-white font-bold">${data.level0 || 0} пользователей</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-300">👤 Новичок (1):</span>
                                    <span class="text-white font-bold">${data.level1 || 0} пользователей</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-300">✅ Проверенный (2):</span>
                                    <span class="text-white font-bold">${data.level2 || 0} пользователей</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-300">🏆 Ветеран (3):</span>
                                    <span class="text-white font-bold">${data.level3 || 0} пользователей</span>
                                </div>
                            </div>
                        `;
                    } else {
                        statsElement.innerHTML = '<div class="text-center py-4 text-red-400">Ошибка загрузки статистики</div>';
                    }
                } catch (error) {
                    console.error('Ошибка загрузки статистики Trust Level:', error);
                    statsElement.innerHTML = '<div class="text-center py-4 text-red-400">Ошибка соединения</div>';
                }
            }
            
            loadTrustApplications();
        }

        async function loadTrustApplications() {
            const token = localStorage.getItem('auth_token');
            const status = document.getElementById('trust-app-status-filter')?.value || 'all';
            const appsList = document.getElementById('trust-applications-list');
            
            if (appsList) {
                appsList.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-minecraft-gold mb-2"></i><p class="text-gray-300">Загрузка заявок...</p></div>';
                
                try {
                    const response = await fetch(`/api/admin/trust-applications?status=${status}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.applications && data.applications.length > 0) {
                            appsList.innerHTML = data.applications.map(app => `
                                <div class="glass-effect rounded-lg p-6">
                                    <div class="flex justify-between items-start mb-4">
                                        <div>
                                            <h4 class="font-semibold text-white">${app.nickname}</h4>
                                            <p class="text-sm text-gray-300">Заявка на ${app.requested_level} уровень</p>
                                            <p class="text-xs text-gray-500">${new Date(app.submitted_at).toLocaleString('ru-RU')}</p>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="px-2 py-1 text-xs font-medium rounded ${getStatusBadge(app.status)}">${getStatusText(app.status)}</span>
                                        </div>
                                    </div>
                                    <div class="text-sm text-gray-300">
                                        <p><strong>Обоснование:</strong> ${app.reason}</p>
                                    </div>
                                </div>
                            `).join('');
                        } else {
                            appsList.innerHTML = '<div class="text-center py-8 text-gray-500">Заявок не найдено</div>';
                        }
                    } else {
                        appsList.innerHTML = '<div class="text-center py-8 text-red-500">Ошибка загрузки заявок</div>';
                    }
                } catch (error) {
                    console.error('Ошибка загрузки заявок Trust Level:', error);
                    appsList.innerHTML = '<div class="text-center py-8 text-red-500">Ошибка соединения</div>';
                }
            }
        }

        // Функция отображения результатов тестов
        function showTestResult(type, message) {
            const resultsDiv = document.getElementById('test-results');
            const outputDiv = document.getElementById('test-output');
            
            if (resultsDiv && outputDiv) {
                resultsDiv.classList.remove('hidden');
                outputDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                outputDiv.className = `text-sm font-mono whitespace-pre-wrap ${
                    type === 'success' ? 'text-green-600' : 'text-red-600'
                }`;
                
                // Прокручиваем к результату
                resultsDiv.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Обработчик сохранения настроек
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('save-settings-btn')?.addEventListener('click', async () => {
                const btn = document.getElementById('save-settings-btn');
                const originalText = btn.innerHTML;
                
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Сохраняю...';
                btn.disabled = true;
                
                try {
                    // Собираем все настройки из формы
                    const settings = {
                        server: {
                            name: document.getElementById('server-name')?.value,
                            description: document.getElementById('server-description')?.value,
                            ip: document.getElementById('server-ip')?.value,
                            port: document.getElementById('server-port')?.value,
                            discord: document.getElementById('discord-invite')?.value,
                            telegram: document.getElementById('telegram-invite')?.value
                        },
                        applications: {
                            minMotivationLength: parseInt(document.getElementById('min-motivation-length')?.value) || 50,
                            minPlansLength: parseInt(document.getElementById('min-plans-length')?.value) || 30,
                            maxApplicationsPerDay: parseInt(document.getElementById('max-applications-per-day')?.value) || 3,
                        }
                    };
                    
                    const token = localStorage.getItem('auth_token');
                    const response = await fetch('/api/admin/settings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ settings })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        showMessage('Настройки успешно сохранены!', 'success');
                    } else {
                        showMessage('Ошибка сохранения: ' + (result.error || 'Неизвестная ошибка'), 'error');
                    }
                } catch (error) {
                    showMessage('Ошибка соединения: ' + error.message, 'error');
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });
        });

        // Функция показа сообщений
        function showMessage(text, type) {
            const message = document.createElement('div');
            message.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 ${
                type === 'success' ? 
                'bg-green-900/90 text-green-300 border border-green-500/50' : 
                'bg-red-900/90 text-red-300 border border-red-500/50'
            }`;
            message.textContent = text;
            
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.style.opacity = '0';
                message.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(message);
                }, 300);
            }, 3000);
        }

        // Функции для управления траст левелами
        async function loadTrustLevels() {
            await loadTrustLevelStats();
            await loadTrustApplications();
        }

        async function loadTrustLevelStats() {
            const token = localStorage.getItem('auth_token');
            const statsDiv = document.getElementById('trust-level-stats');
            
            try {
                const response = await fetch('/api/admin/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const trustLevels = data.trust_levels || [];
                    
                    // Создаем объект с количеством пользователей по уровням
                    const levelCounts = { 0: 0, 1: 0, 2: 0, 3: 0 };
                    trustLevels.forEach(level => {
                        levelCounts[level.trust_level] = level.user_count;
                    });
                    
                    statsDiv.innerHTML = `
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-300">🚶 Проходимцы:</span>
                                <span class="text-white font-medium">${levelCounts[0]} пользователей</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-300">👤 Новички:</span>
                                <span class="text-white font-medium">${levelCounts[1]} пользователей</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-300">✅ Проверенные:</span>
                                <span class="text-white font-medium">${levelCounts[2]} пользователей</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-300">🏆 Ветераны:</span>
                                <span class="text-white font-medium">${levelCounts[3]} пользователей</span>
                            </div>
                            ${data.trust_applications ? `
                                <hr class="border-minecraft-gold/20 my-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-300">📝 Заявки на рассмотрении:</span>
                                    <span class="text-minecraft-gold font-medium">${data.trust_applications.pending || 0}</span>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Ошибка загрузки статистики траст левелов:', error);
                statsDiv.innerHTML = '<div class="text-red-500 text-center">Ошибка загрузки статистики</div>';
            }
        }

        async function loadTrustApplications() {
            const token = localStorage.getItem('auth_token');
            const status = document.getElementById('trust-app-status-filter').value;
            const appsList = document.getElementById('trust-applications-list');
            
            appsList.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-minecraft-gold mb-2"></i><p class="text-gray-300">Загрузка заявок...</p></div>';
            
            try {
                const params = new URLSearchParams({ status, limit: 20 });
                const response = await fetch(`/api/trust-level/applications?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.applications && data.applications.length > 0) {
                        appsList.innerHTML = data.applications.map(app => `
                            <div class="glass-effect border border-gray-200 rounded-lg p-6">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h4 class="font-semibold text-white">${app.nickname}</h4>
                                        <p class="text-sm text-gray-300">
                                            Повышение с уровня ${app.current_level} до ${app.requested_level}
                                        </p>
                                        <p class="text-xs text-gray-500">${new Date(app.created_at).toLocaleString('ru-RU')}</p>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="px-2 py-1 text-xs font-medium rounded ${getTrustStatusBadge(app.status)}">${getTrustStatusText(app.status)}</span>
                                        ${app.status === 'pending' ? `
                                            <button data-action="approve-trust-app" data-app-id="${app.id}" class="px-3 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600">
                                                Одобрить
                                            </button>
                                            <button data-action="reject-trust-app" data-app-id="${app.id}" class="px-3 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600">
                                                Отклонить
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                                <div class="grid md:grid-cols-3 gap-4 text-sm mb-4">
                                    <div>
                                        <strong>Время игры:</strong> ${Math.floor(app.hours_played || 0)} часов<br>
                                        <strong>Репутация:</strong> ${app.current_reputation || app.reputation_score || 0}
                                    </div>
                                    <div>
                                        <strong>Почта:</strong> ${app.email_verified ? '✅ Подтверждена' : '❌ Не подтверждена'}<br>
                                        <strong>Требуемый уровень:</strong> ${getTrustLevelName(app.requested_level)}
                                    </div>
                                    <div>
                                        ${app.reviewer_nickname ? `<strong>Рассмотрел:</strong> ${app.reviewer_nickname}<br>` : ''}
                                        ${app.reviewed_at ? `<strong>Дата:</strong> ${new Date(app.reviewed_at).toLocaleString('ru-RU')}` : ''}
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <details class="text-sm">
                                        <summary class="cursor-pointer text-minecraft-gold font-medium">Обоснование заявки</summary>
                                        <div class="mt-2 text-gray-300">
                                            ${app.reason}
                                            ${app.review_comment ? `<div class="mt-2 p-3 bg-minecraft-gray rounded border-l-4 border-minecraft-gold"><strong>Комментарий администратора:</strong> ${app.review_comment}</div>` : ''}
                                        </div>
                                    </details>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        appsList.innerHTML = '<div class="text-center py-8 text-gray-500">Заявок на повышение не найдено</div>';
                    }
                } else {
                    appsList.innerHTML = '<div class="text-center py-8 text-red-500">Ошибка загрузки заявок</div>';
                }
            } catch (error) {
                console.error('Ошибка загрузки заявок на траст левел:', error);
                appsList.innerHTML = '<div class="text-center py-8 text-red-500">Ошибка соединения</div>';
            }
        }

        async function reviewTrustApplication(id, status) {
            const comment = status === 'rejected' ? prompt('Причина отклонения (необязательно):') : prompt('Комментарий (необязательно):');
            const token = localStorage.getItem('auth_token');
            
            try {
                const response = await fetch(`/api/trust-level/applications/${id}/review`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status, comment })
                });
                
                if (response.ok) {
                    showMessage(`Заявка ${status === 'approved' ? 'одобрена' : 'отклонена'}`, 'success');
                    loadTrustApplications();
                    loadTrustLevelStats();
                    loadDashboard(); // Обновляем общую статистику
                } else {
                    const error = await response.json();
                    showMessage('Ошибка: ' + error.error, 'error');
                }
            } catch (error) {
                console.error('Ошибка рассмотрения заявки:', error);
                showMessage('Ошибка соединения с сервером', 'error');
            }
        }

        function getTrustStatusBadge(status) {
            const badges = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'approved': 'bg-green-100 text-green-800',
                'rejected': 'bg-red-100 text-red-800'
            };
            return badges[status] || 'bg-gray-100 text-gray-800';
        }

        function getTrustStatusText(status) {
            const texts = {
                'pending': 'На рассмотрении',
                'approved': 'Одобрена',
                'rejected': 'Отклонена'
            };
            return texts[status] || 'Неизвестно';
        }

        function getTrustLevelName(level) {
            const names = {
                0: '🚶 Проходимец',
                1: '👤 Новичок', 
                2: '✅ Проверенный',
                3: '🏆 Ветеран'
            };
            return names[level] || 'Неизвестный уровень';
        }

        function getTrustLevelDisplayName(level) {
            const names = {
                0: '🚶 Проходимец (Уровень 0)',
                1: '👤 Новичок (Уровень 1)', 
                2: '✅ Проверенный (Уровень 2)',
                3: '🏆 Ветеран (Уровень 3)'
            };
            return names[level] || `Неизвестный уровень (${level})`;
        }

        
        // Функция сохранения настроек
        async function saveSettings() {
            const token = localStorage.getItem('auth_token');
            const saveBtn = document.getElementById('save-settings-btn');
            
            // Показываем индикатор загрузки
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Сохранение...';
            saveBtn.disabled = true;
            
            try {
                // Собираем все настройки из формы
                const settingsData = {
                    // Основные настройки
                    serverName: document.getElementById('server-name')?.value,
                    serverDescription: document.getElementById('server-description')?.value,
                    serverIp: document.getElementById('server-ip')?.value,
                    serverPort: parseInt(document.getElementById('server-port')?.value),
                    maxPlayers: parseInt(document.getElementById('max-players')?.value),
                    discordInvite: document.getElementById('discord-invite')?.value,
                    telegramInvite: document.getElementById('telegram-invite')?.value,
                    
                    // Настройки заявок
                    applicationsEnabled: document.getElementById('applications-enabled')?.checked,
                    minMotivationLength: parseInt(document.getElementById('min-motivation-length')?.value),
                    minPlansLength: parseInt(document.getElementById('min-plans-length')?.value),
                    maxApplicationsPerDay: parseInt(document.getElementById('max-applications-per-day')?.value),
                    autoApproveTrustLevel: parseInt(document.getElementById('auto-approve-trust-level')?.value),
                    
                    // Trust Level настройки
                    trustPointsEmail: parseInt(document.getElementById('trust-points-email')?.value),
                    trustPointsDiscord: parseInt(document.getElementById('trust-points-discord')?.value),
                    trustPointsHour: parseInt(document.getElementById('trust-points-hour')?.value),
                    trustPointsReputation: parseInt(document.getElementById('trust-points-reputation')?.value),
                    trustMinimumHours: parseInt(document.getElementById('trust-minimum-hours')?.value),
                    trustMinimumReputation: parseInt(document.getElementById('trust-minimum-reputation')?.value),
                    trustLevel1Required: parseInt(document.getElementById('trust-level-1-required')?.value),
                    trustLevel2Required: parseInt(document.getElementById('trust-level-2-required')?.value),
                    trustLevel3Required: parseInt(document.getElementById('trust-level-3-required')?.value),
                    
                    // Настройки безопасности
                    maxLoginAttempts: parseInt(document.getElementById('max-login-attempts')?.value),
                    loginLockoutDuration: parseInt(document.getElementById('login-lockout-duration')?.value),
                    jwtExpiresDays: parseInt(document.getElementById('jwt-expires-days')?.value),
                    requireEmailVerification: document.getElementById('require-email-verification')?.value === 'true',
                    twoFactorEnabled: document.getElementById('two-factor-enabled')?.checked,
                    rateLimitRequests: parseInt(document.getElementById('rate-limit-requests')?.value),
                    
                    // Email настройки
                    smtpHost: document.getElementById('smtp-host')?.value,
                    smtpPort: parseInt(document.getElementById('smtp-port')?.value),
                    smtpFrom: document.getElementById('smtp-from')?.value,
                    smtpUser: document.getElementById('smtp-user')?.value,
                    smtpPassword: document.getElementById('smtp-password')?.value,
                    smtpTls: document.getElementById('smtp-tls')?.checked,
                    smtpSenderName: document.getElementById('smtp-sender-name')?.value,
                    smtpReplyTo: document.getElementById('smtp-reply-to')?.value,
                    smtpTimeout: parseInt(document.getElementById('smtp-timeout')?.value)
                };
                
                console.log('Отправляемые настройки:', settingsData);
                
                const response = await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(settingsData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    console.log('Ответ сервера:', result);
                    
                    // Перезагружаем настройки из административного API
                    await loadSettings();
                    
                    showNotification('success', result.message || 'Настройки успешно сохранены!');
                } else {
                    const errorData = await response.json();
                    console.error('Ошибка сохранения:', errorData);
                    showNotification('error', 'Ошибка сохранения: ' + (errorData.error || 'Неизвестная ошибка'));
                }
            } catch (error) {
                console.error('Ошибка сохранения настроек:', error);
                showNotification('error', 'Ошибка соединения с сервером');
            } finally {
                // Восстанавливаем кнопку
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        // Функция тестирования email настроек
        async function testEmailSettings() {
            const btn = document.getElementById('test-email-simple-btn');
            const resultDiv = document.getElementById('email-test-result');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Отправляю...';
            btn.disabled = true;
            
            try {
                const token = localStorage.getItem('auth_token');
                const recipient = document.getElementById('test-email-recipient').value;
                const template = document.getElementById('test-email-template').value;
                
                if (!recipient) {
                    showNotification('error', 'Укажите email получателя для теста');
                    return;
                }
                
                const testData = {
                    recipient: recipient,
                    template: template,
                    settings: {
                        host: document.getElementById('smtp-host').value,
                        port: parseInt(document.getElementById('smtp-port').value),
                        user: document.getElementById('smtp-user').value,
                        password: document.getElementById('smtp-password').value,
                        from: document.getElementById('smtp-from').value,
                        secure: document.getElementById('smtp-secure').checked
                    }
                };
                
                const response = await fetch('/api/admin/test-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showNotification('success', 'Тестовое письмо отправлено успешно!');
                    resultDiv.innerHTML = `
                        <div class="flex items-start">
                            <i class="fas fa-check-circle text-green-400 mr-3 mt-1"></i>
                            <div class="text-sm">
                                <div class="text-green-300 font-medium">Письмо отправлено!</div>
                                <div class="text-gray-400 mt-1">
                                    <div>Получатель: ${recipient}</div>
                                    <div>Время отправки: ${result.sentAt || 'Сейчас'}</div>
                                    <div>Время доставки: ${result.deliveryTime || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    resultDiv.classList.remove('hidden');
                    resultDiv.className = resultDiv.className.replace(/bg-\w+-500\/10/, 'bg-green-500/10');
                } else {
                    showNotification('error', 'Ошибка отправки: ' + (result.error || 'Неизвестная ошибка'));
                    resultDiv.innerHTML = `
                        <div class="flex items-start">
                            <i class="fas fa-exclamation-circle text-red-400 mr-3 mt-1"></i>
                            <div class="text-sm">
                                <div class="text-red-300 font-medium">Ошибка отправки</div>
                                <div class="text-gray-400 mt-1">${result.error || 'Проверьте настройки SMTP'}</div>
                            </div>
                        </div>
                    `;
                    resultDiv.classList.remove('hidden');
                    resultDiv.className = resultDiv.className.replace(/bg-\w+-500\/10/, 'bg-red-500/10');
                }
                
            } catch (error) {
                console.error('Ошибка тестирования email:', error);
                showNotification('error', 'Ошибка соединения с сервером');
                resultDiv.innerHTML = `
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-yellow-400 mr-3 mt-1"></i>
                        <div class="text-sm">
                            <div class="text-yellow-300 font-medium">Ошибка соединения</div>
                            <div class="text-gray-400 mt-1">Проверьте подключение к серверу</div>
                        </div>
                    </div>
                `;
                resultDiv.classList.remove('hidden');
                resultDiv.className = resultDiv.className.replace(/bg-\w+-500\/10/, 'bg-yellow-500/10');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Функция сброса настроек к умолчанию
        async function resetSettings() {
            if (!confirm('Вы уверены, что хотите сбросить все настройки к значениям по умолчанию?')) {
                return;
            }
            
            const btn = document.getElementById('reset-settings-btn');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Сброс...';
            btn.disabled = true;
            
            try {
                // Устанавливаем значения по умолчанию
                const defaultSettings = {
                    // Основные настройки
                    'server-name': 'Chiwawa',
                    'server-description': 'Приватный Minecraft сервер с дружелюбным сообществом',
                    'server-ip': 'play.chiwawa.site',
                    'server-port': '25164',
                    'max-players': '100',
                    'discord-invite': 'https://discord.gg/chiwawa',
                    'telegram-invite': 'https://t.me/chiwawa',
                    
                    // Настройки заявок
                    'min-motivation-length': '50',
                    'min-plans-length': '30',
                    'max-applications-per-day': '3',
                    'auto-approve-trust-level': '0',
                    
                    // Trust Level
                    'trust-points-email': '10',
                    'trust-points-discord': '15',
                    'trust-points-hour': '1',
                    'trust-points-reputation': '2',
                    'trust-minimum-hours': '5',
                    'trust-minimum-reputation': '0',
                    'trust-level-1-required': '25',
                    'trust-level-2-required': '100',
                    'trust-level-3-required': '500',
                    
                    // Безопасность
                    'max-login-attempts': '5',
                    'login-lockout-duration': '15',
                    'jwt-expires-days': '7',
                    'rate-limit-requests': '100',
                    
                    // Email
                    'smtp-host': '',
                    'smtp-port': '587',
                    'smtp-from': '',
                    'smtp-user': '',
                    'smtp-password': '',
                    'smtp-sender-name': 'Chiwawa Server',
                    'smtp-reply-to': '',
                    'smtp-timeout': '30'
                };
                
                const defaultCheckboxes = {
                    'applications-enabled': true,
                    'two-factor-enabled': false,
                    'smtp-tls': true
                };
                
                const defaultSelects = {
                    'require-email-verification': 'true'
                };
                
                // Применяем настройки по умолчанию
                Object.entries(defaultSettings).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.value = value;
                    }
                });
                
                Object.entries(defaultCheckboxes).forEach(([id, checked]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.checked = checked;
                    }
                });
                
                Object.entries(defaultSelects).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.value = value;
                    }
                });
                
                showMessage('Настройки сброшены к значениям по умолчанию', 'success');
                
            } catch (error) {
                console.error('Ошибка сброса настроек:', error);
                showMessage('Ошибка сброса настроек', 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Функция показа сообщений
        function showMessage(text, type) {
            // Создаем элемент сообщения если его нет
            let messageElement = document.getElementById('global-message');
            if (!messageElement) {
                messageElement = document.createElement('div');
                messageElement.id = 'global-message';
                messageElement.className = 'fixed top-4 right-4 z-50 px-6 py-4 rounded-lg font-medium';
                document.body.appendChild(messageElement);
            }
            
            messageElement.textContent = text;
            messageElement.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg font-medium ${
                type === 'success' ? 
                'bg-green-900/90 text-green-300 border border-green-500/50' : 
                'bg-red-900/90 text-red-300 border border-red-500/50'
            }`;
            
            messageElement.style.display = 'block';
            
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 3000);
        }

        // Функция загрузки настроек
        async function loadSettings() {
            const token = localStorage.getItem('auth_token');
            
            try {
                const response = await fetch('/api/admin/settings', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const settings = data.settings || {};
                    
                    console.log('Загруженные настройки:', settings);
                    
                    // Функция для безопасного заполнения поля
                    const setElementValue = (id, value) => {
                        const element = document.getElementById(id);
                        if (element && value !== undefined && value !== null) {
                            element.value = value;
                        }
                    };
                    
                    const setElementChecked = (id, checked) => {
                        const element = document.getElementById(id);
                        if (element && checked !== undefined && checked !== null) {
                            element.checked = checked;
                        }
                    };
                    
                    // Основные настройки сервера
                    setElementValue('server-name', settings.serverName);
                    setElementValue('server-description', settings.serverDescription);
                    setElementValue('server-ip', settings.serverIp);
                    setElementValue('server-port', settings.serverPort);
                    setElementValue('max-players', settings.maxPlayers);
                    setElementValue('discord-invite', settings.discordInvite);
                    setElementValue('telegram-invite', settings.telegramInvite);
                    
                    // Настройки заявок
                    setElementValue('min-motivation-length', settings.minMotivationLength);
                    setElementValue('min-plans-length', settings.minPlansLength);
                    setElementValue('max-applications-per-day', settings.maxApplicationsPerDay);
                    setElementChecked('applications-enabled', settings.applicationsEnabled);
                    setElementValue('auto-approve-trust-level', settings.autoApproveTrustLevel);
                    
                    // Trust Level настройки
                    setElementValue('trust-points-email', settings.trustPointsEmail);
                    setElementValue('trust-points-discord', settings.trustPointsDiscord);
                    setElementValue('trust-points-hour', settings.trustPointsHour);
                    setElementValue('trust-points-reputation', settings.trustPointsReputation);
                    setElementValue('trust-minimum-hours', settings.trustMinimumHours);
                    setElementValue('trust-minimum-reputation', settings.trustMinimumReputation);
                    setElementValue('trust-level-1-required', settings.trustLevel1Required);
                    setElementValue('trust-level-2-required', settings.trustLevel2Required);
                    setElementValue('trust-level-3-required', settings.trustLevel3Required);
                    
                    // Настройки безопасности
                    setElementValue('max-login-attempts', settings.maxLoginAttempts);
                    setElementValue('login-lockout-duration', settings.loginLockoutDuration);
                    setElementValue('jwt-expires-days', settings.jwtExpiresDays);
                    setElementValue('rate-limit-requests', settings.rateLimitRequests);
                    setElementChecked('two-factor-enabled', settings.twoFactorEnabled);
                    
                    // Email настройки
                    setElementValue('smtp-host', settings.smtpHost);
                    setElementValue('smtp-port', settings.smtpPort);
                    setElementValue('smtp-from', settings.smtpFrom);
                    setElementValue('smtp-user', settings.smtpUser);
                    setElementValue('smtp-password', settings.smtpPassword);
                    setElementChecked('smtp-tls', settings.smtpTls);
                    setElementValue('smtp-sender-name', settings.smtpSenderName);
                    setElementValue('smtp-reply-to', settings.smtpReplyTo);
                    setElementValue('smtp-timeout', settings.smtpTimeout);
                    
                    // Select поля
                    const emailVerificationSelect = document.getElementById('require-email-verification');
                    if (emailVerificationSelect && settings.requireEmailVerification !== undefined) {
                        emailVerificationSelect.value = settings.requireEmailVerification ? 'true' : 'false';
                    }
                    
                    console.log('Настройки успешно загружены и применены к форме');
                } else {
                    console.error('Ошибка загрузки настроек:', response.status);
                    showMessage('Ошибка загрузки настроек', 'error');
                }
            } catch (error) {
                console.error('Ошибка загрузки настроек:', error);
                showMessage('Ошибка соединения при загрузке настроек', 'error');
            }
        }

        async function changeTrustLevel(userId, newLevel) {
            const levelNames = {
                0: '🚶 Проходимец',
                1: '👤 Новичок', 
                2: '✅ Проверенный',
                3: '🏆 Ветеран'
            };
            
            const levelName = levelNames[newLevel] || 'Неизвестный уровень';
            const reason = prompt(`Причина изменения Trust Level на "${levelName}" (${newLevel}):`);
            
            if (!reason) return; // Отменено пользователем
            
            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch(`/api/admin/users/${userId}/trust-level`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ level: parseInt(newLevel), reason: reason })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showMessage(result.message || 'Trust Level успешно изменен', 'success');
                    loadUsers();
                    loadDashboard();
                } else {
                    const error = await response.json();
                    showMessage('Ошибка: ' + error.error, 'error');
                }
            } catch (error) {
                console.error('Ошибка изменения траст левела:', error);
                showMessage('Ошибка соединения с сервером', 'error');
            }
        }

        async function changeUserRoleSelect(userId, nickname, newRole) {
            if (!confirm(`Изменить роль пользователя ${nickname} на ${getRoleText(newRole)}?`)) {
                // Если отменили, возвращаем старое значение
                loadUsers();
                return;
            }
            
            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch(`/api/admin/users/${userId}/role`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        role: newRole,
                        reason: `Изменение роли через админ панель`
                    })
                });
                
                if (response.ok) {
                    loadUsers();
                    loadDashboard();
                } else {
                    const error = await response.json();
                    alert('Ошибка: ' + error.error);
                    loadUsers(); // Возвращаем старое значение
                }
            } catch (error) {
                console.error('Ошибка изменения роли:', error);
                alert('Ошибка соединения с сервером');
                loadUsers(); // Возвращаем старое значение
            }
        }

        async function unbanUser(userId, nickname) {
            if (confirm(`Разблокировать пользователя ${nickname}?`)) {
                try {
                    const token = localStorage.getItem('auth_token');
                    const response = await fetch(`/api/admin/users/${userId}/unban`, {
                        method: 'PUT',
                        headers: { 
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        loadUsers();
                        loadDashboard();
                    } else {
                        const error = await response.json();
                        alert('Ошибка: ' + error.error);
                    }
                } catch (error) {
                    console.error('Ошибка разблокировки:', error);
                    alert('Ошибка соединения с сервером');
                }
            }
        }

        async function reviewTrustApplication(id, status) {
            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch(`/api/trust-level/applications/${id}/review`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        decision: status,
                        comment: status === 'approved' ? 'Одобрено' : 'Отклонено'
                    })
                });
                
                if (response.ok) {
                    loadTrustApplications();
                    loadTrustLevelStats();
                } else {
                    const error = await response.json();
                    alert('Ошибка: ' + error.error);
                }
            } catch (error) {
                console.error('Ошибка рассмотрения заявки:', error);
                alert('Ошибка соединения с сервером');
            }
        }

        async function updateUserRole(userId) {
            // Функция для обновления роли пользователя
            console.log('Обновить роль пользователя:', userId);
        }

        // Функции для системных утилит
        async function testEmail() {
            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch('/api/admin/test/email', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const result = await response.json();
                showTestResult(result.success ? 'success' : 'error', result.message || result.error);
            } catch (error) {
                showTestResult('error', 'Ошибка теста email: ' + error.message);
            }
        }



        // === НОВАЯ СИСТЕМА НАСТРОЕК ===
        
        // Переключение категорий настроек
        function initSettingsCategories() {
            const categoryTabs = document.querySelectorAll('.settings-category-tab');
            const categoryContents = document.querySelectorAll('.settings-category-content');

            categoryTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const category = tab.dataset.category;
                    
                    // Убираем активные классы
                    categoryTabs.forEach(t => {
                        t.classList.remove('active', 'text-minecraft-gold', 'border-minecraft-gold');
                        t.classList.add('text-gray-300', 'border-transparent');
                    });
                    categoryContents.forEach(c => c.classList.add('hidden'));
                    
                    // Добавляем активные классы
                    tab.classList.add('active', 'text-minecraft-gold', 'border-minecraft-gold');
                    tab.classList.remove('text-gray-300', 'border-transparent');
                    
                    // Показываем нужную категорию
                    const targetContent = document.getElementById(`settings-category-${category}`);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }
                });
            });
        }

        // Тултипы для полей настроек
        function initTooltips() {
            const tooltipElements = document.querySelectorAll('.tooltip-icon');
            
            tooltipElements.forEach(element => {
                const tooltipText = element.dataset.tooltip;
                if (!tooltipText) return;

                // Создаем элемент тултипа
                const tooltip = document.createElement('div');
                tooltip.className = 'absolute z-50 px-3 py-2 text-xs bg-gray-900 text-white rounded-lg shadow-lg border border-gray-700 max-w-xs';
                tooltip.style.display = 'none';
                tooltip.textContent = tooltipText;
                document.body.appendChild(tooltip);

                element.addEventListener('mouseenter', (e) => {
                    const rect = e.target.getBoundingClientRect();
                    tooltip.style.display = 'block';
                    tooltip.style.left = rect.left + 'px';
                    tooltip.style.top = (rect.bottom + 5) + 'px';
                });

                element.addEventListener('mouseleave', () => {
                    tooltip.style.display = 'none';
                });
            });
        }

        // Переключение видимости пароля
        function togglePasswordVisibility(inputId) {
            const passwordInput = document.getElementById(inputId);
            const eyeIcon = document.getElementById(inputId + '-eye');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.classList.remove('fa-eye');
                eyeIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                eyeIcon.classList.remove('fa-eye-slash');
                eyeIcon.classList.add('fa-eye');
            }
        }

        // Система шаблонов email
        async function initEmailTemplates() {
            const templateSelectors = document.querySelectorAll('.template-selector');
            const templateHtml = document.getElementById('template-html');
            const templateSubject = document.getElementById('template-subject');
            const currentTemplateName = document.getElementById('current-template-name');

            let templates = {};
            let currentTemplate = 'welcome';

            // Загружаем шаблоны из API
            try {
                const token = localStorage.getItem('auth_token') || localStorage.getItem('token');
                const response = await fetch('/api/admin/email-templates', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.templates) {
                        templates = data.templates;
                        console.log('Шаблоны загружены из базы данных:', Object.keys(templates));
                    }
                } else {
                    const errorText = await response.text();
                    console.warn('Не удалось загрузить шаблоны из API:', response.status, errorText);
                }
            } catch (error) {
                console.warn('Ошибка при загрузке шаблонов из API:', error);
            }

            // Если шаблоны не загрузились из API, используем шаблоны по умолчанию
            if (Object.keys(templates).length === 0) {
                templates = {
                'welcome': {
                    name: 'Приветственное письмо',
                    subject: 'Добро пожаловать на {{serverName}}!',
                    html: `<div style="max-width: 600px; margin: 0 auto; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 12px; padding: 40px; font-family: Arial, sans-serif; color: #ffffff;">
    
    <div style="text-align: center; margin-bottom: 40px; padding: 25px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 10px;">
        <h1 style="margin: 0; font-size: 28px; color: #000; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">{{serverName}}</h1>
        <p style="margin: 8px 0 0 0; color: #000; font-weight: 500;">Приватный Minecraft сервер</p>
    </div>
    
    <h2 style="color: #f59e0b; text-align: center; margin-bottom: 25px; font-size: 24px;">Добро пожаловать, {{nickname}}!</h2>
    
    <p style="font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        🎉 Поздравляем! Ваша регистрация на нашем Minecraft сервере была успешно завершена. Мы рады приветствовать вас в нашем дружелюбном сообществе!
    </p>
    
    <div style="background: rgba(248, 181, 0, 0.1); border-left: 4px solid #f8b500; padding: 20px; margin: 25px 0; border-radius: 5px;">
        <h3 style="margin: 0 0 15px 0; color: #f8b500; font-size: 18px;">📍 Информация для подключения:</h3>
        <ul style="margin: 0; padding-left: 20px; color: #e2e8f0;">
            <li style="margin-bottom: 8px;"><strong>IP сервера:</strong> {{serverIp}}:{{serverPort}}</li>
            <li style="margin-bottom: 8px;"><strong>Версия:</strong> Java Edition 1.20+</li>
            <li style="margin-bottom: 8px;"><strong>Режим:</strong> Выживание с улучшениями</li>
            <li><strong>Whitelist:</strong> Включен (вы уже добавлены)</li>
        </ul>
    </div>
    
    <div style="text-align: center; margin: 35px 0;">
        <a href="{{discordInvite}}" style="display: inline-block; padding: 15px 30px; background: linear-gradient(135deg, #5865f2 0%, #4752c4 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: bold; margin: 0 10px 10px 0; box-shadow: 0 4px 12px rgba(88, 101, 242, 0.3);">
            🎮 Discord сервер
        </a>
        <a href="{{telegramInvite}}" style="display: inline-block; padding: 15px 30px; background: linear-gradient(135deg, #0088cc 0%, #006bb3 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: bold; margin: 0 10px 10px 0; box-shadow: 0 4px 12px rgba(0, 136, 204, 0.3);">
            💬 Telegram чат
        </a>
    </div>
    
    <p style="font-size: 16px; line-height: 1.6; text-align: center; margin: 30px 0;">
        <strong style="color: #f8b500;">Увидимся в игре! 🎮</strong>
    </p>
    
    <hr style="border: none; border-top: 2px solid #f8b500; margin: 40px 0; opacity: 0.5;">
    
    <div style="text-align: center; color: #94a3b8; font-size: 14px;">
        <p style="margin: 5px 0;"><strong>С наилучшими пожеланиями,</strong></p>
        <p style="margin: 5px 0; color: #f8b500;">Команда {{serverName}}</p>
        <p style="margin: 15px 0 5px 0; font-size: 12px; opacity: 0.7;">
            Дата отправки: {{currentDate}}
        </p>
        <p style="margin: 5px 0; font-size: 12px; opacity: 0.7;">
            Это письмо отправлено автоматически, пожалуйста, не отвечайте на него.
        </p>
    </div>
</div>`
                },
                'verification': {
                    name: 'Подтверждение email',
                    subject: 'Подтверждение email адреса - {{serverName}}',
                    html: `<div style="max-width: 600px; margin: 0 auto; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 12px; padding: 40px; font-family: Arial, sans-serif; color: #ffffff;">
    
    <div style="text-align: center; margin-bottom: 40px; padding: 25px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 10px;">
        <h1 style="margin: 0; font-size: 28px; color: #000; font-weight: bold;">{{serverName}}</h1>
        <p style="margin: 8px 0 0 0; color: #000; font-weight: 500;">Подтверждение регистрации</p>
    </div>
    
    <h2 style="color: #10b981; text-align: center; margin-bottom: 25px; font-size: 24px;">🔐 Подтвердите ваш email</h2>
    
    <p style="font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        Привет, <strong style="color: #f8b500;">{{nickname}}</strong>!
    </p>
    
    <p style="font-size: 16px; line-height: 1.6; margin-bottom: 25px;">
        Для завершения регистрации на сервере <strong>{{serverName}}</strong> необходимо подтвердить ваш email адрес. 
        Это поможет нам защитить ваш аккаунт и уведомлять вас о важных событиях на сервере.
    </p>
    
    <div style="background: rgba(16, 185, 129, 0.1); border-left: 4px solid #10b981; padding: 20px; margin: 25px 0; border-radius: 5px;">
        <p style="margin: 0; color: #e2e8f0; font-size: 15px;">
            ⏰ <strong style="color: #10b981;">Важно:</strong> Ссылка для подтверждения действительна в течение <strong>24 часов</strong>. 
            После этого времени потребуется повторная регистрация.
        </p>
    </div>
    
    <div style="text-align: center; margin: 35px 0;">
        <a href="{{verificationLink}}" style="display: inline-block; padding: 18px 36px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; text-decoration: none; border-radius: 10px; font-weight: bold; font-size: 16px; box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4); transition: all 0.3s ease;">
            ✅ Подтвердить email адрес
        </a>
    </div>
    
    <div style="background: rgba(107, 114, 128, 0.1); border-radius: 8px; padding: 20px; margin: 25px 0;">
        <p style="margin: 0 0 10px 0; color: #9ca3af; font-size: 14px; line-height: 1.5;">
            <strong>Если кнопка не работает:</strong> Скопируйте и вставьте эту ссылку в адресную строку браузера:
        </p>
        <div style="background: #1f2937; padding: 12px; border-radius: 5px; border: 1px solid #374151; word-break: break-all;">
            <code style="color: #10b981; font-size: 13px; font-family: 'Courier New', monospace;">{{verificationLink}}</code>
        </div>
    </div>
    
    <hr style="border: none; border-top: 2px solid #10b981; margin: 40px 0; opacity: 0.5;">
    
    <div style="text-align: center; color: #94a3b8; font-size: 14px;">
        <p style="margin: 15px 0 5px 0; font-size: 13px; color: #6b7280;">
            🛡️ Если вы не регистрировались на нашем сервере, просто проигнорируйте это письмо.
        </p>
        <p style="margin: 5px 0; color: #10b981;">Команда {{serverName}}</p>
        <p style="margin: 15px 0 5px 0; font-size: 12px; opacity: 0.7;">{{currentDate}}</p>
    </div>
</div>`
                },
                'application-approved': {
                    name: 'Заявка одобрена',
                    subject: '🎉 Ваша заявка одобрена - {{serverName}}',
                    html: `<div style="max-width: 600px; margin: 0 auto; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 12px; padding: 40px; font-family: Arial, sans-serif; color: #ffffff;">
    
    <div style="text-align: center; margin-bottom: 40px; padding: 25px; background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); border-radius: 10px;">
        <h1 style="margin: 0; font-size: 28px; color: #000; font-weight: bold;">{{serverName}}</h1>
        <p style="margin: 8px 0 0 0; color: #000; font-weight: 500;">Заявка рассмотрена</p>
    </div>
    
    <div style="background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); padding: 25px; border-radius: 10px; text-align: center; margin-bottom: 30px;">
        <h2 style="margin: 0; font-size: 24px; color: #000; font-weight: bold;">🎉 Поздравляем! Заявка одобрена!</h2>
    </div>
    
    <p style="font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        Привет, <strong style="color: #f8b500;">{{nickname}}</strong>!
    </p>
    
    <p style="font-size: 16px; line-height: 1.6; margin-bottom: 25px;">
        🌟 Отличные новости! Ваша заявка на присоединение к серверу <strong>{{serverName}}</strong> была тщательно рассмотрена администрацией и <strong style="color: #16a34a;">одобрена</strong>!
    </p>
    
    <div style="background: rgba(34, 197, 94, 0.1); border-left: 4px solid #22c55e; padding: 20px; margin: 25px 0; border-radius: 5px;">
        <h3 style="margin: 0 0 15px 0; color: #22c55e; font-size: 18px;">🎮 Информация для игры:</h3>
        <ul style="margin: 0; padding-left: 20px; color: #e2e8f0;">
            <li style="margin-bottom: 8px;"><strong>IP сервера:</strong> {{serverIp}}:{{serverPort}}</li>
            <li style="margin-bottom: 8px;"><strong>Ваш статус:</strong> Участник сервера</li>
            <li style="margin-bottom: 8px;"><strong>Whitelist:</strong> Активирован для вашего аккаунта</li>
            <li><strong>Версия:</strong> Java Edition 1.20+</li>
        </ul>
    </div>
    
    <div style="text-align: center; margin: 35px 0;">
        <a href="{{discordInvite}}" style="display: inline-block; padding: 15px 30px; background: linear-gradient(135deg, #5865f2 0%, #4752c4 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: bold; margin: 0 10px 10px 0; box-shadow: 0 4px 12px rgba(88, 101, 242, 0.3);">
            💬 Discord сообщество
        </a>
        <a href="{{telegramInvite}}" style="display: inline-block; padding: 15px 30px; background: linear-gradient(135deg, #0088cc 0%, #006bb3 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: bold; margin: 0 10px 10px 0; box-shadow: 0 4px 12px rgba(0, 136, 204, 0.3);">
            📱 Telegram чат
        </a>
    </div>
    
    <p style="font-size: 16px; line-height: 1.6; text-align: center; margin: 30px 0;">
        <strong style="color: #22c55e;">Добро пожаловать в наше сообщество! 🏡</strong>
    </p>
    
    <hr style="border: none; border-top: 2px solid #22c55e; margin: 40px 0; opacity: 0.5;">
    
    <div style="text-align: center; color: #94a3b8; font-size: 14px;">
        <p style="margin: 5px 0;"><strong>Увидимся в игре!</strong></p>
        <p style="margin: 5px 0; color: #22c55e;">Команда {{serverName}}</p>
        <p style="margin: 15px 0 5px 0; font-size: 12px; opacity: 0.7;">{{currentDate}}</p>
    </div>
</div>`
                },
                'application-rejected': {
                    name: 'Заявка отклонена',
                    subject: '❌ О вашей заявке - {{serverName}}',
                    html: `<div style="max-width: 600px; margin: 0 auto; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 12px; padding: 40px; font-family: Arial, sans-serif; color: #ffffff;">
    
    <div style="text-align: center; margin-bottom: 40px; padding: 25px; background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); border-radius: 10px;">
        <h1 style="margin: 0; font-size: 28px; color: #fff; font-weight: bold;">{{serverName}}</h1>
        <p style="margin: 8px 0 0 0; color: #fff; font-weight: 500;">Результат рассмотрения заявки</p>
    </div>
    
    <h2 style="color: #dc2626; text-align: center; margin-bottom: 25px; font-size: 24px;">❌ Заявка не одобрена</h2>
    
    <p style="font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        Привет, <strong style="color: #f8b500;">{{nickname}}</strong>!
    </p>
    
    <p style="font-size: 16px; line-height: 1.6; margin-bottom: 25px;">
        К сожалению, ваша заявка на присоединение к серверу <strong>{{serverName}}</strong> не была одобрена на данный момент.
    </p>
    
    <div style="background: rgba(220, 38, 38, 0.1); border-left: 4px solid #dc2626; padding: 20px; margin: 25px 0; border-radius: 5px;">
        <h3 style="margin: 0 0 15px 0; color: #dc2626; font-size: 18px;">📝 Причина отклонения:</h3>
        <p style="margin: 0; color: #e2e8f0; font-size: 15px;">
            {{rejectionReason}}
        </p>
    </div>
    
    <div style="background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; padding: 20px; margin: 25px 0; border-radius: 5px;">
        <h3 style="margin: 0 0 15px 0; color: #3b82f6; font-size: 18px;">💡 Что можно сделать:</h3>
        <ul style="margin: 0; padding-left: 20px; color: #e2e8f0;">
            <li style="margin-bottom: 8px;">Подать заявку повторно через <strong>7 дней</strong></li>
            <li style="margin-bottom: 8px;">Доработать мотивационное письмо</li>
            <li style="margin-bottom: 8px;">Ознакомиться с правилами сервера</li>
            <li>Обратиться к администрации за советом</li>
        </ul>
    </div>
    
    <div style="text-align: center; margin: 35px 0;">
        <a href="{{discordInvite}}" style="display: inline-block; padding: 15px 30px; background: linear-gradient(135deg, #5865f2 0%, #4752c4 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: bold; margin: 0 10px 10px 0; box-shadow: 0 4px 12px rgba(88, 101, 242, 0.3);">
            💬 Связаться с администрацией
        </a>
    </div>
    
    <p style="font-size: 16px; line-height: 1.6; text-align: center; margin: 30px 0; color: #94a3b8;">
        Не расстраивайтесь! У вас будет возможность подать заявку снова.
    </p>
    
    <hr style="border: none; border-top: 2px solid #dc2626; margin: 40px 0; opacity: 0.5;">
    
    <div style="text-align: center; color: #94a3b8; font-size: 14px;">
        <p style="margin: 5px 0;">С уважением,</p>
        <p style="margin: 5px 0; color: #dc2626;">Администрация {{serverName}}</p>
        <p style="margin: 15px 0 5px 0; font-size: 12px; opacity: 0.7;">{{currentDate}}</p>
        <div style="margin-top: 15px;">
            <p style="margin: 5px 0;">С уважением,</p>
            <p style="margin: 5px 0; color: #dc2626;">Администрация {{serverName}}</p>
            <p style="margin: 15px 0 5px 0; font-size: 12px; opacity: 0.7;">{{currentDate}}</p>
        </div>
    </div>
</div>`
                },
                'password-reset': {
                    name: 'Сброс пароля',
                    subject: '🔑 Восстановление пароля - {{serverName}}',
                    html: `<div style="max-width: 600px; margin: 0 auto; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 12px; padding: 40px; font-family: Arial, sans-serif; color: #ffffff;">
    
    <div style="text-align: center; margin-bottom: 40px; padding: 25px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 10px;">
        <h1 style="margin: 0; font-size: 28px; color: #000; font-weight: bold;">{{serverName}}</h1>
        <p style="margin: 8px 0 0 0; color: #000; font-weight: 500;">Восстановление доступа</p>
    </div>
    
    <h2 style="color: #f59e0b; text-align: center; margin-bottom: 25px; font-size: 24px;">🔑 Восстановление пароля</h2>
    
    <p style="font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        Привет, <strong style="color: #f8b500;">{{nickname}}</strong>!
    </p>
    
    <p style="font-size: 16px; line-height: 1.6; margin-bottom: 25px;">
        Мы получили запрос на восстановление пароля для вашего аккаунта на сервере <strong>{{serverName}}</strong>. 
        Если это были вы, нажмите кнопку ниже для создания нового пароля.
    </p>
    
    <div style="background: rgba(245, 158, 11, 0.1); border-left: 4px solid #f59e0b; padding: 20px; margin: 25px 0; border-radius: 5px;">
        <p style="margin: 0; color: #e2e8f0; font-size: 15px;">
            ⏰ <strong style="color: #f59e0b;">Важно:</strong> Ссылка для восстановления действительна в течение <strong>1 часа</strong>. 
            После этого времени потребуется новый запрос на восстановление.
        </p>
    </div>
    
    <div style="text-align: center; margin: 35px 0;">
        <a href="{{resetLink}}" style="display: inline-block; padding: 18px 36px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; text-decoration: none; border-radius: 10px; font-weight: bold; font-size: 16px; box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);">
            🔐 Создать новый пароль
        </a>
    </div>
    
    <div style="background: rgba(107, 114, 128, 0.1); border-radius: 8px; padding: 20px; margin: 25px 0;">
        <p style="margin: 0 0 10px 0; color: #9ca3af; font-size: 14px; line-height: 1.5;">
            <strong>Если кнопка не работает:</strong> Скопируйте и вставьте эту ссылку в адресную строку браузера:
        </p>
        <div style="background: #1f2937; padding: 12px; border-radius: 5px; border: 1px solid #374151; word-break: break-all;">
            <code style="color: #f59e0b; font-size: 13px; font-family: 'Courier New', monospace;">{{resetLink}}</code>
        </div>
    </div>
    
    <div style="background: rgba(239, 68, 68, 0.1); border-left: 4px solid #ef4444; padding: 20px; margin: 25px 0; border-radius: 5px;">
        <p style="margin: 0; color: #e2e8f0; font-size: 15px;">
            🛡️ <strong style="color: #ef4444;">Безопасность:</strong> Если вы не запрашивали восстановление пароля, 
            просто проигнорируйте это письмо. Ваш текущий пароль останется неизменным.
        </p>
    </div>
    
    <hr style="border: none; border-top: 2px solid #f59e0b; margin: 40px 0; opacity: 0.5;">
    
    <div style="text-align: center; color: #94a3b8; font-size: 14px;">
        <p style="margin: 5px 0;">С уважением,</p>
        <p style="margin: 5px 0; color: #f59e0b;">Команда {{serverName}}</p>
        <p style="margin: 15px 0 5px 0; font-size: 12px; opacity: 0.7;">{{currentDate}}</p>
    </div>
</div>`
                },
                'newsletter': {
                    name: 'Новостная рассылка',
                    subject: '📰 Новости {{serverName}} - {{newsletterTitle}}',
                    html: `<div style="max-width: 600px; margin: 0 auto; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 12px; padding: 40px; font-family: Arial, sans-serif; color: #ffffff;">
    
    <div style="text-align: center; margin-bottom: 40px; padding: 25px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border-radius: 10px; border-bottom: 3px solid #f8b500;">
        <h1 style="margin: 0; font-size: 28px; color: #000; font-weight: bold;">{{serverName}}</h1>
        <p style="margin: 8px 0 0 0; color: #000; font-weight: 500;">Новости и обновления</p>
    </div>
    
    <h2 style="color: #8b5cf6; text-align: center; margin-bottom: 25px; font-size: 24px;">📰 {{newsletterTitle}}</h2>
    
    <p style="font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        Привет, <strong style="color: #f8b500;">{{nickname}}</strong>!
    </p>
    
    <p style="font-size: 16px; line-height: 1.6; margin-bottom: 30px;">
        🎯 У нас есть интересные новости и обновления для нашего сообщества на сервере <strong>{{serverName}}</strong>!
    </p>
    
    <div style="background: rgba(139, 92, 246, 0.1); border-left: 4px solid #8b5cf6; padding: 25px; margin: 30px 0; border-radius: 8px;">
        <h3 style="margin: 0 0 15px 0; color: #8b5cf6; font-size: 20px;">📢 {{newsTitle1}}</h3>
        <p style="margin: 0; color: #e2e8f0; font-size: 16px; line-height: 1.6;">
            {{newsContent1}}
        </p>
    </div>
    
    <div style="background: rgba(34, 197, 94, 0.1); border-left: 4px solid #22c55e; padding: 25px; margin: 30px 0; border-radius: 8px;">
        <h3 style="margin: 0 0 15px 0; color: #22c55e; font-size: 20px;">🚀 {{newsTitle2}}</h3>
        <p style="margin: 0; color: #e2e8f0; font-size: 16px; line-height: 1.6;">
            {{newsContent2}}
        </p>
    </div>
    
    <div style="text-align: center; margin: 40px 0;">
        <a href="{{serverLink}}" style="display: inline-block; padding: 15px 30px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: bold; margin: 0 10px 10px 0; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);">
            🎮 Играть сейчас
        </a>
        <a href="{{discordInvite}}" style="display: inline-block; padding: 15px 30px; background: linear-gradient(135deg, #5865f2 0%, #4752c4 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: bold; margin: 0 10px 10px 0; box-shadow: 0 4px 12px rgba(88, 101, 242, 0.3);">
            💬 Discord
        </a>
        <a href="{{telegramInvite}}" style="display: inline-block; padding: 15px 30px; background: linear-gradient(135deg, #0088cc 0%, #006bb3 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: bold; margin: 0 10px 10px 0; box-shadow: 0 4px 12px rgba(0, 136, 204, 0.3);">
            📱 Telegram
        </a>
    </div>
    
    <hr style="border: none; border-top: 2px solid #8b5cf6; margin: 40px 0; opacity: 0.5;">
    
    <div style="text-align: center; color: #94a3b8; font-size: 14px;">
        <p style="margin: 5px 0;"><strong>С наилучшими пожеланиями,</strong></p>
        <p style="margin: 5px 0; color: #8b5cf6;">Команда {{serverName}}</p>
        <p style="margin: 15px 0 5px 0; font-size: 12px; opacity: 0.7;">{{currentDate}}</p>
        <p style="margin: 10px 0; font-size: 12px;">
            <a href="{{unsubscribeLink}}" style="color: #94a3b8; text-decoration: underline;">Отписаться от рассылки</a>
        </p>
    </div>
</div>`
                }
            };
            }

            // Загружаем шаблон в визуальный редактор
            function loadTemplate(templateKey) {
                const template = templates[templateKey];
                if (template) {
                    document.getElementById('template-subject').value = template.subject;
                    document.getElementById('current-template-name').textContent = template.name;
                    currentTemplate = templateKey;
                    
                    // Обновляем визуальный редактор
                    if (quillEditor && quillEditor.root) {
                        try {
                            // Очищаем редактор перед обновлением
                            quillEditor.setContents([]);
                            // Устанавливаем новое содержимое
                            quillEditor.clipboard.dangerouslyPasteHTML(template.html);
                        } catch (error) {
                            console.warn('Ошибка обновления Quill редактора:', error);
                            // Fallback - обновляем через innerHTML
                            if (quillEditor.root) {
                                quillEditor.root.innerHTML = template.html;
                            }
                        }
                    }
                }
            }

            // Обработчики выбора шаблона
            templateSelectors.forEach(selector => {
                selector.addEventListener('click', () => {
                    templateSelectors.forEach(s => s.classList.remove('border-minecraft-gold', 'bg-minecraft-gold/10'));
                    selector.classList.add('border-minecraft-gold', 'bg-minecraft-gold/10');
                    
                    const templateKey = selector.dataset.template;
                    loadTemplate(templateKey);
                });
            });

            // Обработчик сохранения шаблона (только визуальный редактор)
            const saveTemplateBtn = document.getElementById('save-template-btn');
            if (saveTemplateBtn) {
                saveTemplateBtn.addEventListener('click', async () => {
                    try {
                        if (!quillEditor) {
                            showNotification('error', 'Редактор не инициализирован');
                            return;
                        }

                        const templateHtml = quillEditor.root.innerHTML;
                        const templateSubject = document.getElementById('template-subject').value;
                        const currentTemplateName = document.getElementById('current-template-name').textContent;

                        if (!templateHtml.trim() || templateHtml === '<p><br></p>') {
                            showNotification('error', 'Содержание шаблона не может быть пустым');
                            return;
                        }

                        if (!templateSubject.trim()) {
                            showNotification('error', 'Тема письма не может быть пустой');
                            return;
                        }

                        const token = localStorage.getItem('auth_token') || localStorage.getItem('token');
                        const response = await fetch('/api/admin/email-templates', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                templateKey: currentTemplate,
                                html: templateHtml,
                                subject: templateSubject,
                                name: currentTemplateName
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            showNotification('success', 'Шаблон успешно сохранен в базе данных');
                            
                            // Обновляем локальные шаблоны
                            templates[currentTemplate] = {
                                name: currentTemplateName,
                                subject: templateSubject,
                                html: templateHtml
                            };
                        } else {
                            const error = await response.json();
                            showNotification('error', error.error || 'Ошибка сохранения шаблона');
                        }
                    } catch (error) {
                        console.error('Ошибка сохранения шаблона:', error);
                        showNotification('error', 'Ошибка при сохранении шаблона');
                    }
                });
            }

            // Обработчик сброса шаблона
            const resetTemplateBtn = document.getElementById('reset-template-btn');
            if (resetTemplateBtn) {
                resetTemplateBtn.addEventListener('click', () => {
                    if (confirm('Вы уверены, что хотите сбросить все изменения? Несохраненные данные будут потеряны.')) {
                        loadTemplate(currentTemplate);
                        showNotification('info', 'Шаблон сброшен к последней сохраненной версии');
                    }
                });
            }

            // Загружаем первый шаблон по умолчанию
            loadTemplate('welcome');
        }

        // Вставка готовых блоков в шаблон
        function insertTemplate(type) {
            const templateHtml = document.getElementById('template-html');
            const cursorPos = templateHtml.selectionStart;
            const textBefore = templateHtml.value.substring(0, cursorPos);
            const textAfter = templateHtml.value.substring(templateHtml.selectionEnd);
            
            let insertText = '';
            
            switch(type) {
                case 'username':
                    insertText = '<p>Привет, {{username}}!</p>';
                    break;
                case 'button':
                    insertText = '<p style="text-align: center;"><a href="#" class="button">Нажми меня</a></p>';
                    break;
                case 'footer':
                    insertText = `<div class="footer">
    <p>С наилучшими пожеланиями,<br>Команда {{serverName}}</p>
    <p>{{currentDate}}</p>
</div>`;
                    break;
            }
            
            templateHtml.value = textBefore + insertText + textAfter;
            templateHtml.focus();
            templateHtml.setSelectionRange(cursorPos + insertText.length, cursorPos + insertText.length);
        }

        // Предпросмотр шаблона
        function previewTemplate() {
            const templateHtml = document.getElementById('template-html').value;
            const newWindow = window.open('', '_blank');
            newWindow.document.write(templateHtml);
            newWindow.document.close();
        }

        // Тестовая отправка выбранного шаблона из SMTP настроек
        async function testEmailWithTemplate() {
            const templateKey = document.getElementById('test-email-template').value;
            const userModeActive = !document.getElementById('user-selector-container').classList.contains('hidden');
            
            let recipientData = {};
            
            if (userModeActive) {
                // Режим выбора пользователя
                const selectedUserId = document.getElementById('test-email-user').value;
                if (!selectedUserId) {
                    showNotification('error', 'Выберите пользователя из списка');
                    return;
                }
                recipientData.userId = parseInt(selectedUserId);
            } else {
                // Режим ввода email
                const recipientEmail = document.getElementById('test-email-recipient').value;
                if (!recipientEmail || !recipientEmail.includes('@')) {
                    showNotification('error', 'Введите корректный email получателя');
                    return;
                }
                recipientData.recipientEmail = recipientEmail;
            }
            
            if (!templateKey) {
                showNotification('error', 'Выберите шаблон для отправки');
                return;
            }
            
            const testButton = document.getElementById('test-email-btn');
            const originalText = testButton.innerHTML;
            testButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Отправка...';
            testButton.disabled = true;
            
            try {
                const requestBody = {
                    templateKey: templateKey,
                    ...recipientData
                };
                
                const response = await fetch('/api/admin/test-email-with-template', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    },
                    body: JSON.stringify(requestBody)
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification('success', result.message || 'Тестовое письмо успешно отправлено!');
                    document.getElementById('email-test-result').classList.remove('hidden');
                    document.getElementById('email-test-result').className = 'p-4 rounded-lg bg-green-500/10 border border-green-500/30';
                    
                    // Формируем детальную информацию
                    let recipientInfo = '';
                    if (result.details.recipientInfo) {
                        recipientInfo = ` (${result.details.recipientInfo.nickname}, ${result.details.recipientInfo.role})`;
                    }
                    
                    document.getElementById('email-test-result').innerHTML = `
                        <div class="text-green-400 font-medium">✅ ${result.details.templateName} отправлен</div>
                        <div class="text-sm text-gray-300 mt-1">
                            📧 Получатель: ${result.details.recipient}${recipientInfo}<br>
                            📝 Тема: ${result.details.subject}<br>
                            🔧 Переменных заменено: ${result.details.variablesReplaced}
                        </div>
                    `;
                } else {
                    const error = await response.json();
                    console.error('Error response:', error);
                    
                    let errorMessage = error.error || 'Неизвестная ошибка';
                    
                    // Специальная обработка для блокировки SPAM
                    if (error.yandexBlockingInfo) {
                        errorMessage = `🚫 ${error.error}\n\n📋 Рекомендации:\n${error.yandexBlockingInfo.recommendations.map(r => `• ${r}`).join('\n')}`;
                    }
                    
                    // Обработка кулдауна
                    if (response.status === 429) {
                        errorMessage = `⏱️ ${error.error}`;
                        if (error.cooldownRemaining) {
                            // Добавляем обратный отсчет
                            showCooldownTimer(error.cooldownRemaining);
                        }
                    }
                    
                    showNotification('error', errorMessage.length > 200 ? 'Ошибка отправки (см. консоль)' : errorMessage);
                    document.getElementById('email-test-result').classList.remove('hidden');
                    document.getElementById('email-test-result').className = 'p-4 rounded-lg bg-red-500/10 border border-red-500/30';
                    document.getElementById('email-test-result').innerHTML = `
                        <div class="text-red-400 font-medium">❌ Ошибка отправки</div>
                        <div class="text-sm text-gray-300 mt-1 whitespace-pre-line">${errorMessage}</div>
                    `;
                }
            } catch (error) {
                console.error('Network error:', error);
                showNotification('error', 'Ошибка сети: ' + error.message);
                document.getElementById('email-test-result').classList.remove('hidden');
                document.getElementById('email-test-result').className = 'p-4 rounded-lg bg-red-500/10 border border-red-500/30';
                document.getElementById('email-test-result').innerHTML = `
                    <div class="text-red-400 font-medium">❌ Ошибка сети</div>
                    <div class="text-sm text-gray-300 mt-1">${error.message}</div>
                `;
            } finally {
                testButton.innerHTML = originalText;
                testButton.disabled = false;
            }
        }
        
        // Функция показа обратного отсчета кулдауна
        function showCooldownTimer(seconds) {
            const testButton = document.getElementById('test-email-btn');
            const originalText = testButton.innerHTML;
            
            function updateTimer() {
                if (seconds <= 0) {
                    testButton.innerHTML = originalText;
                    testButton.disabled = false;
                    return;
                }
                
                testButton.innerHTML = `<i class="fas fa-clock mr-2"></i>Подождите ${seconds}с`;
                testButton.disabled = true;
                seconds--;
                setTimeout(updateTimer, 1000);
            }
            
            updateTimer();
        }

        // Инициализация новой системы настроек
        document.addEventListener('DOMContentLoaded', () => {
            initSettingsCategories();
            initTooltips();
            initEmailTemplates();
            initEmailTesting();

            // Обработчики кнопок в разделе шаблонов
            const previewBtn = document.getElementById('preview-template-btn');
            const testEmailBtn = document.getElementById('test-email-btn');
            
            if (previewBtn) {
                previewBtn.addEventListener('click', previewTemplate);
            }
            
            if (testEmailBtn) {
                testEmailBtn.addEventListener('click', testEmailWithTemplate);
            }

            // Показываем первую категорию по умолчанию
            const firstTab = document.querySelector('.settings-category-tab[data-category="general"]');
            if (firstTab) {
                firstTab.click();
            }

            // Загружаем сохраненные настройки
            loadAllSettings();
        });

        // Инициализация системы тестирования email
        async function initEmailTesting() {
            // Переключатели режимов
            const userModeBtn = document.getElementById('user-mode-btn');
            const emailModeBtn = document.getElementById('email-mode-btn');
            const userContainer = document.getElementById('user-selector-container');
            const emailContainer = document.getElementById('email-input-container');
            
            if (userModeBtn && emailModeBtn) {
                userModeBtn.addEventListener('click', () => {
                    switchToUserMode(userModeBtn, emailModeBtn, userContainer, emailContainer);
                });
                
                emailModeBtn.addEventListener('click', () => {
                    switchToEmailMode(userModeBtn, emailModeBtn, userContainer, emailContainer);
                });
            }
            
            // Загружаем список пользователей
            await loadUsersForEmailTesting();
        }

        // Переключение в режим выбора пользователя
        function switchToUserMode(userBtn, emailBtn, userContainer, emailContainer) {
            userBtn.className = userBtn.className.replace('text-gray-300 hover:bg-minecraft-gold/10', 'bg-minecraft-gold text-black font-medium');
            emailBtn.className = emailBtn.className.replace('bg-minecraft-gold text-black font-medium', 'text-gray-300 hover:bg-minecraft-gold/10');
            
            userContainer.classList.remove('hidden');
            emailContainer.classList.add('hidden');
        }

        // Переключение в режим ввода email
        function switchToEmailMode(userBtn, emailBtn, userContainer, emailContainer) {
            emailBtn.className = emailBtn.className.replace('text-gray-300 hover:bg-minecraft-gold/10', 'bg-minecraft-gold text-black font-medium');
            userBtn.className = userBtn.className.replace('bg-minecraft-gold text-black font-medium', 'text-gray-300 hover:bg-minecraft-gold/10');
            
            emailContainer.classList.remove('hidden');
            userContainer.classList.add('hidden');
        }

        // Загрузка пользователей для тестирования email
        async function loadUsersForEmailTesting() {
            const userSelect = document.getElementById('test-email-user');
            if (!userSelect) return;
            
            try {
                const response = await fetch('/api/admin/users-for-email', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Очищаем и заполняем список
                    userSelect.innerHTML = '<option value="">Выберите пользователя...</option>';
                    
                    data.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.displayName;
                        option.dataset.email = user.email;
                        option.dataset.nickname = user.nickname;
                        option.dataset.role = user.role;
                        userSelect.appendChild(option);
                    });
                    
                    console.log(`✅ Загружено ${data.users.length} пользователей для тестирования email`);
                } else {
                    userSelect.innerHTML = '<option value="">❌ Ошибка загрузки пользователей</option>';
                    console.error('Ошибка загрузки пользователей:', response.status);
                }
            } catch (error) {
                userSelect.innerHTML = '<option value="">❌ Ошибка соединения</option>';
                console.error('Ошибка загрузки пользователей:', error);
            }
        }

        // Загрузка всех настроек с сервера
        async function loadAllSettings() {
            try {
                const response = await fetch('/api/admin/settings', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        populateSettingsForm(data.settings);
                        console.log(`✅ Загружено ${data.totalSettings} настроек`);
                    }
                } else {
                    console.warn('Не удалось загрузить настройки:', response.status);
                }
            } catch (error) {
                console.error('Ошибка загрузки настроек:', error);
            }
        }

        // Заполнение формы настроек данными с сервера
        function populateSettingsForm(settings) {
            // Основные настройки
            setElementValue('server-name', settings.serverName);
            setElementValue('server-description', settings.serverDescription);
            setElementValue('server-ip', settings.serverIp);
            setElementValue('server-port', settings.serverPort);
            setElementValue('max-players', settings.maxPlayers);
            setElementValue('discord-invite', settings.discordInvite);
            setElementValue('telegram-invite', settings.telegramInvite);

            // Системные настройки
            setElementChecked('maintenance-mode', settings.maintenanceMode);
            setElementChecked('registration-enabled', settings.registrationEnabled);
            setElementChecked('auto-backup-enabled', settings.autoBackupEnabled);

            // Настройки заявок
            setElementChecked('applications-enabled', settings.applicationsEnabled);
            setElementValue('min-motivation-length', settings.minMotivationLength);
            setElementValue('min-plans-length', settings.minPlansLength);
            setElementValue('max-applications-per-day', settings.maxApplicationsPerDay);
            setElementValue('auto-approve-trust-level', settings.autoApproveTrustLevel);

            // Trust Level система
            setElementValue('trust-points-email', settings.trustPointsEmail);
            setElementValue('trust-points-discord', settings.trustPointsDiscord);
            setElementValue('trust-points-hour', settings.trustPointsHour);
            setElementValue('trust-points-reputation', settings.trustPointsReputation);
            setElementValue('trust-minimum-hours', settings.trustMinimumHours);
            setElementValue('trust-minimum-reputation', settings.trustMinimumReputation);
            setElementValue('trust-level-1-required', settings.trustLevel1Required);
            setElementValue('trust-level-2-required', settings.trustLevel2Required);
            setElementValue('trust-level-3-required', settings.trustLevel3Required);

            // Настройки безопасности
            setElementValue('max-login-attempts', settings.maxLoginAttempts);
            setElementValue('login-lockout-duration', settings.loginLockoutDuration);
            setElementValue('jwt-expires-days', settings.jwtExpiresDays);
            setElementValue('require-email-verification', settings.requireEmailVerification);
            setElementChecked('two-factor-enabled', settings.twoFactorEnabled);
            setElementValue('rate-limit-requests', settings.rateLimitRequests);

            // Email настройки
            setElementValue('smtp-host', settings.smtpHost);
            setElementValue('smtp-port', settings.smtpPort);
            setElementValue('smtp-from', settings.smtpFrom);
            setElementValue('smtp-user', settings.smtpUser);
            setElementValue('smtp-password', settings.smtpPassword);
            setElementChecked('smtp-tls', settings.smtpTls);
            setElementValue('smtp-sender-name', settings.smtpSenderName);
            setElementValue('smtp-reply-to', settings.smtpReplyTo);
            setElementChecked('email-notifications-enabled', settings.emailNotificationsEnabled);
            setElementValue('smtp-timeout', settings.smtpTimeout);
        }

        // Вспомогательные функции для установки значений
        function setElementValue(id, value) {
            const element = document.getElementById(id);
            if (element && value !== undefined && value !== null) {
                element.value = value;
            }
        }

        function setElementChecked(id, value) {
            const element = document.getElementById(id);
            if (element && typeof value === 'boolean') {
                element.checked = value;
            }
        }

        // Обновленная функция сохранения настроек
        async function saveAllSettings() {
            const token = localStorage.getItem('auth_token');
            const saveBtn = document.getElementById('save-settings-btn');
            
            // Показываем индикатор загрузки
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Сохранение...';
            saveBtn.disabled = true;
            
            try {
                // Собираем все настройки из формы
                const settingsData = {
                    // Основные настройки
                    serverName: document.getElementById('server-name')?.value,
                    serverDescription: document.getElementById('server-description')?.value,
                    serverIp: document.getElementById('server-ip')?.value,
                    serverPort: parseInt(document.getElementById('server-port')?.value),
                    maxPlayers: parseInt(document.getElementById('max-players')?.value),
                    discordInvite: document.getElementById('discord-invite')?.value,
                    telegramInvite: document.getElementById('telegram-invite')?.value,
                    
                    // Системные настройки
                    maintenanceMode: document.getElementById('maintenance-mode')?.checked,
                    registrationEnabled: document.getElementById('registration-enabled')?.checked,
                    autoBackupEnabled: document.getElementById('auto-backup-enabled')?.checked,
                    
                    // Настройки заявок
                    applicationsEnabled: document.getElementById('applications-enabled')?.checked,
                    minMotivationLength: parseInt(document.getElementById('min-motivation-length')?.value),
                    minPlansLength: parseInt(document.getElementById('min-plans-length')?.value),
                    maxApplicationsPerDay: parseInt(document.getElementById('max-applications-per-day')?.value),
                    autoApproveTrustLevel: parseInt(document.getElementById('auto-approve-trust-level')?.value),
                    
                    // Trust Level настройки
                    trustPointsEmail: parseInt(document.getElementById('trust-points-email')?.value),
                    trustPointsDiscord: parseInt(document.getElementById('trust-points-discord')?.value),
                    trustPointsHour: parseInt(document.getElementById('trust-points-hour')?.value),
                    trustPointsReputation: parseInt(document.getElementById('trust-points-reputation')?.value),
                    trustMinimumHours: parseInt(document.getElementById('trust-minimum-hours')?.value),
                    trustMinimumReputation: parseInt(document.getElementById('trust-minimum-reputation')?.value),
                    trustLevel1Required: parseInt(document.getElementById('trust-level-1-required')?.value),
                    trustLevel2Required: parseInt(document.getElementById('trust-level-2-required')?.value),
                    trustLevel3Required: parseInt(document.getElementById('trust-level-3-required')?.value),
                    
                    // Настройки безопасности
                    maxLoginAttempts: parseInt(document.getElementById('max-login-attempts')?.value),
                    loginLockoutDuration: parseInt(document.getElementById('login-lockout-duration')?.value),
                    jwtExpiresDays: parseInt(document.getElementById('jwt-expires-days')?.value),
                    requireEmailVerification: document.getElementById('require-email-verification')?.value === 'true',
                    twoFactorEnabled: document.getElementById('two-factor-enabled')?.checked,
                    rateLimitRequests: parseInt(document.getElementById('rate-limit-requests')?.value),
                    
                    // Email настройки
                    smtpHost: document.getElementById('smtp-host')?.value,
                    smtpPort: parseInt(document.getElementById('smtp-port')?.value),
                    smtpFrom: document.getElementById('smtp-from')?.value,
                    smtpUser: document.getElementById('smtp-user')?.value,
                    smtpPassword: document.getElementById('smtp-password')?.value,
                    smtpTls: document.getElementById('smtp-tls')?.checked,
                    smtpSenderName: document.getElementById('smtp-sender-name')?.value,
                    smtpReplyTo: document.getElementById('smtp-reply-to')?.value,
                    emailNotificationsEnabled: document.getElementById('email-notifications-enabled')?.checked,
                    smtpTimeout: parseInt(document.getElementById('smtp-timeout')?.value)
                };

                const response = await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(settingsData)
                });

                if (response.ok) {
                    const data = await response.json();
                    showNotification('success', data.message || 'Настройки успешно сохранены!');
                } else {
                    const error = await response.json();
                    showNotification('error', 'Ошибка: ' + (error.error || 'Неизвестная ошибка'));
                }

            } catch (error) {
                console.error('Ошибка сохранения настроек:', error);
                showNotification('error', 'Ошибка соединения с сервером');
            } finally {
                // Восстанавливаем кнопку
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        // Обновляем обработчик кнопки сохранения
        document.addEventListener('DOMContentLoaded', () => {
            const saveBtn = document.getElementById('save-settings-btn');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveAllSettings);
            }
        });
        
        // Функции для работы с визуальным редактором
        function initializeQuillEditor() {
            if (typeof Quill !== 'undefined') {
                const quillContainer = document.getElementById('quill-editor');
                if (quillContainer && !quillEditor) {
                    try {
                        // Создаем профессиональный Quill редактор с полным функционалом
                        quillEditor = new Quill('#quill-editor', {
                            theme: 'snow',
                            modules: {
                                toolbar: [
                                    [{ 'header': [1, 2, 3, false] }],
                                    [{ 'font': [] }],
                                    [{ 'size': ['small', false, 'large', 'huge'] }],
                                    ['bold', 'italic', 'underline', 'strike'],
                                    [{ 'color': [] }, { 'background': [] }],
                                    [{ 'script': 'sub'}, { 'script': 'super' }],
                                    [{ 'list': 'ordered'}, { 'list': 'bullet' }, { 'list': 'check' }],
                                    [{ 'indent': '-1'}, { 'indent': '+1' }],
                                    [{ 'direction': 'rtl' }],
                                    [{ 'align': [] }],
                                    ['link', 'image', 'video', 'formula'],
                                    ['blockquote', 'code-block'],
                                    ['clean']
                                ]
                            },
                            placeholder: 'Создайте профессиональное содержание вашего письма...',
                            formats: [
                                'header', 'font', 'size',
                                'bold', 'italic', 'underline', 'strike',
                                'color', 'background',
                                'script',
                                'list', 'bullet', 'check',
                                'indent',
                                'direction', 'align',
                                'link', 'image', 'video', 'formula',
                                'blockquote', 'code-block'
                            ]
                        });
                        
                        // Настройка темной темы для Quill
                        const quillDiv = document.querySelector('#quill-editor .ql-editor');
                        if (quillDiv) {
                            quillDiv.style.backgroundColor = '#1a1a1a';
                            quillDiv.style.color = '#e5e5e5';
                            quillDiv.style.border = '1px solid #444';
                        }
                        
                        // Кастомизация тулбара
                        const toolbar = document.querySelector('#quill-editor .ql-toolbar');
                        if (toolbar) {
                            toolbar.style.backgroundColor = '#2a2a2a';
                            toolbar.style.border = '1px solid #444';
                            toolbar.style.borderBottom = 'none';
                        }
                        
                        // Улучшенные цвета для dropdown
                        const colorPickers = document.querySelectorAll('.ql-color .ql-picker-options, .ql-background .ql-picker-options');
                        colorPickers.forEach(picker => {
                            picker.style.backgroundColor = '#2a2a2a';
                            picker.style.border = '1px solid #444';
                        });
                        
                        // Синхронизация с HTML редактором
                        if (quillEditor && quillEditor.on) {
                            quillEditor.on('text-change', function() {
                                if (isVisualMode) {
                                    const templateHtmlEl = document.getElementById('template-html');
                                    if (templateHtmlEl) {
                                        templateHtmlEl.value = quillEditor.root.innerHTML;
                                    }
                                }
                            });
                        }
                        
                        console.log('Quill редактор успешно инициализирован');
                    } catch (error) {
                        console.error('Ошибка инициализации Quill редактора:', error);
                        quillEditor = null;
                    }
                }
            } else {
                console.warn('Quill.js не загружен');
            }
        }
                
        function switchToVisualMode() {
            isVisualMode = true;
            document.getElementById('visual-mode-btn').className = document.getElementById('visual-mode-btn').className.replace('text-gray-300', 'bg-minecraft-gold text-black');
            document.getElementById('html-mode-btn').className = document.getElementById('html-mode-btn').className.replace('bg-minecraft-gold text-black', 'text-gray-300');
            
            document.getElementById('visual-editor-container').classList.remove('hidden');
            document.getElementById('html-editor-container').classList.add('hidden');
            
            // Синхронизируем содержимое с HTML редактора
            if (quillEditor) {
                const htmlContent = document.getElementById('template-html').value;
                quillEditor.root.innerHTML = htmlContent;
            }
        }
        
        function switchToHtmlMode() {
            isVisualMode = false;
            document.getElementById('html-mode-btn').className = document.getElementById('html-mode-btn').className.replace('text-gray-300', 'bg-minecraft-gold text-black');
            document.getElementById('visual-mode-btn').className = document.getElementById('visual-mode-btn').className.replace('bg-minecraft-gold text-black', 'text-gray-300');
            
            document.getElementById('html-editor-container').classList.remove('hidden');
            document.getElementById('visual-editor-container').classList.add('hidden');
            
            // Синхронизируем содержимое с визуального редактора
            if (quillEditor) {
                document.getElementById('template-html').value = quillEditor.root.innerHTML;
            }
        }
        
        function insertVariable(variable) {
            const variableText = `{{${variable}}}`;
            
            if (isVisualMode && quillEditor) {
                const range = quillEditor.getSelection();
                if (range) {
                    quillEditor.insertText(range.index, variableText);
                } else {
                    quillEditor.insertText(quillEditor.getLength(), variableText);
                }
            } else {
                const htmlTextarea = document.getElementById('template-html');
                const cursorPos = htmlTextarea.selectionStart;
                const textBefore = htmlTextarea.value.substring(0, cursorPos);
                const textAfter = htmlTextarea.value.substring(cursorPos);
                htmlTextarea.value = textBefore + variableText + textAfter;
                htmlTextarea.selectionStart = htmlTextarea.selectionEnd = cursorPos + variableText.length;
                htmlTextarea.focus();
            }
        }
        
        function insertQuickBlock(blockType) {
            let blockHtml = '';
            
            switch(blockType) {
                case 'header':
                    blockHtml = `
                        <div style="background: #f8b500; color: white; padding: 20px; text-align: center; margin-bottom: 20px;">
                            <h1 style="margin: 0; font-size: 24px;">{{serverName}}</h1>
                        </div>
                    `;
                    break;
                case 'button':
                    blockHtml = `
                        <div style="text-align: center; margin: 20px 0;">
                            <a href="#" style="display: inline-block; background: #f8b500; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; font-weight: bold;">Кнопка действия</a>
                        </div>
                    `;
                    break;
                case 'separator':
                    blockHtml = `
                        <hr style="border: none; border-top: 2px solid #f8b500; margin: 30px 0;">
                    `;
                    break;
                case 'footer':
                    blockHtml = `
                        <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666; font-size: 12px;">
                            <p>С уважением, команда {{serverName}}</p>
                            <p>Это письмо отправлено автоматически, пожалуйста, не отвечайте на него.</p>
                        </div>
                    `;
                    break;
                case 'social':
                    blockHtml = `
                        <div style="text-align: center; margin: 20px 0;">
                            <a href="{{discordInvite}}" style="margin: 0 10px; color: #5865F2; text-decoration: none;">Discord</a>
                            <a href="{{telegramInvite}}" style="margin: 0 10px; color: #0088cc; text-decoration: none;">Telegram</a>
                        </div>
                    `;
                    break;
            }
            
            if (isVisualMode && quillEditor) {
                const range = quillEditor.getSelection() || { index: quillEditor.getLength() };
                quillEditor.clipboard.dangerouslyPasteHTML(range.index, blockHtml);
            } else {
                const htmlTextarea = document.getElementById('template-html');
                const cursorPos = htmlTextarea.selectionStart;
                const textBefore = htmlTextarea.value.substring(0, cursorPos);
                const textAfter = htmlTextarea.value.substring(cursorPos);
                htmlTextarea.value = textBefore + blockHtml + textAfter;
                htmlTextarea.selectionStart = htmlTextarea.selectionEnd = cursorPos + blockHtml.length;
                htmlTextarea.focus();
            }
        }
        
        // Функция для показа/скрытия пароля
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(inputId + '-eye');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        // Система обработки событий для переменных и блоков
        document.addEventListener('DOMContentLoaded', () => {
            // Обработчик для элементов с data-variable
            document.addEventListener('click', (event) => {
                const variableElement = event.target.closest('[data-variable]');
                if (variableElement) {
                    const variable = variableElement.getAttribute('data-variable');
                    if (variable) {
                        insertVariable(variable);
                    }
                }
            });

            // Обработчик для элементов с data-quick-block
            document.addEventListener('click', (event) => {
                const blockElement = event.target.closest('[data-quick-block]');
                if (blockElement) {
                    const blockType = blockElement.getAttribute('data-quick-block');
                    if (blockType) {
                        insertQuickBlock(blockType);
                    }
                }
            });

            // Обработчик для кнопок удаления уведомлений
            document.addEventListener('click', (event) => {
                const removeButton = event.target.closest('[data-action="remove-notification"]');
                if (removeButton) {
                    removeButton.parentElement.parentElement.remove();
                }
            });
        });
    </script>
</body>
</html>
