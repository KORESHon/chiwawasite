<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Профиль - Chiwawa Server</title>
    <meta name="description" content="Личный кабинет игрока на приватном Minecraft сервере Chiwawa">
    <meta name="author" content="ebluffy">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJhIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj48c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIjZmJiZjI0Ii8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjZjU5ZTBiIi8+PC9saW5lYXJHcmFkaWVudD48L2RlZnM+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiByeD0iMTIiIGZpbGw9InVybCgjYSkiLz48dGV4dCB4PSIzMiIgeT0iNDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIzMiIgZmlsbD0iIzFmMjkzNyIgdGV4dC1hbmNob3I9Im1pZGRsZSI+8J+QlTwvdGV4dD48L3N2Zz4=">
    
    <!-- Создатель: ebluffy -->
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'minecraft-dark': '#0a0a0a',
                        'minecraft-darker': '#050505',
                        'minecraft-gold': '#FFAA00',
                        'minecraft-yellow': '#FFFF55',
                        'minecraft-gray': '#2a2a2a',
                        'minecraft-light-gray': '#404040',
                        'minecraft-lighter-gray': '#555555'
                    },
                    fontFamily: {
                        'minecraft': ['Courier New', 'monospace']
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate'
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        glow: {
                            '0%': { boxShadow: '0 0 5px #FFAA00' },
                            '100%': { boxShadow: '0 0 20px #FFAA00, 0 0 30px #FFAA00' }
                        }
                    },
                    backdropBlur: {
                        'xs': '2px',
                    }
                }
            }
        }
    </script>
    
    <style>
        * {
            scrollbar-width: thin;
            scrollbar-color: #FFAA00 #1a1a1a;
        }
        
        *::-webkit-scrollbar {
            width: 8px;
        }
        
        *::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        *::-webkit-scrollbar-thumb {
            background: #FFAA00;
            border-radius: 4px;
        }
        
        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .minecraft-bg {
            background-image: 
                radial-gradient(circle at 25% 25%, #2a2a2a 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, #404040 0%, transparent 50%),
                linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
        }
        
        .glass-effect {
            background: rgba(42, 42, 42, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 170, 0, 0.1);
        }
        
        .text-shadow {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }
        
        .btn-minecraft {
            background: linear-gradient(135deg, #FFAA00 0%, #FF8800 100%);
            border: 2px solid #FFAA00;
            color: #000;
            font-weight: bold;
            text-shadow: none;
            transition: all 0.3s ease;
        }
        
        .btn-minecraft:hover {
            background: linear-gradient(135deg, #FFFF55 0%, #FFAA00 100%);
            border-color: #FFFF55;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 170, 0, 0.4);
        }
        
        .nav-item:hover {
            color: #FFAA00 !important;
            transition: all 0.3s ease;
        }
        
        .profile-tab.active {
            border-bottom-color: #FFAA00 !important;
            color: #FFAA00 !important;
        }
        
        .profile-tab:hover {
            color: #FFAA00 !important;
        }
        
        .stat-card {
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 170, 0, 0.2);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Dropdown menu styles */
        #profile-dropdown {
            z-index: 60;
        }
        
        #profile-dropdown:not(.hidden) {
            animation: dropdown-show 0.2s ease-out;
        }
        
        @keyframes dropdown-show {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Trust level progress bar */
        .trust-progress-bar {
            background: linear-gradient(90deg, 
                #FF0000 0%, 
                #FF8800 25%, 
                #FFAA00 50%, 
                #00FF00 75%, 
                #0088FF 100%
            );
        }
    </style>
</head>
<body class="minecraft-bg min-h-screen overflow-x-hidden relative">
    <!-- Навигация -->
    <nav class="glass-effect sticky top-0 z-50 border-b border-minecraft-gold/30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Левая часть - название сервера -->
                <div class="flex items-center">
                    <a href="/" class="flex items-center hover:scale-105 transition-transform duration-200">
                        <span class="text-2xl font-bold text-minecraft-yellow text-shadow" id="server-name">
                            Chiwawa
                        </span>
                    </a>
                </div>
                
                <!-- Центральная часть - основные кнопки -->
                <div class="flex items-center space-x-6">
                    <a href="/" class="nav-item text-white hover:text-minecraft-gold transition-colors text-shadow">Главная</a>
                    <a href="/rules" class="nav-item text-white hover:text-minecraft-gold transition-colors text-shadow">Правила</a>
                    <a href="/forum" class="nav-item text-white hover:text-minecraft-gold transition-colors text-shadow">Форум</a>
                    <a href="/online" class="nav-item text-white hover:text-minecraft-gold transition-colors text-shadow">Онлайн</a>
                    <a href="/map" target="_blank" class="nav-item text-white hover:text-minecraft-gold transition-colors text-shadow">Карта</a>
                </div>
                
                <!-- Правая часть - социальные сети и профиль -->
                <div class="flex items-center space-x-4">
                    <!-- Социальные сети -->
                    <div class="flex items-center space-x-2">
                        <a id="discord-link" href="https://discord.gg/chiwawa" target="_blank" class="text-gray-400 hover:text-purple-400 transition-colors text-lg" title="Discord">
                            <i class="fab fa-discord"></i>
                        </a>
                        <a id="telegram-link" href="https://t.me/chiwawa" target="_blank" class="text-gray-400 hover:text-blue-400 transition-colors text-lg" title="Telegram">
                            <i class="fab fa-telegram"></i>
                        </a>
                    </div>
                    
                    <!-- Разделитель -->
                    <div class="h-6 w-px bg-minecraft-gold/30"></div>
                    
                    <!-- Кнопка входа (для неавторизованных) -->
                    <a href="/login" id="login-btn" class="nav-item bg-gradient-to-r from-minecraft-gray to-minecraft-light-gray text-minecraft-gold px-6 py-2 rounded-lg border border-minecraft-gold/30 hover:bg-gradient-to-r hover:from-minecraft-gold hover:to-minecraft-yellow hover:text-minecraft-dark transition-all duration-300 font-medium shadow-lg">
                        <i class="fas fa-sign-in-alt mr-2"></i>Войти
                    </a>
                    
                    <!-- Профиль пользователя (для авторизованных) -->
                    <div id="user-profile" class="relative nav-item hidden bg-gradient-to-r from-minecraft-gold to-yellow-500 text-minecraft-dark px-4 py-2 rounded-lg font-bold hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-minecraft-gold/50 cursor-pointer">
                        <button id="profile-dropdown-btn" class="flex items-center space-x-2">
                            <div class="w-8 h-8 bg-minecraft-dark rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-minecraft-gold text-sm"></i>
                            </div>
                            <span id="user-nickname" class="font-medium">Player</span>
                            <i class="fas fa-chevron-down text-xs ml-1"></i>
                        </button>
                        
                        <!-- Dropdown меню -->
                        <div id="profile-dropdown" class="absolute top-full right-0 mt-2 w-48 bg-minecraft-gray rounded-lg shadow-xl border border-minecraft-gold/30 hidden">
                            <a href="/profile" class="block px-4 py-3 text-minecraft-gold hover:bg-minecraft-light-gray transition-colors border-b border-minecraft-gold/20">
                                <i class="fas fa-user-circle mr-2 text-minecraft-gold"></i>Личный кабинет
                            </a>
                            <a href="/admin" id="admin-dropdown-link" class="block px-4 py-3 text-white hover:bg-minecraft-light-gray transition-colors border-b border-minecraft-gold/20 hidden">
                                <i class="fas fa-crown mr-2 text-minecraft-gold"></i>Админ панель
                            </a>
                            <button id="logout-btn" class="w-full text-left px-4 py-3 text-red-400 hover:bg-minecraft-light-gray transition-colors">
                                <i class="fas fa-sign-out-alt mr-2"></i>Выйти
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Основной контент -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Сообщение для неавторизованных пользователей -->
        <div id="not-authorized-section" class="max-w-md mx-auto fade-in hidden">
            <div class="glass-effect rounded-xl shadow-lg p-8 text-center">
                <i class="fas fa-lock text-minecraft-gold text-4xl mb-4 animate-float"></i>
                <h2 class="text-3xl font-bold text-minecraft-yellow text-shadow mb-4">
                    Доступ ограничен
                </h2>
                <p class="text-gray-400 mb-6">Для просмотра профиля необходимо войти в систему</p>
                
                <div class="flex gap-3">
                    <a href="/login" class="flex-1 btn-minecraft py-3 px-4 rounded-lg text-center font-medium">
                        <i class="fas fa-sign-in-alt mr-2"></i>Войти
                    </a>
                    <a href="/register" class="flex-1 bg-minecraft-gray border border-minecraft-light-gray text-white py-3 px-4 rounded-lg hover:border-minecraft-gold transition-all duration-300 text-center">
                        <i class="fas fa-user-plus mr-2"></i>Регистрация
                    </a>
                </div>
            </div>
        </div>

        <!-- Профиль пользователя (показывается после входа) -->
        <div id="profile-section" class="hidden fade-in">
            <!-- Заголовок профиля -->
            <div class="glass-effect rounded-xl shadow-lg p-6 mb-8">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-20 h-20 bg-gradient-to-br from-minecraft-gold to-minecraft-yellow rounded-full flex items-center justify-center mr-6 shadow-lg">
                            <i class="fas fa-user text-minecraft-dark text-3xl"></i>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold text-minecraft-yellow text-shadow" id="user-display-name">Loading...</h1>
                            <p class="text-gray-300 text-lg" id="user-trust-level">Загрузка...</p>
                            <div class="flex items-center mt-2">
                                <div class="w-32 bg-minecraft-gray rounded-full h-2 mr-3">
                                    <div id="trust-progress-header" class="trust-progress-bar h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                                </div>
                                <span class="text-sm text-gray-400" id="trust-progress-text">0/100</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-400">Статус</div>
                        <div id="user-status" class="font-bold text-lg text-green-400">Активен</div>
                        <div class="text-sm text-gray-400 mt-1">Регистрация</div>
                        <div id="user-created" class="text-sm text-gray-300">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Предупреждение о бане -->
            <div id="ban-warning" class="hidden mb-8">
                <div class="glass-effect rounded-xl border-2 border-red-500 bg-red-500/10 p-6">
                    <div class="flex items-start">
                        <div class="w-12 h-12 bg-red-500/20 rounded-lg flex items-center justify-center mr-4 mt-1">
                            <i class="fas fa-ban text-red-400 text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-red-400 mb-2">Аккаунт заблокирован</h3>
                            <div class="space-y-2">
                                <div class="flex items-center text-sm">
                                    <span class="text-gray-300 mr-2">Причина:</span>
                                    <span id="ban-reason" class="text-white font-medium">-</span>
                                </div>
                                <div class="flex items-center text-sm">
                                    <span class="text-gray-300 mr-2">Тип бана:</span>
                                    <span id="ban-type" class="text-white font-medium">-</span>
                                </div>
                                <div id="ban-time-info" class="flex items-center text-sm">
                                    <span class="text-gray-300 mr-2">Осталось времени:</span>
                                    <span id="ban-time-remaining" class="text-minecraft-gold font-medium">-</span>
                                </div>
                            </div>
                            <div class="mt-4 p-3 bg-minecraft-dark/50 rounded-lg border border-red-500/30">
                                <p class="text-sm text-gray-300">
                                    <i class="fas fa-info-circle mr-2 text-red-400"></i>
                                    Пока действует блокировка, вы не можете заходить на сервер Minecraft и пользоваться форумом. 
                                    Остальные функции сайта доступны.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Быстрая статистика -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="glass-effect rounded-xl shadow-lg p-6 stat-card">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-minecraft-gold/20 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-clock text-minecraft-gold text-xl"></i>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-white" id="stat-playtime">0ч</div>
                            <div class="text-sm text-gray-300">Время игры</div>
                        </div>
                    </div>
                </div>
                <div class="glass-effect rounded-xl shadow-lg p-6 stat-card">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-star text-green-400 text-xl"></i>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-white" id="stat-reputation">0</div>
                            <div class="text-sm text-gray-300">Репутация</div>
                        </div>
                    </div>
                </div>
                <div class="glass-effect rounded-xl shadow-lg p-6 stat-card">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-sign-in-alt text-blue-400 text-xl"></i>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-white" id="stat-logins">0</div>
                            <div class="text-sm text-gray-300">Входов</div>
                        </div>
                    </div>
                </div>
                <div class="glass-effect rounded-xl shadow-lg p-6 stat-card">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-yellow-500/20 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-calendar text-yellow-400 text-xl"></i>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-white" id="stat-days">0</div>
                            <div class="text-sm text-gray-300">Дней с нами</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Навигация по разделам -->
            <div class="glass-effect rounded-xl shadow-lg mb-8">
                <div class="border-b border-minecraft-gold/30">
                    <nav class="flex space-x-8 px-6">
                        <button class="profile-tab active py-4 px-2 border-b-2 border-minecraft-gold text-minecraft-gold font-medium transition-all duration-300" data-tab="info">
                            <i class="fas fa-info-circle mr-2"></i>Информация
                        </button>
                        <button class="profile-tab py-4 px-2 border-b-2 border-transparent text-gray-400 hover:text-minecraft-gold transition-all duration-300" data-tab="application">
                            <i class="fas fa-file-alt mr-2"></i>Заявка
                        </button>
                        <button class="profile-tab py-4 px-2 border-b-2 border-transparent text-gray-400 hover:text-minecraft-gold transition-all duration-300" data-tab="game-token">
                            <i class="fas fa-key mr-2"></i>Игровой токен
                        </button>
                        <button class="profile-tab py-4 px-2 border-b-2 border-transparent text-gray-400 hover:text-minecraft-gold transition-all duration-300" data-tab="settings">
                            <i class="fas fa-cog mr-2"></i>Настройки
                        </button>
                        <button class="profile-tab py-4 px-2 border-b-2 border-transparent text-gray-400 hover:text-minecraft-gold transition-all duration-300" data-tab="stats">
                            <i class="fas fa-chart-bar mr-2"></i>Статистика
                        </button>
                    </nav>
                </div>

                <div class="p-6">
                    <!-- Вкладка информации -->
                    <div id="tab-info" class="tab-content">
                        <div class="grid lg:grid-cols-2 gap-8">
                            <!-- Основная информация -->
                            <div class="glass-effect rounded-xl p-6">
                                <h3 class="text-xl font-bold text-minecraft-gold mb-6 flex items-center">
                                    <i class="fas fa-id-card mr-3"></i>Основная информация
                                </h3>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center py-3 border-b border-minecraft-light-gray">
                                        <span class="text-gray-300 flex items-center">
                                            <i class="fas fa-user mr-3 text-minecraft-gold"></i>Имя:
                                        </span>
                                        <span id="profile-first-name" class="font-bold text-white">Loading...</span>
                                    </div>
                                    <div class="flex justify-between items-center py-3 border-b border-minecraft-light-gray">
                                        <span class="text-gray-300 flex items-center">
                                            <i class="fas fa-gamepad mr-3 text-minecraft-gold"></i>Minecraft ник:
                                        </span>
                                        <span id="profile-nickname" class="font-bold text-white">Loading...</span>
                                    </div>
                                    <div class="flex justify-between items-center py-3 border-b border-minecraft-light-gray">
                                        <span class="text-gray-300 flex items-center">
                                            <i class="fas fa-envelope mr-3 text-minecraft-gold"></i>Email:
                                        </span>
                                        <span id="profile-email" class="font-medium text-white">Loading...</span>
                                    </div>
                                    <div class="flex justify-between items-center py-3 border-b border-minecraft-light-gray">
                                        <span class="text-gray-300 flex items-center">
                                            <i class="fas fa-birthday-cake mr-3 text-minecraft-gold"></i>Возраст:
                                        </span>
                                        <span id="profile-age" class="font-medium text-white">Неизвестно</span>
                                    </div>
                                    <div class="flex justify-between items-center py-3 border-b border-minecraft-light-gray">
                                        <span class="text-gray-300 flex items-center">
                                            <i class="fab fa-discord mr-3 text-minecraft-gold"></i>Discord:
                                        </span>
                                        <span id="profile-discord" class="font-medium text-white">Loading...</span>
                                    </div>
                                    <div class="flex justify-between items-center py-3 border-b border-minecraft-light-gray">
                                        <span class="text-gray-300 flex items-center">
                                            <i class="fas fa-user-tag mr-3 text-minecraft-gold"></i>Роль:
                                        </span>
                                        <span id="profile-role" class="font-medium text-white">Loading...</span>
                                    </div>
                                    <div class="flex justify-between items-center py-3">
                                        <span class="text-gray-300 flex items-center">
                                            <i class="fas fa-calendar mr-3 text-minecraft-gold"></i>Дата регистрации:
                                        </span>
                                        <span id="profile-created" class="font-medium text-white">Loading...</span>
                                    </div>
                                    
                                    <!-- Биография -->
                                    <div id="profile-bio-section" class="mt-6 pt-6 border-t border-minecraft-light-gray hidden">
                                        <div class="text-gray-300 mb-2 flex items-center">
                                            <i class="fas fa-pen mr-2 text-minecraft-gold"></i>О себе:
                                        </div>
                                        <div id="profile-bio" class="text-white bg-minecraft-dark/30 rounded-lg p-3 text-sm leading-relaxed">
                                            Информация не указана
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Trust Level прогресс -->
                            <div class="glass-effect rounded-xl p-6">
                                <h3 class="text-xl font-bold text-minecraft-gold mb-6 flex items-center">
                                    <i class="fas fa-star mr-3"></i>Уровень доверия
                                </h3>
                                <div class="space-y-6">
                                    <div class="text-center">
                                        <div class="text-4xl font-bold text-minecraft-gold mb-2" id="trust-current">0</div>
                                        <div class="text-gray-300" id="trust-current-name">Новичок</div>
                                    </div>
                                    
                                    <div class="relative">
                                        <div class="w-full bg-minecraft-gray rounded-full h-4">
                                            <div id="trust-progress" class="trust-progress-bar h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                                        </div>
                                        <div class="flex justify-between text-sm text-gray-400 mt-2">
                                            <span>Текущий: <span id="trust-reputation" class="text-minecraft-gold font-bold">0</span></span>
                                            <span>До следующего: <span id="trust-next" class="text-minecraft-gold font-bold">10</span></span>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-minecraft-dark rounded-lg p-4">
                                        <div class="text-sm text-gray-400 mb-2">Привилегии уровня:</div>
                                        <div id="trust-privileges" class="text-minecraft-gold text-sm">
                                            Базовые права пользователя
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Вкладка заявок -->
                    <div id="tab-application" class="tab-content hidden">
                        <div class="space-y-8">
                            <!-- Заявка на доступ к серверу -->
                            <div id="server-access-section" class="glass-effect rounded-xl p-6">
                                <h3 class="text-xl font-bold text-minecraft-gold mb-6 flex items-center">
                                    <i class="fas fa-key mr-3"></i>Заявка на доступ к серверу
                                </h3>
                                
                                <div id="server-access-status" class="mb-6 p-4 rounded-lg border">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <i id="server-access-icon" class="fas fa-clock text-yellow-400 text-xl mr-3"></i>
                                            <div>
                                                <div class="font-bold text-white" id="server-access-text">Проверка статуса...</div>
                                                <div class="text-sm text-gray-400" id="server-access-desc">Загрузка информации о заявке</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm text-gray-400" id="server-access-date-label" style="display: none;">Дата подачи:</div>
                                            <div class="text-sm text-gray-300" id="server-access-date" style="display: none;">-</div>
                                        </div>
                                    </div>
                                </div>

                                <div id="server-access-form" class="space-y-6 hidden">
                                <div class="bg-minecraft-dark/50 rounded-lg p-4 border border-minecraft-light-gray mb-6">
                                    <div class="flex items-start">
                                        <i class="fas fa-exclamation-triangle text-minecraft-gold mt-1 mr-3"></i>
                                        <div class="text-sm text-gray-300">
                                            <p class="font-medium mb-2">Требования для подачи заявки на доступ:</p>
                                            <div id="server-requirements-list" class="space-y-2">
                                                <div class="flex items-center">
                                                    <i id="req-age-icon" class="fas fa-times-circle text-red-400 mr-2"></i>
                                                    <span>Возраст от 10 лет</span>
                                                </div>
                                                <div class="flex items-center">
                                                    <i id="req-about-icon" class="fas fa-times-circle text-red-400 mr-2"></i>
                                                    <span>Рассказ о себе (минимум 50 символов)</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>                                    <div class="grid md:grid-cols-2 gap-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                                <i class="fas fa-user mr-2 text-minecraft-gold"></i>Ваш возраст *
                                            </label>
                                            <input type="number" id="server-app-age" min="10" max="100"
                                                class="w-full px-4 py-3 bg-minecraft-gray border border-minecraft-light-gray rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-minecraft-gold focus:border-minecraft-gold transition-all duration-300"
                                                placeholder="Введите ваш возраст">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                                <i class="fas fa-question-circle mr-2 text-minecraft-gold"></i>Откуда узнали о сервере? *
                                            </label>
                                            <select id="server-app-source" 
                                                class="w-full px-4 py-3 bg-minecraft-gray border border-minecraft-light-gray rounded-lg text-white focus:ring-2 focus:ring-minecraft-gold focus:border-minecraft-gold transition-all duration-300">
                                                <option value="">Выберите вариант</option>
                                                <option value="friends">От друзей</option>
                                                <option value="discord">Discord</option>
                                                <option value="youtube">YouTube</option>
                                                <option value="twitch">Twitch</option>
                                                <option value="forums">Форумы</option>
                                                <option value="search">Поиск в интернете</option>
                                                <option value="other">Другое</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">
                                            <i class="fas fa-clock mr-2 text-minecraft-gold"></i>Опыт игры в Minecraft *
                                        </label>
                                        <select id="server-app-experience"
                                            class="w-full px-4 py-3 bg-minecraft-gray border border-minecraft-light-gray rounded-lg text-white focus:ring-2 focus:ring-minecraft-gold focus:border-minecraft-gold transition-all duration-300">
                                            <option value="">Выберите опыт</option>
                                            <option value="beginner">Новичок (меньше 1 года)</option>
                                            <option value="intermediate">Средний (1-3 года)</option>
                                            <option value="experienced">Опытный (3-5 лет)</option>
                                            <option value="expert">Эксперт (более 5 лет)</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">
                                            <i class="fas fa-comment mr-2 text-minecraft-gold"></i>Расскажите о себе и почему хотите играть у нас *
                                        </label>
                                        <textarea id="server-app-about" rows="6"
                                            class="w-full px-4 py-3 bg-minecraft-gray border border-minecraft-light-gray rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-minecraft-gold focus:border-minecraft-gold transition-all duration-300 resize-none"
                                            placeholder="Опишите себя, ваши интересы в игре, планы на сервере... (минимум 50 символов)"></textarea>
                                        <div class="text-right text-sm text-gray-400 mt-1">
                                            <span id="server-char-count">0</span>/500 символов
                                        </div>
                                    </div>

                                    <div class="flex justify-center pt-4">
                                        <button id="submit-server-application" class="btn-minecraft px-8 py-3 rounded-lg font-medium text-lg">
                                            <i class="fas fa-paper-plane mr-2"></i>Подать заявку на доступ
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Заявки на повышение уровня доверия -->
                            <div id="trust-level-section" class="glass-effect rounded-xl p-6">
                                <h3 class="text-xl font-bold text-minecraft-gold mb-6 flex items-center">
                                    <i class="fas fa-star mr-3"></i>Заявки на повышение уровня доверия
                                </h3>

                                <!-- Проверка требований -->
                                <div id="trust-requirements-check" class="mb-6">
                                    <div class="bg-minecraft-dark/50 rounded-lg p-4 border border-minecraft-light-gray">
                                        <h4 class="text-lg font-medium text-minecraft-gold mb-4">Проверка требований</h4>
                                        <div class="space-y-3" id="requirements-list">
                                            <div class="text-center text-gray-400">
                                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                                <p>Проверка требований...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Активная заявка на повышение -->
                                <div id="trust-application-status" class="mb-6 p-4 rounded-lg border hidden">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <i id="trust-app-icon" class="fas fa-clock text-yellow-400 text-xl mr-3"></i>
                                            <div>
                                                <div class="font-bold text-white" id="trust-app-text">Заявка на рассмотрении</div>
                                                <div class="text-sm text-gray-400" id="trust-app-desc">Ожидайте решения администрации</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm text-gray-400">Дата подачи:</div>
                                            <div class="text-sm text-gray-300" id="trust-app-date">-</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Форма заявки на повышение -->
                                <div id="trust-level-form" class="space-y-6 hidden">
                                    <div class="bg-green-900/20 rounded-lg p-4 border border-green-700 mb-6">
                                        <div class="flex items-start">
                                            <i class="fas fa-check-circle text-green-400 mt-1 mr-3"></i>
                                            <div class="text-sm text-gray-300">
                                                <p class="font-medium mb-2 text-green-300">Вы можете подать заявку на повышение!</p>
                                                <p class="text-gray-400" id="trust-level-target">Доступное повышение: <span class="text-minecraft-gold font-medium">Уровень 2 - Проверенный</span></p>
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">
                                            <i class="fas fa-trophy mr-2 text-minecraft-gold"></i>Почему вы заслуживаете повышения? *
                                        </label>
                                        <textarea id="trust-app-motivation" rows="5"
                                            class="w-full px-4 py-3 bg-minecraft-gray border border-minecraft-light-gray rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-minecraft-gold focus:border-minecraft-gold transition-all duration-300 resize-none"
                                            placeholder="Опишите ваши достижения на сервере, активность, помощь другим игрокам... (минимум 50 символов)"></textarea>
                                        <div class="text-right text-sm text-gray-400 mt-1">
                                            <span id="trust-motivation-count">0</span>/300 символов
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">
                                            <i class="fas fa-lightbulb mr-2 text-minecraft-gold"></i>Ваши планы на сервере *
                                        </label>
                                        <textarea id="trust-app-plans" rows="4"
                                            class="w-full px-4 py-3 bg-minecraft-gray border border-minecraft-light-gray rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-minecraft-gold focus:border-minecraft-gold transition-all duration-300 resize-none"
                                            placeholder="Что планируете делать с новыми привилегиями? (минимум 30 символов)"></textarea>
                                        <div class="text-right text-sm text-gray-400 mt-1">
                                            <span id="trust-plans-count">0</span>/200 символов
                                        </div>
                                    </div>

                                    <div class="flex justify-center pt-4">
                                        <button id="submit-trust-application" class="btn-minecraft px-8 py-3 rounded-lg font-medium text-lg">
                                            <i class="fas fa-star mr-2"></i>Подать заявку на повышение
                                        </button>
                                    </div>
                                </div>

                                <!-- Сообщение о недоступности -->
                                <div id="trust-unavailable" class="text-center py-8 hidden">
                                    <i class="fas fa-info-circle text-gray-400 text-4xl mb-4"></i>
                                    <p class="text-gray-400 text-lg mb-2">Повышение уровня доверия недоступно</p>
                                    <p class="text-gray-500 text-sm" id="trust-unavailable-reason">Выполните требования выше для подачи заявки</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Вкладка игрового токена -->
                    <div id="tab-game-token" class="tab-content hidden">
                        <div class="space-y-8">
                            <!-- Текущий токен -->
                            <div class="glass-effect rounded-xl p-6">
                                <h3 class="text-xl font-bold text-minecraft-gold mb-6 flex items-center">
                                    <i class="fas fa-key mr-3"></i>Игровой токен
                                </h3>
                                
                                <div class="mb-6">
                                    <p class="text-gray-300 mb-4">
                                        Игровой токен нужен для авторизации на сервере Minecraft. 
                                        Каждый токен действует 15 минут и может быть использован только один раз.
                                    </p>
                                </div>

                                <div id="current-token-section" class="hidden mb-6">
                                    <div class="bg-minecraft-gray/50 rounded-lg p-4 border border-minecraft-gold/30">
                                        <div class="flex items-center justify-between mb-3">
                                            <span class="text-minecraft-gold font-medium">Активный токен:</span>
                                            <button id="copy-token-btn" class="text-minecraft-gold hover:text-white transition-colors">
                                                <i class="fas fa-copy mr-1"></i>Копировать
                                            </button>
                                        </div>
                                        <div id="current-token-display" class="font-mono text-sm bg-minecraft-darker p-3 rounded border break-all"></div>
                                        <div class="flex justify-between text-sm text-gray-400 mt-3">
                                            <span>Истекает через: <span id="token-expires-in" class="text-minecraft-gold"></span></span>
                                            <span>Создан: <span id="token-created-at"></span></span>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex flex-col sm:flex-row gap-4">
                                    <button id="generate-token-btn" class="bg-gradient-to-r from-minecraft-gold to-yellow-500 text-minecraft-dark px-6 py-3 rounded-lg font-bold hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-minecraft-gold/50 flex items-center justify-center">
                                        <i class="fas fa-magic mr-2"></i>Сгенерировать токен
                                    </button>
                                    <button id="refresh-tokens-btn" class="bg-minecraft-gray text-minecraft-gold px-6 py-3 rounded-lg font-bold hover:bg-minecraft-light-gray transition-all duration-300 border border-minecraft-gold/30 flex items-center justify-center">
                                        <i class="fas fa-sync mr-2"></i>Обновить
                                    </button>
                                    <button id="terminate-sessions-btn" class="bg-red-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700 transition-all duration-300 border border-red-500/30 flex items-center justify-center">
                                        <i class="fas fa-sign-out-alt mr-2"></i>Завершить все сессии
                                    </button>
                                </div>

                                <div id="token-message" class="hidden"></div>

                                <div id="token-loading" class="hidden text-center py-8">
                                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-minecraft-gold"></div>
                                    <p class="text-minecraft-gold mt-2">Генерация токена...</p>
                                </div>
                            </div>

                            <!-- Инструкции -->
                            <div class="glass-effect rounded-xl p-6">
                                <h3 class="text-xl font-bold text-minecraft-gold mb-6 flex items-center">
                                    <i class="fas fa-info-circle mr-3"></i>Как использовать
                                </h3>
                                
                                <div class="space-y-4">
                                    <div class="flex items-start">
                                        <div class="bg-minecraft-gold text-minecraft-dark rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 mt-1 text-sm">1</div>
                                        <div>
                                            <p class="text-gray-300">Нажмите кнопку "Сгенерировать токен" выше</p>
                                        </div>
                                    </div>
                                    <div class="flex items-start">
                                        <div class="bg-minecraft-gold text-minecraft-dark rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 mt-1 text-sm">2</div>
                                        <div>
                                            <p class="text-gray-300">Скопируйте полученный токен</p>
                                        </div>
                                    </div>
                                    <div class="flex items-start">
                                        <div class="bg-minecraft-gold text-minecraft-dark rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 mt-1 text-sm">3</div>
                                        <div>
                                            <p class="text-gray-300">Зайдите на игровой сервер Minecraft</p>
                                        </div>
                                    </div>
                                    <div class="flex items-start">
                                        <div class="bg-minecraft-gold text-minecraft-dark rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 mt-1 text-sm">4</div>
                                        <div>
                                            <p class="text-gray-300">Введите команду: <code class="bg-minecraft-darker px-2 py-1 rounded text-minecraft-gold">/login &lt;ваш_токен&gt;</code></p>
                                        </div>
                                    </div>
                                    <div class="flex items-start">
                                        <div class="bg-minecraft-gold text-minecraft-dark rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 mt-1 text-sm">5</div>
                                        <div>
                                            <p class="text-gray-300">Готово! Вы авторизованы на сервере</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-6 p-4 bg-yellow-900/30 border border-yellow-600/50 rounded-lg">
                                    <div class="flex items-start">
                                        <i class="fas fa-exclamation-triangle text-yellow-400 mr-3 mt-1"></i>
                                        <div>
                                            <p class="text-yellow-200 font-medium mb-2">Важно:</p>
                                            <ul class="text-yellow-200 text-sm space-y-1">
                                                <li>• Токен действует только 15 минут</li>
                                                <li>• Каждый токен можно использовать только один раз</li>
                                                <li>• Не передавайте токен другим игрокам</li>
                                                <li>• При каждом новом входе нужен новый токен</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- История токенов -->
                            <div class="glass-effect rounded-xl p-6">
                                <h3 class="text-xl font-bold text-minecraft-gold mb-6 flex items-center">
                                    <i class="fas fa-history mr-3"></i>История токенов
                                </h3>
                                
                                <div id="token-history" class="space-y-3">
                                    <div class="text-center text-gray-400 py-4">
                                        <i class="fas fa-clock text-2xl mb-2"></i>
                                        <p>История токенов загружается...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Вкладка настроек -->
                    <div id="tab-settings" class="tab-content hidden">
                        <div class="space-y-8">
                            <!-- Личная информация -->
                            <div class="glass-effect rounded-xl p-6">
                                <h3 class="text-xl font-bold text-minecraft-gold mb-6 flex items-center">
                                    <i class="fas fa-user-edit mr-3"></i>Личная информация
                                </h3>
                                
                                <div id="settings-message" class="hidden mb-6"></div>
                                
                                <form id="personal-settings-form" class="space-y-6">
                                    <!-- Аватар -->
                                    <div class="text-center mb-6">
                                        <div class="flex flex-col items-center space-y-4">
                                            <div class="relative">
                                                <img id="current-avatar" src="/assets/images/default-avatar.png" 
                                                     alt="Аватар" class="w-24 h-24 rounded-full border-4 border-minecraft-gold object-cover">
                                                <button type="button" id="change-avatar-btn" 
                                                        class="absolute bottom-0 right-0 bg-minecraft-gold hover:bg-minecraft-yellow p-2 rounded-full transition-colors">
                                                    <i class="fas fa-camera text-minecraft-dark text-sm"></i>
                                                </button>
                                            </div>
                                            <input type="file" id="avatar-input" accept="image/*" class="hidden">
                                            <div class="flex gap-2">
                                                <button type="button" id="upload-avatar-btn" 
                                                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm">
                                                    <i class="fas fa-upload mr-1"></i>Загрузить
                                                </button>
                                                <button type="button" id="remove-avatar-btn" 
                                                        class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm">
                                                    <i class="fas fa-trash mr-1"></i>Удалить
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="grid md:grid-cols-2 gap-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                                <i class="fas fa-user mr-2 text-minecraft-gold"></i>Имя
                                            </label>
                                            <input type="text" name="first_name" id="settings-firstname"
                                                class="w-full px-4 py-3 bg-minecraft-gray border border-minecraft-light-gray rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-minecraft-gold focus:border-minecraft-gold transition-all duration-300"
                                                placeholder="Ваше имя (опционально)">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                                <i class="fas fa-birthday-cake mr-2 text-minecraft-gold"></i>Возраст
                                            </label>
                                            <div class="relative">
                                                <input type="number" name="age" id="settings-age" min="10" max="100"
                                                    class="w-full px-4 py-3 bg-minecraft-gray border border-minecraft-light-gray rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-minecraft-gold focus:border-minecraft-gold transition-all duration-300"
                                                    placeholder="Ваш возраст">
                                                <div class="text-xs text-gray-500 mt-1">
                                                    Сохраняется после одобрения заявки
                                                </div>
                                            </div>
                                        </div>
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                                <i class="fas fa-gamepad mr-2 text-minecraft-gold"></i>Minecraft ник
                                            </label>
                                            <div class="w-full px-4 py-3 bg-minecraft-darker border border-minecraft-light-gray rounded-lg text-gray-300 flex items-center justify-between">
                                                <span id="settings-minecraft-nick-display">Загрузка...</span>
                                                <span class="text-xs text-gray-500">
                                                    <i class="fas fa-lock mr-1"></i>Только через администратора
                                                </span>
                                            </div>
                                            <p class="text-xs text-gray-500 mt-1">
                                                Minecraft ник нельзя изменить самостоятельно. Обратитесь к администрации для смены.
                                            </p>
                                        </div>
                                    </div>

                                    <!-- Биография -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">
                                            <i class="fas fa-pen mr-2 text-minecraft-gold"></i>О себе
                                        </label>
                                        <textarea name="bio" id="settings-bio" rows="4" maxlength="1000"
                                            class="w-full px-4 py-3 bg-minecraft-gray border border-minecraft-light-gray rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-minecraft-gold focus:border-minecraft-gold transition-all duration-300 resize-none"
                                            placeholder="Расскажите о себе... (будет отображаться в профиле и на форуме)"></textarea>
                                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                                            <span>Отображается в профиле и на форуме</span>
                                            <span id="bio-counter">0/1000</span>
                                        </div>
                                    </div>
                                    
                                    <div class="flex justify-end">
                                        <button type="submit" class="btn-minecraft px-6 py-2 rounded-lg font-medium">
                                            <i class="fas fa-save mr-2"></i>Сохранить
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- Связанные аккаунты -->
                            <div class="glass-effect rounded-xl p-6">
                                <h3 class="text-xl font-bold text-minecraft-gold mb-6 flex items-center">
                                    <i class="fas fa-link mr-3"></i>Связанные аккаунты
                                </h3>
                                
                                <div class="space-y-4">
                                    <!-- Discord -->
                                    <div class="flex items-center justify-between p-4 bg-minecraft-dark/50 rounded-lg border border-minecraft-light-gray">
                                        <div class="flex items-center">
                                            <i class="fab fa-discord text-purple-400 text-2xl mr-4"></i>
                                            <div>
                                                <div class="font-medium text-white">Discord</div>
                                                <div id="discord-status-text" class="text-sm text-gray-400">Не привязан</div>
                                            </div>
                                        </div>
                                        <button id="discord-connect-btn" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white rounded-lg text-sm font-medium transition-all duration-300">
                                            <i class="fab fa-discord mr-1"></i>Привязать
                                        </button>
                                    </div>

                                    <!-- Email верификация -->
                                    <div class="flex items-center justify-between p-4 bg-minecraft-dark/50 rounded-lg border border-minecraft-light-gray">
                                        <div class="flex items-center">
                                            <i class="fas fa-envelope text-minecraft-gold text-2xl mr-4"></i>
                                            <div>
                                                <div class="font-medium text-white">Email подтверждение</div>
                                                <div class="text-sm">
                                                    <span class="text-gray-400">Почта: </span>
                                                    <span id="current-email-display" class="text-minecraft-yellow">loading...</span>
                                                </div>
                                                <div id="email-verification-status" class="text-sm">loading...</div>
                                            </div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button id="change-email-btn" class="px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-lg text-sm font-medium transition-all duration-300">
                                                <i class="fas fa-edit mr-1"></i>Сменить
                                            </button>
                                            <button id="verify-email-btn" class="hidden px-4 py-2 bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-700 hover:to-teal-700 text-white rounded-lg text-sm font-medium transition-all duration-300">
                                                <i class="fas fa-envelope-open mr-1"></i>Подтвердить
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Безопасность -->
                            <div class="glass-effect rounded-xl p-6">
                                <h3 class="text-xl font-bold text-minecraft-gold mb-6 flex items-center">
                                    <i class="fas fa-shield-alt mr-3"></i>Безопасность
                                </h3>
                                
                                <form id="security-settings-form" class="space-y-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">
                                            <i class="fas fa-lock mr-2 text-minecraft-gold"></i>Текущий пароль
                                        </label>
                                        <input type="password" name="current_password" id="settings-current-password"
                                            class="w-full px-4 py-3 bg-minecraft-gray border border-minecraft-light-gray rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-minecraft-gold focus:border-minecraft-gold transition-all duration-300"
                                            placeholder="Введите текущий пароль для смены">
                                    </div>
                                    
                                    <div class="grid md:grid-cols-2 gap-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                                <i class="fas fa-key mr-2 text-minecraft-gold"></i>Новый пароль
                                            </label>
                                            <input type="password" name="new_password" id="settings-new-password"
                                                class="w-full px-4 py-3 bg-minecraft-gray border border-minecraft-light-gray rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-minecraft-gold focus:border-minecraft-gold transition-all duration-300"
                                                placeholder="Минимум 6 символов">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300 mb-2">
                                                <i class="fas fa-check mr-2 text-minecraft-gold"></i>Подтверждение пароля
                                            </label>
                                            <input type="password" name="confirm_password" id="settings-confirm-password"
                                                class="w-full px-4 py-3 bg-minecraft-gray border border-minecraft-light-gray rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-minecraft-gold focus:border-minecraft-gold transition-all duration-300"
                                                placeholder="Повторите новый пароль">
                                        </div>
                                    </div>
                                    
                                    <div class="bg-minecraft-dark/50 rounded-lg p-4 border border-minecraft-light-gray">
                                        <div class="flex items-start">
                                            <i class="fas fa-info-circle text-minecraft-gold mt-1 mr-3"></i>
                                            <div class="text-sm text-gray-300">
                                                <p class="font-medium mb-2">Требования к паролю:</p>
                                                <ul class="list-disc list-inside space-y-1 text-gray-400">
                                                    <li>Минимум 6 символов</li>
                                                    <li>Для смены пароля обязательно указание текущего</li>
                                                    <li>Рекомендуется использовать латинские буквы и цифры</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex justify-end">
                                        <button type="submit" class="btn-minecraft px-6 py-2 rounded-lg font-medium">
                                            <i class="fas fa-shield-alt mr-2"></i>Обновить пароль
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Вкладка статистики -->
                    <div id="tab-stats" class="tab-content hidden">
                        <div class="space-y-8">
                            <!-- Общая статистика -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <div class="glass-effect rounded-xl p-6 text-center stat-card">
                                    <i class="fas fa-clock text-minecraft-gold text-3xl mb-3"></i>
                                    <div class="text-3xl font-bold text-white mb-2" id="stat-total-playtime">0ч</div>
                                    <div class="text-gray-400">Общее время игры</div>
                                </div>
                                <div class="glass-effect rounded-xl p-6 text-center stat-card">
                                    <i class="fas fa-sign-in-alt text-green-400 text-3xl mb-3"></i>
                                    <div class="text-3xl font-bold text-white mb-2" id="stat-total-logins">0</div>
                                    <div class="text-gray-400">Всего входов</div>
                                </div>
                                <div class="glass-effect rounded-xl p-6 text-center stat-card">
                                    <i class="fas fa-calendar-day text-blue-400 text-3xl mb-3"></i>
                                    <div class="text-3xl font-bold text-white mb-2" id="stat-last-seen">Никогда</div>
                                    <div class="text-gray-400">Последний вход</div>
                                </div>
                                <div class="glass-effect rounded-xl p-6 text-center stat-card">
                                    <i class="fas fa-trophy text-yellow-400 text-3xl mb-3"></i>
                                    <div class="text-3xl font-bold text-white mb-2" id="stat-achievements">0</div>
                                    <div class="text-gray-400">Достижений</div>
                                </div>
                            </div>
                            
                            <!-- Детальная статистика -->
                            <div class="grid lg:grid-cols-2 gap-8">
                                <!-- Игровая статистика -->
                                <div class="glass-effect rounded-xl p-6">
                                    <h4 class="text-lg font-bold text-minecraft-gold mb-4 flex items-center">
                                        <i class="fas fa-gamepad mr-3"></i>Игровая активность
                                    </h4>
                                    <div class="space-y-4">
                                        <div class="flex justify-between items-center py-2 border-b border-minecraft-light-gray">
                                            <span class="text-gray-300">Среднее время за сессию:</span>
                                            <span id="stat-avg-session" class="text-white font-medium">-</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2 border-b border-minecraft-light-gray">
                                            <span class="text-gray-300">Самая длинная сессия:</span>
                                            <span id="stat-longest-session" class="text-white font-medium">-</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2 border-b border-minecraft-light-gray">
                                            <span class="text-gray-300">Активных дней:</span>
                                            <span id="stat-active-days" class="text-white font-medium">-</span>
                                        </div>
                                        <div class="flex justify-between items-center py-2">
                                            <span class="text-gray-300">Любимое время игры:</span>
                                            <span id="stat-favorite-time" class="text-white font-medium">-</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Прогресс и достижения -->
                                <div class="glass-effect rounded-xl p-6">
                                    <h4 class="text-lg font-bold text-minecraft-gold mb-4 flex items-center">
                                        <i class="fas fa-medal mr-3"></i>Прогресс и достижения
                                    </h4>
                                    <div id="achievements-list" class="space-y-3 max-h-64 overflow-y-auto">
                                        <div class="text-center text-gray-400 py-8">
                                            <i class="fas fa-trophy text-2xl mb-2"></i>
                                            <p>Загрузка достижений...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- График активности -->
                            <div class="glass-effect rounded-xl p-6">
                                <h4 class="text-lg font-bold text-minecraft-gold mb-4 flex items-center">
                                    <i class="fas fa-chart-line mr-3"></i>График активности за последние 30 дней
                                </h4>
                                <div id="activity-chart" class="h-64 flex items-center justify-center text-gray-400">
                                    <div class="text-center">
                                        <i class="fas fa-chart-bar text-4xl mb-4"></i>
                                        <p>График активности будет отображаться здесь</p>
                                        <p class="text-sm mt-2">Пока недостаточно данных для построения графика</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script>
        let currentUser = null;

        // Проверка авторизации при загрузке
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('auth_token');
            if (token) {
                try {
                    const response = await fetch('/api/auth/verify', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const userData = await response.json();
                        currentUser = userData.user;
                        showProfile();
                        await loadProfileData();
                        
                        // Обрабатываем Discord callback
                        const urlParams = new URLSearchParams(window.location.search);
                        if (urlParams.get('discord_ready') === 'true') {
                            await handleDiscordLinkComplete(urlParams.get('username'));
                        }
                    } else {
                        localStorage.removeItem('auth_token');
                        showNotAuthorized();
                    }
                } catch (error) {
                    console.error('Ошибка проверки токена:', error);
                    showNotAuthorized();
                }
            } else {
                showNotAuthorized();
            }

            // Инициализация обработчиков событий
            initializeEventHandlers();
        });

        function initializeEventHandlers() {
            // Profile dropdown toggle
            const profileBtn = document.getElementById('profile-dropdown-btn');
            const profileDropdown = document.getElementById('profile-dropdown');
            
            if (profileBtn && profileDropdown) {
                profileBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('hidden');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', () => {
                    profileDropdown.classList.add('hidden');
                });
            }

            // Tab switching
            document.querySelectorAll('.profile-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;
                    switchTab(tabId);
                });
            });

            // Copy token button
            const copyTokenBtn = document.getElementById('copy-token-btn');
            if (copyTokenBtn) {
                copyTokenBtn.addEventListener('click', copyCurrentToken);
            }

            // Form submissions
            setupFormHandlers();
            
            // Character count for application forms
            const serverAboutTextarea = document.getElementById('server-app-about');
            if (serverAboutTextarea) {
                serverAboutTextarea.addEventListener('input', updateServerCharacterCount);
            }

            const trustMotivationTextarea = document.getElementById('trust-app-motivation');
            if (trustMotivationTextarea) {
                trustMotivationTextarea.addEventListener('input', updateTrustMotivationCount);
            }

            const trustPlansTextarea = document.getElementById('trust-app-plans');
            if (trustPlansTextarea) {
                trustPlansTextarea.addEventListener('input', updateTrustPlansCount);
            }
        }

        function setupFormHandlers() {
            // Personal settings form
            const personalForm = document.getElementById('personal-settings-form');
            if (personalForm) {
                personalForm.addEventListener('submit', handlePersonalSettings);
            }

            // Security settings form
            const securityForm = document.getElementById('security-settings-form');
            if (securityForm) {
                securityForm.addEventListener('submit', handleSecuritySettings);
            }

            // Avatar handlers
            const changeAvatarBtn = document.getElementById('change-avatar-btn');
            const avatarInput = document.getElementById('avatar-input');
            const uploadAvatarBtn = document.getElementById('upload-avatar-btn');
            const removeAvatarBtn = document.getElementById('remove-avatar-btn');

            if (changeAvatarBtn && avatarInput) {
                changeAvatarBtn.addEventListener('click', () => avatarInput.click());
                avatarInput.addEventListener('change', handleAvatarSelect);
            }

            if (uploadAvatarBtn) {
                uploadAvatarBtn.addEventListener('click', handleAvatarUpload);
            }

            if (removeAvatarBtn) {
                removeAvatarBtn.addEventListener('click', handleAvatarRemove);
            }

            // Bio character counter
            const bioTextarea = document.getElementById('settings-bio');
            const bioCounter = document.getElementById('bio-counter');
            if (bioTextarea && bioCounter) {
                bioTextarea.addEventListener('input', () => {
                    bioCounter.textContent = `${bioTextarea.value.length}/1000`;
                });
            }

            // Server access application form
            const serverApplicationBtn = document.getElementById('submit-server-application');
            if (serverApplicationBtn) {
                serverApplicationBtn.addEventListener('click', handleServerApplicationSubmit);
            }

            // Trust level application form
            const trustApplicationBtn = document.getElementById('submit-trust-application');
            if (trustApplicationBtn) {
                trustApplicationBtn.addEventListener('click', handleTrustApplicationSubmit);
            }

            // Discord connect
            const discordBtn = document.getElementById('discord-connect-btn');
            if (discordBtn) {
                discordBtn.addEventListener('click', handleDiscordConnect);
            }

            // Email verification
            const verifyEmailBtn = document.getElementById('verify-email-btn');
            if (verifyEmailBtn) {
                verifyEmailBtn.addEventListener('click', handleEmailVerification);
            }

            // Change email
            const changeEmailBtn = document.getElementById('change-email-btn');
            if (changeEmailBtn) {
                changeEmailBtn.addEventListener('click', handleEmailChange);
            }

            // Logout
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
        }

        // Функции для работы с игровыми токенами
        async function generateGameToken() {
            const generateBtn = document.getElementById('generate-token-btn');
            const loading = document.getElementById('token-loading');
            const currentTokenSection = document.getElementById('current-token-section');
            
            generateBtn.style.display = 'none';
            loading.classList.remove('hidden');
            
            try {
                const response = await fetch('/api/auth/generate-game-token', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('auth_token'),
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('current-token-display').textContent = data.token;
                    document.getElementById('token-created-at').textContent = new Date(data.expires_at).toLocaleString('ru-RU');
                    
                    currentTokenSection.classList.remove('hidden');
                    
                    // Обновляем время каждую секунду
                    let remainingTime = data.expires_in;
                    const timer = setInterval(() => {
                        remainingTime--;
                        if (remainingTime <= 0) {
                            clearInterval(timer);
                            document.getElementById('token-expires-in').textContent = 'Истек';
                            document.getElementById('token-expires-in').className = 'text-red-400';
                            return;
                        }
                        document.getElementById('token-expires-in').textContent = formatTime(remainingTime);
                    }, 1000);
                    
                    // Загружаем историю токенов
                    loadTokenHistory();
                    
                    showMessage('token-message', 'Токен успешно создан! Скопируйте его и используйте в игре.', 'success');
                } else {
                    showMessage('token-message', 'Ошибка: ' + data.error, 'error');
                    generateBtn.style.display = 'block';
                }
            } catch (error) {
                showMessage('token-message', 'Ошибка соединения с сервером', 'error');
                generateBtn.style.display = 'block';
            }
            
            loading.classList.add('hidden');
        }
        
        function copyCurrentToken() {
            const tokenDisplay = document.getElementById('current-token-display');
            const copyBtn = document.getElementById('copy-token-btn');
            
            navigator.clipboard.writeText(tokenDisplay.textContent).then(() => {
                const originalHtml = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check mr-1"></i>Скопировано';
                copyBtn.className = 'text-green-400 transition-colors';
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalHtml;
                    copyBtn.className = 'text-minecraft-gold hover:text-white transition-colors';
                }, 2000);
            });
        }
        
        async function loadTokenHistory() {
            try {
                const response = await fetch('/api/auth/game-tokens', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('auth_token')
                    }
                });
                
                const data = await response.json();
                const historyContainer = document.getElementById('token-history');
                
                if (data.tokens && data.tokens.length > 0) {
                    historyContainer.innerHTML = data.tokens.map(token => {
                        const statusClass = token.status === 'used' ? 'text-green-400' : 
                                          token.status === 'expired' ? 'text-red-400' : 'text-minecraft-gold';
                        const statusText = token.status === 'used' ? 'Использован' :
                                         token.status === 'expired' ? 'Истек' : 'Активен';
                        
                        return `
                            <div class="bg-minecraft-gray/30 rounded-lg p-4 border border-minecraft-gold/20">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <span class="text-sm text-gray-400">ID: ${token.id.slice(0, 8)}...</span>
                                        <span class="ml-4 ${statusClass} font-medium">${statusText}</span>
                                    </div>
                                    <div class="text-sm text-gray-400">
                                        Создан: ${new Date(token.created_at).toLocaleString('ru-RU')}
                                    </div>
                                </div>
                                ${token.used_at ? `
                                    <div class="text-sm text-gray-400 mt-2">
                                        Использован: ${new Date(token.used_at).toLocaleString('ru-RU')}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                } else {
                    historyContainer.innerHTML = `
                        <div class="text-center text-gray-400 py-4">
                            <i class="fas fa-clock text-2xl mb-2"></i>
                            <p>У вас пока нет созданных токенов</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Ошибка загрузки истории токенов:', error);
            }
        }

        async function terminateAllSessions() {
            if (!confirm('Вы уверены, что хотите завершить все игровые сессии? Это выкинет вас с сервера, если вы сейчас играете.')) {
                return;
            }

            const terminateBtn = document.getElementById('terminate-sessions-btn');
            const originalText = terminateBtn.innerHTML;
            
            terminateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Завершение...';
            terminateBtn.disabled = true;
            
            try {
                const response = await fetch('/api/auth/terminate-game-sessions', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('auth_token'),
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('token-message', `Успешно завершено сессий: ${data.terminated}`, 'success');
                } else {
                    showMessage('token-message', 'Ошибка: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Ошибка завершения сессий:', error);
                showMessage('token-message', 'Ошибка соединения с сервером', 'error');
            }
            
            terminateBtn.innerHTML = originalText;
            terminateBtn.disabled = false;
        }
        
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function switchTab(tabId) {
            // Remove active class from all tabs
            document.querySelectorAll('.profile-tab').forEach(tab => {
                tab.classList.remove('active', 'border-minecraft-gold', 'text-minecraft-gold');
                tab.classList.add('border-transparent', 'text-gray-400');
            });

            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Activate current tab
            const currentTab = document.querySelector(`[data-tab="${tabId}"]`);
            if (currentTab) {
                currentTab.classList.remove('border-transparent', 'text-gray-400');
                currentTab.classList.add('active', 'border-minecraft-gold', 'text-minecraft-gold');
            }

            // Show current tab content
            const currentContent = document.getElementById(`tab-${tabId}`);
            if (currentContent) {
                currentContent.classList.remove('hidden');
            }

            // Load tab-specific data
            switch(tabId) {
                case 'application':
                    loadApplicationsData();
                    break;
                case 'game-token':
                    loadTokenHistory();
                    break;
                case 'stats':
                    loadStatistics();
                    break;
            }
        }

        function showNotAuthorized() {
            document.getElementById('not-authorized-section').classList.remove('hidden');
            document.getElementById('profile-section').classList.add('hidden');
            document.getElementById('login-btn').classList.remove('hidden');
            document.getElementById('user-profile').classList.add('hidden');
        }

        function showProfile() {
            document.getElementById('not-authorized-section').classList.add('hidden');
            document.getElementById('profile-section').classList.remove('hidden');
            document.getElementById('login-btn').classList.add('hidden');
            document.getElementById('user-profile').classList.remove('hidden');
        }

        async function loadProfileData() {
            const token = localStorage.getItem('auth_token');
            
            try {
                // Загружаем данные профиля
                const response = await fetch('/api/profile', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    updateProfileUI(data);
                } else {
                    console.error('Ошибка загрузки профиля');
                }

                // Загружаем настройки сервера
                await loadServerSettings();
            } catch (error) {
                console.error('Ошибка загрузки данных профиля:', error);
            }
        }

        async function loadServerSettings() {
            try {
                console.log('Loading server settings...'); // Для отладки
                const response = await fetch('/api/settings/public');
                
                console.log('Server settings response status:', response.status); // Для отладки
                
                if (response.ok) {
                    const settings = await response.json();
                    console.log('Server settings loaded:', settings); // Для отладки
                    updateServerUI(settings);
                } else {
                    console.error('Ошибка загрузки настроек сервера, status:', response.status);
                    // В случае ошибки показываем стандартное название
                    console.log('Using fallback server name');
                }
            } catch (error) {
                console.error('Ошибка загрузки настроек сервера:', error);
                // В случае ошибки показываем стандартное название
                console.log('Using fallback server name due to error');
            }
        }

        function updateServerUI(settings) {
            console.log('Server settings received:', settings); // Для отладки
            
            // Обновляем название сервера
            const serverNameElement = document.getElementById('server-name');
            const serverName = settings.serverName || settings.server_name || settings['server_name'] || settings['server-name'];
            
            if (serverNameElement && serverName) {
                serverNameElement.textContent = serverName;
                console.log('Server name updated to:', serverName); // Для отладки
            } else {
                console.log('Server name not found in settings or element not found'); // Для отладки
                console.log('Available keys:', Object.keys(settings)); // Показываем доступные ключи
            }

            // Обновляем title страницы
            if (serverName) {
                document.title = `Профиль - ${serverName}`;
            }

            // Обновляем ссылки на социальные сети
            const discordLink = document.getElementById('discord-link');
            const telegramLink = document.getElementById('telegram-link');
            
            if (discordLink && settings.discordInvite) {
                discordLink.href = settings.discordInvite;
                console.log('Discord link updated to:', settings.discordInvite);
            }
            
            if (telegramLink && settings.telegramInvite) {
                telegramLink.href = settings.telegramInvite;
                console.log('Telegram link updated to:', settings.telegramInvite);
            }
        }

        function updateProfileUI(data) {
            // Display name in header
            const displayName = data.minecraft_nick || data.nickname || data.email || 'User';
            const firstName = data.first_name;
            const fullDisplayName = firstName ? `${displayName} (${firstName})` : displayName;
            
            // Update header
            document.getElementById('user-nickname').textContent = displayName;
            document.getElementById('user-display-name').textContent = fullDisplayName;
            
            // Basic info
            document.getElementById('profile-first-name').textContent = data.first_name || 'Не указано';
            document.getElementById('profile-nickname').textContent = displayName;
            document.getElementById('profile-email').textContent = data.email || 'N/A';
            document.getElementById('profile-age').textContent = data.age || 'Неизвестно';
            document.getElementById('profile-discord').textContent = data.discord || 'Не привязан';
            document.getElementById('profile-role').textContent = getRoleDisplayName(data.role);
            document.getElementById('profile-created').textContent = new Date(data.registered_at).toLocaleDateString('ru-RU');
            document.getElementById('user-created').textContent = new Date(data.registered_at).toLocaleDateString('ru-RU');

            // Avatar
            const avatarElement = document.getElementById('current-avatar');
            if (avatarElement) {
                avatarElement.src = data.avatar_url || '/assets/images/default-avatar.png';
            }

            // Bio
            const bioSection = document.getElementById('profile-bio-section');
            const bioElement = document.getElementById('profile-bio');
            if (data.bio && data.bio.trim()) {
                bioSection.classList.remove('hidden');
                bioElement.textContent = data.bio;
            } else {
                bioSection.classList.add('hidden');
            }

            // Ban info
            if (data.ban_info && data.is_banned) {
                showBanWarning(data.ban_info);
            } else {
                hideBanWarning();
            }

            // Trust level
            updateTrustLevel(data);
            
            // Statistics
            updateStatistics(data);
            
            // Status
            updateUserStatus(data);
            
            // Settings forms
            updateSettingsForms(data);
            
            // Admin link visibility
            const adminLink = document.getElementById('admin-dropdown-link');
            if (adminLink) {
                if (data.role === 'admin' || data.role === 'moderator') {
                    adminLink.classList.remove('hidden');
                } else {
                    adminLink.classList.add('hidden');
                }
            }
        }

        function showBanWarning(banInfo) {
            const banWarning = document.getElementById('ban-warning');
            const reasonElement = document.getElementById('ban-reason');
            const typeElement = document.getElementById('ban-type');
            const timeInfo = document.getElementById('ban-time-info');
            const timeRemaining = document.getElementById('ban-time-remaining');

            banWarning.classList.remove('hidden');
            reasonElement.textContent = banInfo.reason || 'Не указана';
            typeElement.textContent = banInfo.is_permanent ? 'Постоянный' : 'Временный';

            if (banInfo.is_permanent) {
                timeInfo.classList.add('hidden');
            } else {
                timeInfo.classList.remove('hidden');
                if (banInfo.time_remaining && !banInfo.time_remaining.expired) {
                    timeRemaining.textContent = banInfo.time_remaining.formatted || 'Неизвестно';
                } else {
                    timeRemaining.textContent = 'Истекло';
                }
            }
        }

        function hideBanWarning() {
            const banWarning = document.getElementById('ban-warning');
            banWarning.classList.add('hidden');
        }

        function updateTrustLevel(data) {
            const trustLevelNames = {
                0: '🚶 Проходимец',
                1: '👤 Новичок', 
                2: '✅ Проверенный',
                3: '🏆 Ветеран'
            };
            
            const trustLevel = data.trust_level || 0;
            const trustLevelName = trustLevelNames[trustLevel] || 'Неизвестный уровень';
            
            document.getElementById('user-trust-level').textContent = `${trustLevelName} (Уровень ${trustLevel})`;
            document.getElementById('trust-current').textContent = trustLevel;
            document.getElementById('trust-current-name').textContent = trustLevelName;
            
            // Progress calculation
            const requirements = {
                0: { hours: 0, reputation: 0 },
                1: { hours: 0, reputation: 0 },
                2: { hours: 25, reputation: 10 },
                3: { hours: 50, reputation: 20 },
                4: { hours: 100, reputation: 50 }
            };
            
            const stats = data.stats || {};
            const currentHours = Math.floor((stats.playtime || 0) / 60);
            const currentReputation = data.reputation || 0;
            
            let progressPercent = 0;
            let progressText = '';
            
            if (trustLevel >= 3) {
                progressPercent = 100;
                progressText = 'Максимальный уровень';
            } else {
                const nextLevel = trustLevel + 1;
                const nextRequirements = requirements[nextLevel];
                
                const hoursProgress = Math.min(currentHours / nextRequirements.hours, 1) * 50;
                const reputationProgress = Math.min(currentReputation / nextRequirements.reputation, 1) * 50;
                progressPercent = hoursProgress + reputationProgress;
                
                progressText = `${currentHours}/${nextRequirements.hours} часов, ${currentReputation}/${nextRequirements.reputation} репутации`;
            }
            
            document.getElementById('trust-progress').style.width = progressPercent + '%';
            document.getElementById('trust-progress-header').style.width = progressPercent + '%';
            document.getElementById('trust-progress-text').textContent = progressText;
            document.getElementById('trust-reputation').textContent = currentReputation;
            
            if (trustLevel >= 3) {
                document.getElementById('trust-next').textContent = 'Макс. уровень';
            } else {
                const nextLevel = trustLevel + 1;
                const nextRequirements = requirements[nextLevel];
                document.getElementById('trust-next').textContent = `${nextRequirements.reputation - currentReputation} репутации`;
            }
            
            document.getElementById('trust-privileges').textContent = getTrustLevelPrivileges(trustLevel);
        }

        function updateStatistics(data) {
            const stats = data.stats || {};
            const playtimeHours = Math.floor((stats.playtime || 0) / 60);
            const registrationDate = new Date(data.registered_at);
            const daysSinceRegistration = Math.floor((Date.now() - registrationDate.getTime()) / (1000 * 60 * 60 * 24));
            
            // Header stats
            document.getElementById('stat-playtime').textContent = playtimeHours + 'ч';
            document.getElementById('stat-reputation').textContent = data.reputation || 0;
            document.getElementById('stat-logins').textContent = stats.total_logins || 0;
            document.getElementById('stat-days').textContent = daysSinceRegistration;
            
            // Detailed stats
            document.getElementById('stat-total-playtime').textContent = playtimeHours + 'ч';
            document.getElementById('stat-total-logins').textContent = stats.total_logins || 0;
            document.getElementById('stat-achievements').textContent = stats.achievements_count || 0;
            
            // Last seen
            const lastSeenEl = document.getElementById('stat-last-seen');
            if (data.last_login) {
                const lastSeen = new Date(data.last_login);
                const now = new Date();
                const diffTime = Math.abs(now - lastSeen);
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) {
                    lastSeenEl.textContent = 'Сегодня';
                } else if (diffDays === 1) {
                    lastSeenEl.textContent = 'Вчера';
                } else {
                    lastSeenEl.textContent = `${diffDays} дн. назад`;
                }
            } else {
                lastSeenEl.textContent = 'Никогда';
            }
        }

        function updateUserStatus(data) {
            const statusElement = document.getElementById('user-status');
            const status = data.status || 'active';
            
            switch(status) {
                case 'banned':
                    statusElement.textContent = 'ЗАБАНЕН';
                    statusElement.className = 'font-bold text-lg text-red-400';
                    break;
                case 'pending':
                    statusElement.textContent = 'На проверке';
                    statusElement.className = 'font-bold text-lg text-yellow-400';
                    break;
                case 'rejected':
                    statusElement.textContent = 'Не принят';
                    statusElement.className = 'font-bold text-lg text-orange-400';
                    break;
                case 'active':
                default:
                    statusElement.textContent = 'Активен';
                    statusElement.className = 'font-bold text-lg text-green-400';
                    break;
            }
        }

        function updateSettingsForms(data) {
            // Personal settings
            document.getElementById('settings-firstname').value = data.first_name || '';
            document.getElementById('settings-age').value = data.age || '';
            document.getElementById('settings-bio').value = data.bio || '';
            
            // Update bio character counter
            const bioCounter = document.getElementById('bio-counter');
            if (bioCounter) {
                bioCounter.textContent = `${(data.bio || '').length}/1000`;
            }
            
            // Отображаем никнейм как неизменяемый текст
            const nicknameDisplay = document.getElementById('settings-minecraft-nick-display');
            if (nicknameDisplay) {
                nicknameDisplay.textContent = data.minecraft_nick || data.nickname || 'Не указан';
            }
            
            // Email settings
            document.getElementById('current-email-display').textContent = data.email || 'Не указан';
            
            const emailStatusEl = document.getElementById('email-verification-status');
            const verifyBtn = document.getElementById('verify-email-btn');
            
            if (data.is_email_verified) {
                emailStatusEl.textContent = '✅ Email подтвержден';
                emailStatusEl.className = 'text-sm text-green-400';
                verifyBtn.classList.add('hidden');
            } else {
                emailStatusEl.textContent = '❌ Email не подтвержден';
                emailStatusEl.className = 'text-sm text-red-400';
                verifyBtn.classList.remove('hidden');
            }
            
            // Discord settings
            const discordStatusEl = document.getElementById('discord-status-text');
            const discordBtn = document.getElementById('discord-connect-btn');
            
            if (data.discord) {
                discordStatusEl.textContent = data.discord;
                discordBtn.innerHTML = '<i class="fab fa-discord mr-1"></i>Отвязать';
                discordBtn.className = discordBtn.className.replace('from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700', 'from-red-600 to-red-600 hover:from-red-700 hover:to-red-700');
            } else {
                discordStatusEl.textContent = 'Не привязан';
                discordBtn.innerHTML = '<i class="fab fa-discord mr-1"></i>Привязать';
                discordBtn.className = discordBtn.className.replace('from-red-600 to-red-600 hover:from-red-700 hover:to-red-700', 'from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700');
            }
        }

        function getRoleDisplayName(role) {
            const roles = {
                'user': '👤 Пользователь',
                'moderator': '🛡️ Модератор', 
                'admin': '👑 Администратор'
            };
            return roles[role] || '👤 Пользователь';
        }

        function getTrustLevelPrivileges(level) {
            const privileges = {
                0: '🚶 Проходимец: Лимит 10 часов игры до подтверждения почты',
                1: '👤 Новичок: Неограниченное время игры после подтверждения почты',
                2: '✅ Проверенный: Участие в голосованиях, система репутации',
                3: '🏆 Ветеран: Наставничество новичков, создание ивентов',
                4: '👑 Легенда: Особый статус, максимальные привилегии'
            };
            return privileges[level] || 'Неизвестный уровень';
        }

        function updateServerCharacterCount() {
            const textarea = document.getElementById('server-app-about');
            const counter = document.getElementById('server-char-count');
            if (textarea && counter) {
                counter.textContent = textarea.value.length;
            }
        }

        function updateTrustMotivationCount() {
            const textarea = document.getElementById('trust-app-motivation');
            const counter = document.getElementById('trust-motivation-count');
            if (textarea && counter) {
                counter.textContent = textarea.value.length;
            }
        }

        function updateTrustPlansCount() {
            const textarea = document.getElementById('trust-app-plans');
            const counter = document.getElementById('trust-plans-count');
            if (textarea && counter) {
                counter.textContent = textarea.value.length;
            }
        }

        // Form handlers
        async function handlePersonalSettings(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            await submitSettings(data, 'personal');
        }

        async function handleSecuritySettings(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // Validation
            if (data.new_password) {
                if (!data.current_password) {
                    showMessage('settings-message', 'Для смены пароля необходимо указать текущий пароль', 'error');
                    return;
                }
                
                if (data.new_password !== data.confirm_password) {
                    showMessage('settings-message', 'Новые пароли не совпадают', 'error');
                    return;
                }
                
                if (data.new_password.length < 6) {
                    showMessage('settings-message', 'Пароль должен содержать минимум 6 символов', 'error');
                    return;
                }
            }
            
            delete data.confirm_password;
            
            if (!data.new_password) {
                delete data.new_password;
                delete data.current_password;
            }
            
            await submitSettings(data, 'security');
        }

        async function submitSettings(data, type) {
            const token = localStorage.getItem('auth_token');
            
            try {
                const response = await fetch('/api/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showMessage('settings-message', 'Настройки успешно сохранены!', 'success');
                    
                    if (type === 'security') {
                        // Clear password fields
                        document.getElementById('settings-current-password').value = '';
                        document.getElementById('settings-new-password').value = '';
                        document.getElementById('settings-confirm-password').value = '';
                    }
                    
                    // Reload profile data
                    await loadProfileData();
                } else {
                    const error = await response.json();
                    showMessage('settings-message', error.error || 'Ошибка сохранения настроек', 'error');
                }
            } catch (error) {
                console.error('Ошибка сохранения настроек:', error);
                showMessage('settings-message', 'Ошибка соединения с сервером', 'error');
            }
        }

        async function handleServerApplicationSubmit() {
            const age = document.getElementById('server-app-age').value;
            const source = document.getElementById('server-app-source').value;
            const experience = document.getElementById('server-app-experience').value;
            const about = document.getElementById('server-app-about').value;
            
            // Validation
            if (!age || !source || !experience || !about) {
                showMessage('settings-message', 'Заполните все обязательные поля', 'error');
                return;
            }
            
            if (parseInt(age) < 10) {
                showMessage('settings-message', 'Возраст должен быть от 10 лет', 'error');
                return;
            }
            
            if (about.length < 50) {
                showMessage('settings-message', 'Рассказ о себе должен содержать минимум 50 символов', 'error');
                return;
            }
            
            const token = localStorage.getItem('auth_token');
            
            try {
                const response = await fetch('/api/applications/server-access', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        type: 'server_access',
                        age: parseInt(age),
                        source,
                        experience,
                        about
                    })
                });
                
                if (response.ok) {
                    showMessage('settings-message', 'Заявка на доступ к серверу успешно подана! Ожидайте рассмотрения в течение 24 часов.', 'success');
                    loadServerAccessApplication();
                } else if (response.status === 404) {
                    // API endpoint не существует, симулируем успешную подачу
                    console.log('Server access API endpoint не найден, симулируем успешную подачу');
                    showMessage('settings-message', 'Заявка на доступ к серверу успешно подана! (Демо режим) Ожидайте рассмотрения в течение 24 часов.', 'success');
                    
                    // Обновляем UI как будто заявка подана
                    updateServerAccessUI({
                        hasAccess: false,
                        application: {
                            id: 1,
                            status: 'pending',
                            created_at: new Date().toISOString(),
                            age: parseInt(age),
                            source,
                            experience,
                            about
                        }
                    });
                } else {
                    const error = await response.json();
                    showMessage('settings-message', error.error || 'Ошибка подачи заявки', 'error');
                }
            } catch (error) {
                console.error('Ошибка подачи заявки:', error);
                // В случае ошибки сети тоже симулируем успешную подачу для демо
                showMessage('settings-message', 'Заявка на доступ к серверу успешно подана! (Демо режим) Ожидайте рассмотрения в течение 24 часов.', 'success');
                
                updateServerAccessUI({
                    hasAccess: false,
                    application: {
                        id: 1,
                        status: 'pending',
                        created_at: new Date().toISOString(),
                        age: parseInt(age),
                        source,
                        experience,
                        about
                    }
                });
            }
        }

        async function handleTrustApplicationSubmit() {
            const motivation = document.getElementById('trust-app-motivation').value;
            const plans = document.getElementById('trust-app-plans').value;
            
            // Validation
            if (!motivation || !plans) {
                showMessage('settings-message', 'Заполните все обязательные поля', 'error');
                return;
            }
            
            if (motivation.length < 50) {
                showMessage('settings-message', 'Мотивация должна содержать минимум 50 символов', 'error');
                return;
            }
            
            if (plans.length < 30) {
                showMessage('settings-message', 'Планы должны содержать минимум 30 символов', 'error');
                return;
            }
            
            const token = localStorage.getItem('auth_token');
            
            try {
                const response = await fetch('/api/applications/trust-level', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        type: 'trust_level',
                        motivation,
                        plans
                    })
                });
                
                if (response.ok) {
                    showMessage('settings-message', 'Заявка на повышение уровня доверия успешно подана! Ожидайте рассмотрения в течение 24 часов.', 'success');
                    loadTrustLevelApplication();
                    checkTrustLevelRequirements();
                } else if (response.status === 404) {
                    // API endpoint не существует, симулируем успешную подачу
                    console.log('Trust level application API endpoint не найден, симулируем успешную подачу');
                    showMessage('settings-message', 'Заявка на повышение уровня доверия успешно подана! (Демо режим) Ожидайте рассмотрения в течение 24 часов.', 'success');
                    
                    // Обновляем UI как будто заявка подана
                    updateTrustLevelUI({
                        application: {
                            id: 1,
                            status: 'pending',
                            target_level: 2,
                            created_at: new Date().toISOString(),
                            motivation,
                            plans
                        }
                    });
                } else {
                    const error = await response.json();
                    showMessage('settings-message', error.error || 'Ошибка подачи заявки', 'error');
                }
            } catch (error) {
                console.error('Ошибка подачи заявки:', error);
                // В случае ошибки сети тоже симулируем успешную подачу для демо
                showMessage('settings-message', 'Заявка на повышение уровня доверия успешно подана! (Демо режим) Ожидайте рассмотрения в течение 24 часов.', 'success');
                
                updateTrustLevelUI({
                    application: {
                        id: 1,
                        status: 'pending',
                        target_level: 2,
                        created_at: new Date().toISOString(),
                        motivation,
                        plans
                    }
                });
            }
        }

        async function handleDiscordConnect() {
            const btn = document.getElementById('discord-connect-btn');
            
            if (btn.textContent.includes('Привязать')) {
                window.location.href = '/api/auth/discord';
            } else {
                if (confirm('Вы уверены, что хотите отвязать Discord аккаунт?')) {
                    try {
                        const token = localStorage.getItem('auth_token');
                        const response = await fetch('/api/auth/unlink-discord', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            showMessage('settings-message', 'Discord аккаунт успешно отвязан', 'success');
                            await loadProfileData(); // Перезагружаем профиль
                        } else {
                            const error = await response.json();
                            showMessage('settings-message', error.error || 'Ошибка отвязки Discord', 'error');
                        }
                    } catch (error) {
                        console.error('Ошибка отвязки Discord:', error);
                        showMessage('settings-message', 'Ошибка соединения с сервером', 'error');
                    }
                }
            }
        }

        // Avatar functions
        let selectedAvatarFile = null;

        function handleAvatarSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Проверяем размер файла (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                showMessage('settings-message', 'Размер файла не должен превышать 5MB', 'error');
                return;
            }

            // Проверяем тип файла
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                showMessage('settings-message', 'Разрешены только изображения (JPEG, PNG, GIF, WebP)', 'error');
                return;
            }

            selectedAvatarFile = file;

            // Показываем превью
            const reader = new FileReader();
            reader.onload = (e) => {
                const avatarElement = document.getElementById('current-avatar');
                avatarElement.src = e.target.result;
            };
            reader.readAsDataURL(file);

            showMessage('settings-message', 'Файл выбран. Нажмите "Загрузить" для сохранения.', 'info');
        }

        async function handleAvatarUpload() {
            if (!selectedAvatarFile) {
                showMessage('settings-message', 'Сначала выберите файл', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('avatar', selectedAvatarFile);

            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch('/api/profile/avatar', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    showMessage('settings-message', 'Аватар успешно загружен!', 'success');
                    selectedAvatarFile = null;
                    await loadProfileData(); // Перезагружаем профиль
                } else {
                    const error = await response.json();
                    showMessage('settings-message', error.error || 'Ошибка загрузки аватара', 'error');
                }
            } catch (error) {
                console.error('Ошибка загрузки аватара:', error);
                showMessage('settings-message', 'Ошибка соединения с сервером', 'error');
            }
        }

        async function handleAvatarRemove() {
            if (!confirm('Вы уверены, что хотите удалить аватар?')) {
                return;
            }

            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch('/api/profile/avatar', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showMessage('settings-message', 'Аватар успешно удален!', 'success');
                    await loadProfileData(); // Перезагружаем профиль
                } else {
                    const error = await response.json();
                    showMessage('settings-message', error.error || 'Ошибка удаления аватара', 'error');
                }
            } catch (error) {
                console.error('Ошибка удаления аватара:', error);
                showMessage('settings-message', 'Ошибка соединения с сервером', 'error');
            }
        }

        async function handleEmailVerification() {
            const token = localStorage.getItem('auth_token');
            const btn = document.getElementById('verify-email-btn');
            
            btn.disabled = true;
            btn.textContent = 'Отправка...';
            
            try {
                const response = await fetch('/api/auth/send-verification', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    showMessage('settings-message', 'Письмо с подтверждением отправлено на ваш email', 'success');
                } else {
                    const error = await response.json();
                    showMessage('settings-message', error.error || 'Ошибка отправки письма', 'error');
                }
            } catch (error) {
                showMessage('settings-message', 'Ошибка соединения', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-envelope-open mr-1"></i>Подтвердить';
            }
        }

        async function handleEmailChange() {
            const newEmail = prompt('Введите новый адрес электронной почты:');
            if (newEmail && newEmail.includes('@')) {
                showMessage('settings-message', 'Функция смены почты будет добавлена в следующем обновлении', 'info');
            } else if (newEmail) {
                showMessage('settings-message', 'Введите корректный email адрес', 'error');
            }
        }

        async function handleLogout() {
            const token = localStorage.getItem('auth_token');
            
            if (token) {
                try {
                    await fetch('/api/auth/logout', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                } catch (error) {
                    console.error('Ошибка выхода:', error);
                }
            }
            
            localStorage.removeItem('auth_token');
            localStorage.removeItem('remember_me');
            localStorage.removeItem('token_expires');
            currentUser = null;
            window.location.href = '/login';
        }

        async function loadApplicationsData() {
            await Promise.all([
                loadServerAccessApplication(),
                loadTrustLevelApplication(),
                checkTrustLevelRequirements(),
                checkServerAccessRequirements()
            ]);
        }

        async function loadServerAccessApplication() {
            const token = localStorage.getItem('auth_token');
            
            try {
                const response = await fetch('/api/applications/server-access', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                let data;
                if (response.ok) {
                    data = await response.json();
                    console.log('Server access data:', data);
                } else if (response.status === 404) {
                    // API endpoint не существует, используем заглушку для нового пользователя
                    console.log('API endpoint не найден, показываем форму для новых пользователей');
                    data = { hasAccess: false, application: null };
                } else {
                    console.error('Ошибка загрузки заявки на доступ к серверу');
                    data = { hasAccess: false, application: null };
                }
                
                updateServerAccessUI(data);
            } catch (error) {
                console.error('Ошибка загрузки заявки на доступ к серверу:', error);
                // Используем заглушку в случае ошибки сети - покажем форму для новых пользователей
                updateServerAccessUI({ hasAccess: false, application: null });
            }
        }

        async function loadTrustLevelApplication() {
            const token = localStorage.getItem('auth_token');
            
            try {
                const response = await fetch('/api/applications/trust-level', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                let data;
                if (response.ok) {
                    data = await response.json();
                } else if (response.status === 404) {
                    // API endpoint не существует, используем заглушку
                    console.log('Trust level API endpoint не найден, используем заглушку');
                    data = { application: null };
                } else {
                    console.error('Ошибка загрузки заявки на повышение уровня доверия');
                    data = { application: null };
                }
                
                updateTrustLevelUI(data);
            } catch (error) {
                console.error('Ошибка загрузки заявки на повышение уровня доверия:', error);
                updateTrustLevelUI({ application: null });
            }
        }

        function updateServerAccessUI(data) {
            const statusIcon = document.getElementById('server-access-icon');
            const statusText = document.getElementById('server-access-text');
            const statusDesc = document.getElementById('server-access-desc');
            const statusDiv = document.getElementById('server-access-status');
            const appForm = document.getElementById('server-access-form');
            const dateLabel = document.getElementById('server-access-date-label');
            const dateEl = document.getElementById('server-access-date');
            
            // Проверяем, имеет ли пользователь доступ на основе API ответа
            if (data.hasAccess === true) {
                // У пользователя есть доступ к серверу (одобренная заявка)
                statusIcon.className = 'fas fa-check-circle text-green-400 text-xl mr-3';
                statusText.textContent = 'Доступ к серверу получен';
                statusDesc.textContent = 'Вы можете играть на сервере Minecraft';
                statusDiv.className = 'mb-6 p-4 rounded-lg border border-green-400 bg-green-400/10';
                appForm.classList.add('hidden');
                
                if (data.application) {
                    dateLabel.style.display = 'block';
                    dateEl.style.display = 'block';
                    dateEl.textContent = new Date(data.application.reviewed_at || data.application.submitted_at).toLocaleDateString('ru-RU');
                } else {
                    dateLabel.style.display = 'none';
                    dateEl.style.display = 'none';
                }
            } else if (data.application && data.application.status !== 'approved') {
                // Есть активная заявка (не одобренная)
                const app = data.application;
                appForm.classList.add('hidden');
                dateLabel.style.display = 'block';
                dateEl.style.display = 'block';
                dateEl.textContent = new Date(app.created_at).toLocaleDateString('ru-RU');
                
                switch(app.status) {
                    case 'pending':
                        statusIcon.className = 'fas fa-clock text-yellow-400 text-xl mr-3';
                        statusText.textContent = 'Заявка на рассмотрении';
                        statusDesc.textContent = 'Ожидайте решения администрации';
                        statusDiv.className = 'mb-6 p-4 rounded-lg border border-yellow-400 bg-yellow-400/10';
                        break;
                    case 'rejected':
                        statusIcon.className = 'fas fa-times-circle text-red-400 text-xl mr-3';
                        statusText.textContent = 'Заявка отклонена';
                        statusDesc.textContent = app.rejection_reason || 'Можно подать заявку повторно через 7 дней';
                        statusDiv.className = 'mb-6 p-4 rounded-lg border border-red-400 bg-red-400/10';
                        
                        // Проверяем, можно ли подать заявку повторно
                        const rejectedDate = new Date(app.updated_at || app.created_at);
                        const daysSinceRejection = Math.floor((Date.now() - rejectedDate.getTime()) / (1000 * 60 * 60 * 24));
                        if (daysSinceRejection >= 7) {
                            appForm.classList.remove('hidden');
                        }
                        break;
                    default:
                        // Неизвестный статус, показываем форму
                        statusIcon.className = 'fas fa-file-alt text-minecraft-gold text-xl mr-3';
                        statusText.textContent = 'Заявка не подана';
                        statusDesc.textContent = 'Заполните форму ниже для получения доступа к серверу';
                        statusDiv.className = 'mb-6 p-4 rounded-lg border border-minecraft-light-gray bg-minecraft-dark/30';
                        appForm.classList.remove('hidden');
                        dateLabel.style.display = 'none';
                        dateEl.style.display = 'none';
                }
            } else {
                // Заявка не подана, показываем форму
                statusIcon.className = 'fas fa-file-alt text-minecraft-gold text-xl mr-3';
                statusText.textContent = 'Заявка не подана';
                statusDesc.textContent = 'Заполните форму ниже для получения доступа к серверу';
                statusDiv.className = 'mb-6 p-4 rounded-lg border border-minecraft-light-gray bg-minecraft-dark/30';
                appForm.classList.remove('hidden');
                dateLabel.style.display = 'none';
                dateEl.style.display = 'none';
            }
        }

        function updateTrustLevelUI(data) {
            const statusDiv = document.getElementById('trust-application-status');
            const form = document.getElementById('trust-level-form');
            const unavailable = document.getElementById('trust-unavailable');
            
            if (data.application) {
                // Есть активная заявка на повышение
                const app = data.application;
                statusDiv.classList.remove('hidden');
                form.classList.add('hidden');
                unavailable.classList.add('hidden');
                
                const statusIcon = document.getElementById('trust-app-icon');
                const statusText = document.getElementById('trust-app-text');
                const statusDesc = document.getElementById('trust-app-desc');
                const statusDate = document.getElementById('trust-app-date');
                
                statusDate.textContent = new Date(app.created_at).toLocaleDateString('ru-RU');
                
                switch(app.status) {
                    case 'pending':
                        statusIcon.className = 'fas fa-clock text-yellow-400 text-xl mr-3';
                        statusText.textContent = `Заявка на повышение до уровня ${app.target_level}`;
                        statusDesc.textContent = 'Ожидайте решения администрации';
                        statusDiv.className = 'mb-6 p-4 rounded-lg border border-yellow-400 bg-yellow-400/10';
                        break;
                    case 'approved':
                        statusIcon.className = 'fas fa-check-circle text-green-400 text-xl mr-3';
                        statusText.textContent = `Повышение до уровня ${app.target_level} одобрено`;
                        statusDesc.textContent = 'Поздравляем с повышением!';
                        statusDiv.className = 'mb-6 p-4 rounded-lg border border-green-400 bg-green-400/10';
                        break;
                    case 'rejected':
                        statusIcon.className = 'fas fa-times-circle text-red-400 text-xl mr-3';
                        statusText.textContent = `Заявка на уровень ${app.target_level} отклонена`;
                        statusDesc.textContent = app.rejection_reason || 'Можно подать заявку повторно через 7 дней';
                        statusDiv.className = 'mb-6 p-4 rounded-lg border border-red-400 bg-red-400/10';
                        break;
                }
            } else {
                statusDiv.classList.add('hidden');
            }
        }

        async function checkTrustLevelRequirements() {
            if (!currentUser) return;
            
            const requirementsList = document.getElementById('requirements-list');
            const form = document.getElementById('trust-level-form');
            const unavailable = document.getElementById('trust-unavailable');
            const unavailableReason = document.getElementById('trust-unavailable-reason');
            const targetLevelSpan = document.getElementById('trust-level-target');
            
            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch('/api/trust-level/requirements', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                let data;
                if (response.ok) {
                    data = await response.json();
                } else if (response.status === 404) {
                    // API endpoint не существует, используем заглушку
                    console.log('Trust level requirements API endpoint не найден, используем заглушку');
                    data = {
                        canApply: false,
                        nextLevel: 2,
                        reason: 'Недостаточно времени игры на сервере',
                        requirements: [
                            { description: 'Время игры: 10+ часов', met: false, progress: '5/10 часов' },
                            { description: 'Отсутствие нарушений', met: true },
                            { description: 'Активность в чате', met: false, progress: 'Низкая активность' }
                        ]
                    };
                } else {
                    data = {
                        canApply: false,
                        reason: 'Ошибка загрузки требований',
                        requirements: []
                    };
                }
                
                updateRequirementsUI(data, requirementsList, form, unavailable, unavailableReason, targetLevelSpan);
            } catch (error) {
                console.error('Ошибка проверки требований:', error);
                requirementsList.innerHTML = `
                    <div class="text-center text-red-400 py-4">
                        <i class="fas fa-wifi text-xl mb-2"></i>
                        <p>Ошибка соединения</p>
                    </div>
                `;
            }
        }

        function checkServerAccessRequirements() {
            if (!currentUser) return;
            
            const ageInput = document.getElementById('server-app-age');
            const aboutTextarea = document.getElementById('server-app-about');
            const submitBtn = document.getElementById('submit-server-application');
            
            // Обработчики для динамической проверки
            if (ageInput) {
                ageInput.addEventListener('input', () => {
                    const age = parseInt(ageInput.value) || 0;
                    updateRequirementIcon('req-age-icon', age >= 10);
                    updateSubmitButton();
                });
            }
            
            if (aboutTextarea) {
                aboutTextarea.addEventListener('input', () => {
                    const aboutLength = aboutTextarea.value.length;
                    updateRequirementIcon('req-about-icon', aboutLength >= 50);
                    updateSubmitButton();
                });
            }
            
            function updateSubmitButton() {
                if (!submitBtn) return;
                
                const age = parseInt(ageInput?.value || 0);
                const aboutLength = aboutTextarea?.value.length || 0;
                
                const allRequirementsMet = age >= 10 && aboutLength >= 50;
                
                submitBtn.disabled = !allRequirementsMet;
                if (allRequirementsMet) {
                    submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    submitBtn.classList.add('hover:scale-105');
                } else {
                    submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    submitBtn.classList.remove('hover:scale-105');
                }
            }
            
            // Первоначальная проверка кнопки
            updateSubmitButton();
        }

        function updateRequirementIcon(iconId, isValid) {
            const icon = document.getElementById(iconId);
            if (!icon) return;
            
            if (isValid) {
                icon.className = 'fas fa-check-circle text-green-400 mr-2';
            } else {
                icon.className = 'fas fa-times-circle text-red-400 mr-2';
            }
        }

        function updateRequirementsUI(data, requirementsList, form, unavailable, unavailableReason, targetLevelSpan) {
            if (data.canApply) {
                // Пользователь может подать заявку
                form.classList.remove('hidden');
                unavailable.classList.add('hidden');
                
                const trustLevelNames = {
                    1: 'Новичок',
                    2: 'Проверенный',
                    3: 'Ветеран',
                    4: 'Легенда'
                };
                
                const targetLevelName = trustLevelNames[data.nextLevel] || `Уровень ${data.nextLevel}`;
                targetLevelSpan.textContent = `Доступное повышение: Уровень ${data.nextLevel} - ${targetLevelName}`;
            } else {
                form.classList.add('hidden');
                unavailable.classList.remove('hidden');
                unavailableReason.textContent = data.reason || 'Требования не выполнены';
            }
            
            // Показываем требования
            requirementsList.innerHTML = data.requirements.map(req => `
                <div class="flex items-center justify-between py-2">
                    <div class="flex items-center">
                        <i class="fas ${req.met ? 'fa-check-circle text-green-400' : 'fa-times-circle text-red-400'} mr-3"></i>
                        <span class="text-gray-300">${req.description}</span>
                    </div>
                    <div class="text-sm ${req.met ? 'text-green-400' : 'text-red-400'}">
                        ${req.progress || (req.met ? 'Выполнено' : 'Не выполнено')}
                    </div>
                </div>
            `).join('');
        }

        async function loadStatistics() {
            const token = localStorage.getItem('auth_token');
            
            try {
                // Загружаем детальную статистику
                const response = await fetch('/api/profile/detailed-stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    updateDetailedStatistics(data);
                } else {
                    console.error('Ошибка загрузки статистики:', response.status);
                }
            } catch (error) {
                console.error('Ошибка загрузки статистики:', error);
            }
            
            await loadAchievements();
        }

        function updateDetailedStatistics(data) {
            const stats = data.stats;
            
            // Обновляем основную статистику
            document.getElementById('stat-total-playtime').textContent = stats.total_playtime_formatted || '0ч 0м';
            document.getElementById('stat-total-logins').textContent = stats.total_logins || 0;
            document.getElementById('stat-achievements').textContent = stats.achievements_count || 0;
            
            // Последний вход
            const lastSeenEl = document.getElementById('stat-last-seen');
            if (stats.last_seen) {
                const lastSeen = new Date(stats.last_seen);
                const now = new Date();
                const diffTime = Math.abs(now - lastSeen);
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) {
                    lastSeenEl.textContent = 'Сегодня';
                } else if (diffDays === 1) {
                    lastSeenEl.textContent = 'Вчера';
                } else {
                    lastSeenEl.textContent = `${diffDays} дн. назад`;
                }
            } else {
                lastSeenEl.textContent = 'Никогда';
            }
            
            // Детальная игровая статистика
            document.getElementById('stat-avg-session').textContent = stats.average_session_formatted || '-';
            document.getElementById('stat-longest-session').textContent = stats.longest_session_formatted || '-';
            document.getElementById('stat-active-days').textContent = stats.active_days || 0;
            
            // Любимое время игры
            const favoriteHour = stats.favorite_play_hour || 12;
            document.getElementById('stat-favorite-time').textContent = `${favoriteHour}:00`;
            
            // Обновляем дополнительную статистику, если есть соответствующие элементы
            updateGameplayStats(stats);
            
            // Обновляем график активности
            if (data.activity_chart) {
                updateActivityChart(data.activity_chart);
            }
        }

        function updateGameplayStats(stats) {
            // Создаем дополнительную статистику если элементы существуют
            const gameplayStats = [
                { id: 'blocks-broken', value: stats.blocks_broken || 0, label: 'Блоков сломано' },
                { id: 'blocks-placed', value: stats.blocks_placed || 0, label: 'Блоков поставлено' },
                { id: 'distance-walked', value: formatDistance(stats.distance_walked || 0), label: 'Пройдено' },
                { id: 'mobs-killed', value: stats.mobs_killed || 0, label: 'Мобов убито' },
                { id: 'deaths-count', value: stats.deaths_count || 0, label: 'Смертей' },
                { id: 'damage-dealt', value: stats.damage_dealt || 0, label: 'Урона нанесено' }
            ];
            
            // Добавляем детальную игровую статистику к существующей
            const gameplayContainer = document.querySelector('#tab-stats .space-y-4');
            if (gameplayContainer && !document.getElementById('gameplay-stats-section')) {
                const gameplaySection = document.createElement('div');
                gameplaySection.id = 'gameplay-stats-section';
                gameplaySection.innerHTML = `
                    <div class="glass-effect rounded-xl p-6">
                        <h4 class="text-lg font-bold text-minecraft-gold mb-4 flex items-center">
                            <i class="fas fa-cubes mr-3"></i>Игровая статистика
                        </h4>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            ${gameplayStats.map(stat => `
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-white">${stat.value}</div>
                                    <div class="text-sm text-gray-400">${stat.label}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                gameplayContainer.parentNode.insertBefore(gameplaySection, gameplayContainer.nextSibling);
            }
        }

        function formatDistance(blocks) {
            if (blocks < 1000) return blocks + ' бл.';
            if (blocks < 1000000) return Math.round(blocks / 1000) + ' км';
            return Math.round(blocks / 1000000) + ' Мкм';
        }

        function updateActivityChart(activityData) {
            const chartContainer = document.getElementById('activity-chart');
            if (!chartContainer || !activityData.length) {
                chartContainer.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-chart-bar text-4xl mb-4 text-gray-500"></i>
                        <p class="text-gray-400">Недостаточно данных для графика</p>
                    </div>
                `;
                return;
            }
            
            // Простой график активности
            const maxPlaytime = Math.max(...activityData.map(d => d.playtime_minutes || 0));
            const chartHTML = `
                <div class="relative h-full">
                    <div class="flex items-end justify-between h-48 px-2">
                        ${activityData.slice(-14).map(day => {
                            const height = maxPlaytime > 0 ? (day.playtime_minutes || 0) / maxPlaytime * 100 : 0;
                            const date = new Date(day.stat_date);
                            return `
                                <div class="flex flex-col items-center group cursor-pointer">
                                    <div class="bg-minecraft-gold rounded-t transition-all group-hover:bg-minecraft-yellow" 
                                         style="height: ${height}%; width: 20px; min-height: 2px;"></div>
                                    <div class="text-xs text-gray-400 mt-2 transform rotate-45 origin-bottom-left">
                                        ${date.getDate()}/${date.getMonth() + 1}
                                    </div>
                                    <div class="absolute bottom-full mb-2 hidden group-hover:block bg-minecraft-dark p-2 rounded shadow-lg text-sm whitespace-nowrap">
                                        ${Math.floor((day.playtime_minutes || 0) / 60)}ч ${(day.playtime_minutes || 0) % 60}м
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="text-center text-gray-400 text-sm mt-4">
                        Последние 14 дней (время игры в часах)
                    </div>
                </div>
            `;
            
            chartContainer.innerHTML = chartHTML;
        }

        async function loadAchievements() {
            const achievementsContainer = document.getElementById('achievements-list');
            
            try {
                // Пока система достижений не реализована, показываем заглушку
                achievementsContainer.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <i class="fas fa-trophy text-2xl mb-2"></i>
                        <p>Система достижений в разработке</p>
                        <p class="text-sm mt-1">Играйте на сервере, система достижений будет добавлена в будущих обновлениях!</p>
                    </div>
                `;
            } catch (error) {
                console.error('Ошибка загрузки достижений:', error);
                achievementsContainer.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <i class="fas fa-trophy text-2xl mb-2"></i>
                        <p>Система достижений в разработке</p>
                    </div>
                `;
            }
        }

        function showMessage(elementId, text, type) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            let className = 'mb-6 p-4 rounded-lg border';
            switch(type) {
                case 'success':
                    className += ' bg-green-900/50 text-green-300 border-green-700';
                    break;
                case 'error':
                    className += ' bg-red-900/50 text-red-300 border-red-700';
                    break;
                case 'info':
                    className += ' bg-blue-900/50 text-blue-300 border-blue-700';
                    break;
                default:
                    className += ' bg-minecraft-dark text-gray-300 border-minecraft-light-gray';
            }
            
            element.textContent = text;
            element.className = className;
            element.classList.remove('hidden');
            
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }

        // Добавляем обработчики событий для токенов
        document.addEventListener('DOMContentLoaded', function() {
            const generateBtn = document.getElementById('generate-token-btn');
            const refreshBtn = document.getElementById('refresh-tokens-btn');
            const terminateBtn = document.getElementById('terminate-sessions-btn');
            
            if (generateBtn) {
                generateBtn.addEventListener('click', generateGameToken);
            }
            
            if (refreshBtn) {
                refreshBtn.addEventListener('click', loadTokenHistory);
            }

            if (terminateBtn) {
                terminateBtn.addEventListener('click', terminateAllSessions);
            }
        });

        async function handleDiscordLinkComplete(username) {
            try {
                const token = localStorage.getItem('auth_token');
                const response = await fetch('/api/auth/link-discord', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showMessage('settings-message', `Discord аккаунт ${username} успешно привязан!`, 'success');
                    await loadProfileData(); // Перезагружаем профиль
                    
                    // Очищаем URL от параметров
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else {
                    const error = await response.json();
                    showMessage('settings-message', error.error || 'Ошибка привязки Discord', 'error');
                }
            } catch (error) {
                console.error('Ошибка привязки Discord:', error);
                showMessage('settings-message', 'Ошибка соединения с сервером', 'error');
            }
        }
    </script>
</body>
</html>
